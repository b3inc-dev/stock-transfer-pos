# stock-transfer-pos 機能実装一覧

## 📋 概要

Shopify POS UI Extensionとして実装された在庫移管（出庫・入庫）アプリケーションです。

## 🎯 主要機能

### 1. 出庫（移管）機能 ✅ 実装済み

#### 1.1 基本機能
- **出庫元ロケーション**: 現在のPOS店舗を自動取得
- **宛先ロケーション選択**: 
  - 店舗グループ設定に基づいて自動フィルタリング
  - グループ未所属の場合は全ロケーション表示
- **商品追加方法**:
  - バーコードスキャン（JANコード対応）
  - 商品検索（SKU、商品名、バーコード）
  - 連続スキャン対応（キューで順次処理）

#### 1.2 バーコードスキャン機能
- **入力方式**: 改行不要、入力停止で即確定
- **連続スキャン**: キューで順番に処理（高速スキャン対応）
- **同一商品の重複防止**: 既存行に数量を加算
- **見つからない場合**: OK必須のブロッキングモーダル表示

#### 1.3 在庫追跡有効化
- **自動有効化**: 出庫元ロケーションで在庫追跡を自動有効化
- **エラーハンドリング**: 有効化失敗時は詳細エラー表示
- **再試行機能**: 宛先ロケーションの在庫レベル反映待機機能

#### 1.4 Transfer作成
- **ステータス**: Ready to Ship 状態で作成
- **フォールバック**: `inventoryTransferCreateAsReadyToShip` が使えない場合は Draft → Ready の2段階で作成
- **明細**: InventoryTransferLineItemInput 形式で送信

#### 1.5 Shipment作成（追跡情報）
- **条件**: 配送会社、追跡番号、追跡URL、到着予定日のいずれかが入力されている場合のみ作成
- **追跡情報**:
  - 配送会社（company）: 設定画面で登録した会社から選択
  - 追跡番号（trackingNumber）
  - 追跡URL（trackingUrl）
  - 到着予定日時（arrivesAt）: ISO形式、日付・時刻選択UI付き

#### 1.6 履歴表示
- **一覧表示**: 出庫元ロケーションの全Transfer履歴を表示
- **フィルタリング**: ステータス、日付範囲で絞り込み可能
- **詳細表示**: 
  - Transfer情報（ID、名前、ステータス、日付）
  - 出庫元・宛先ロケーション
  - 明細一覧（商品名、SKU、数量）
  - Shipment情報（追跡情報含む）
- **読み取り専用**: TRANSFERRED（入庫済み）状態の場合は編集不可

#### 1.7 軽量モード
- **画像取得**: liteMode ON のときは GraphQLで画像フィールドを取得しない
- **パフォーマンス**: 大量商品登録時の処理速度向上

---

### 2. 入庫（受領）機能 ✅ 実装済み

#### 2.1 基本機能
- **入庫先ロケーション**: 現在のPOS店舗を自動取得
- **Shipment選択方法**:
  - **方法1**: Shipment IDを手入力 → 読み込み → 受領確定
  - **方法2**: 入庫予定一覧から選択（`inventoryTransfers` クエリを使用）

#### 2.2 入庫予定一覧
- **データソース**: `inventoryTransfers(query:)` で宛先ロケーションのTransferを取得
- **表示モード**: 
  - 未入庫タブ: 未完了のTransfer
  - 入庫済みタブ: 完了済みのTransfer
- **ページネーション**: 追加読み込み機能あり
- **監査ログ統合**: 予定超過・予定外入庫・拒否分を表示に反映

#### 2.3 バーコードスキャン機能
- **商品照合**: スキャンしたバーコードで明細を検索
- **数量入力**: スキャン後に数量を入力（デフォルトは予定数量）
- **予定超過対応**: 予定数量を超える入庫を許可
- **予定外入庫対応**: Transferに含まれていない商品の入庫を許可

#### 2.4 受領処理
- **API**: `inventoryShipmentReceive` または `inventoryShipmentReceiveItems`（フォールバック）
- **理由（reason）**: ACCEPTED / REJECTED を指定可能
- **部分受領**: 一部のみ受領可能
- **在庫調整**: 予定外入庫時に自動で在庫調整を実行

#### 2.5 メモ機能
- **保存先**: InventoryTransfer.note フィールド
- **記録内容**:
  - 処理日時
  - 状態（完了 / 一部受領）
  - メモ（手入力）
  - 予定超過の詳細（商品名、SKU、数量）
  - 予定外入庫の詳細（商品名、オプション、SKU、JAN、数量）
  - 在庫調整履歴（ロケーション、商品、数量変化）
- **編集制限**: TRANSFERRED 状態の場合は編集不可

#### 2.6 監査ログ機能
- **記録内容**: 予定超過、予定外入庫、拒否分をローカルストレージに記録
- **表示統合**: 一覧表示時に監査ログの情報を反映
- **データ構造**: ロケーションID、Shipment ID、商品情報、数量を記録

---

### 3. 設定機能 ✅ 実装済み

#### 3.1 店舗グループ設定
- **目的**: 宛先ロケーションの絞り込み
- **動作**:
  - POS側ではグループ選択UIは表示しない
  - 現在の店舗（origin）が所属するグループを自動判定
  - そのグループ内のロケーションだけを宛先候補に表示
  - originがどのグループにも所属していない場合は全ロケーション表示（制限なし）
- **注意**: origin店舗も必ずグループに含める必要がある

#### 3.2 配送会社設定
- **目的**: POS側での表記ゆれ防止
- **設定項目**:
  - 表示名（POSに表示される名前、例：ヤマト運輸）
  - company（APIに渡す値、例：Yamato (JA)）
- **プリセット**: グローバル・日本向けの主要配送会社をプリセットとして提供
- **手動追加**: 任意の配送会社を追加可能

---

### 4. その他の機能

#### 4.1 ロス登録機能 ⚠️ 準備中
- **ステータス**: プレースホルダー実装のみ
- **将来実装予定**: 在庫ロスの登録機能

#### 4.2 棚卸機能 ⚠️ 準備中
- **ステータス**: プレースホルダー実装のみ
- **将来実装予定**: 棚卸（在庫数確認）機能

#### 4.3 UI設定
- **軽量モード**: 画像取得をOFFにしてパフォーマンス向上
- **設定保存**: ローカルストレージに保存

---

## 🔧 技術実装詳細

### GraphQL Mutation / Query

#### 出庫関連
- `inventoryTransferCreateAsReadyToShip`: TransferをReady to Ship状態で作成
- `inventoryTransferCreate`: TransferをDraft状態で作成
- `inventoryTransferMarkAsReadyToShip`: Draft状態のTransferをReady to Shipに変更
- `inventoryShipmentCreateInTransit`: Shipmentを作成（追跡情報付き）

#### 入庫関連
- `inventoryShipmentReceive`: Shipmentを受領（現行スキーマ）
- `inventoryShipmentReceiveItems`: Shipmentを受領（旧スキーマ、フォールバック）
- `inventoryTransferEdit`: Transferのメモを編集

#### クエリ
- `inventoryTransfers`: Transfer一覧取得（フィルタリング対応）
- `inventoryTransfer`: 単一Transfer取得
- `locations`: ロケーション一覧取得

### 在庫追跡有効化
- `ensureInventoryActivatedAtLocation`: カスタム関数（実装詳細はコード参照）
- 出庫元・宛先ロケーションで在庫追跡を有効化
- エラー時は詳細メッセージを表示

### データ永続化
- **設定**: Shopify App Installation Metafield（`stock_transfer_pos.settings_v1`）
- **UI設定**: ローカルストレージ（`ui_prefs_v1`）
- **アプリ状態**: ローカルストレージ（`app_state_v1`）
- **スキャンキュー**: ローカルストレージ（`scan_queue_v1`）
- **監査ログ**: ローカルストレージ（`inbound_audit_log_v1`）

### エラーハンドリング
- **統一ダイアログ**: alert / confirm / input を統一APIで提供
- **userErrors**: GraphQLのuserErrorsを読みやすい形式に変換
- **エラー表示**: ブロッキングモーダルで確実にユーザーに通知

---

## 📁 ファイル構成

```
stock-transfer-pos/
├── extensions/
│   └── stock-transfer-tile/
│       ├── src/
│       │   ├── Tile.jsx          # POSホーム画面のタイル
│       │   └── Modal.jsx          # メイン機能実装（約12,000行）
│       └── shopify.extension.toml # 拡張機能設定
├── app/
│   └── routes/
│       └── app.settings.tsx       # 設定画面（店舗グループ・配送会社）
└── package.json
```

---

## 🎨 UI/UX

### POS UI Extension コンポーネント
- `s-tile`: ホーム画面のタイル
- `s-modal`: モーダル画面
- `s-page`: ページコンテナ
- `s-button`: ボタン
- `s-text-field`: テキスト入力
- `s-stack`: レイアウト
- `s-box`: コンテナ
- `s-text`: テキスト表示

### デザイン原則
- Shopify Polaris デザインガイドラインに準拠
- POS UI Extension の制約を遵守
- タッチ操作に最適化

---

## 📝 注意事項

1. **在庫追跡**: 出庫・入庫処理前に在庫追跡を有効化する必要がある
2. **グループ設定**: origin店舗を必ずグループに含めること
3. **APIバージョン**: `2025-10` を使用
4. **軽量モード**: 大量商品を扱う場合は有効化を推奨
5. **監査ログ**: 予定超過・予定外入庫はローカルストレージに記録される（永続化は別途検討が必要）

---

## 🔄 今後の拡張予定

- [ ] ロス登録機能の実装
- [ ] 棚卸機能の実装
- [ ] 監査ログのサーバー側永続化
- [ ] バッチ処理機能
- [ ] レポート機能
