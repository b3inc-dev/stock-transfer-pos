# 管理画面・ロス登録・棚卸 実装要件書

**最終更新日**: 2026年2月11日（**在庫高日次Cron：オフライントークン自動リフレッシュ**まで反映済み）  
**コード確認日**: 2026年2月（上記に加え、4分割・出庫マルチシップメント・履歴一覧UI・仮想行・配送情報・入庫 REFERENCE 整合・入出庫/棚卸モーダルUI統一・POS棚卸読み込み最適化・ロケーションインライン化・履歴モーダル配送情報・本番前console整理・POS表記統一・発注機能実装・仕入POS拡張・在庫高・在庫変動履歴・api/log-inventory-change 種別上書き・ロケーション名取得・公開/自社用 appUrl・リリース時必須対策・希望納品日/到着予定日ボタン設定・入出庫/仕入/ロス/棚卸CSV出力項目設定・在庫高Cronトークンリフレッシュ 反映済み）

---

## 📌 要件の再まとめ（2026-02）

| 項目 | 状態 |
|------|------|
| 棚卸ID発行UI | ✅ 完了（レイアウト・説明は現状でOK） |
| 履歴モーダルのデバッグ情報削除 | ✅ 完了 |
| 履歴のページネーション | ✅ 完了（表示件数・前へ・次へで統一） |
| CSV1行目・コレクション/SKU検索 | ✅ 現時点で不具合なし |
| 一覧でのCSVまとめてダウンロード | ⏭️ 実装なしで進行 |
| 未完了グループの商品リスト読込 / POS棚卸読み込み速度 | ✅ 完了（入庫並みに最適化済み） |
| 棚卸ページ上部メニュー下の余白 | ✅ 微調整済み（狭くした） |
| 設定の「破棄」「保存」ボタン | ✅ 微調整済み（右寄せ・余白で浮き感軽減） |
| 入出庫履歴モーダルを棚卸UIに寄せた表示 | ✅ 完了（配送単位ブロック・進捗状況・予定外別ブロック） |
| 棚卸モーダル進捗状況の表示位置 | ✅ 情報欄最下部に変更（入出庫と同様） |
| 棚卸単一グループ時のブロック背景 | ✅ 完了（複数と同じ背景色・角丸で統一） |
| 棚卸の予定外を別ブロック表示 | ✅ 完了（入出庫の「予定外入庫」ブロックと同様） |
| 管理画面のステータスをバッジ表示 | ✅ 完了（入出庫・ロス・棚卸の一覧・モーダル） |
| 出庫ロケーション選択のインライン展開 | ✅ 完了（モーダル→ボタン押下で同一画面内展開、変更/閉じるトグル） |
| 出庫到着時刻ラベル「時間指定」化 | ✅ 完了 |
| 履歴モーダルに配送情報（配送業者・配送番号・予定日）追加 | ✅ 完了（入庫先とステータスの間に表示） |
| 本番前の `console.log` 整理 | ✅ 完了（app/ のルート・API・Webhook および 全POS拡張のデバッグ用を削除。api.log-inventory-change の Token payload / Called / Updated ログ削除を含む。loader/action の catch 内 console.error は本番追跡のため残置） |
| 公開アプリ向け・リスティング準備 | ✅ ガイド整備済み（RELEASE_REQUIREMENTS_PUBLIC_APP.md、docs/LISTING_ASSETS_GUIDE.md） |
| POS表記・UI微調整（画像ON/OFF統一・明細/SKU件数・フッター配置等） | ✅ 完了（本文「直近の主な更新」に記載） |
| 発注機能：発注先編集・原価・販売価格取得・CSV出力拡張 | ✅ 完了（商品リストモーダル内で発注先編集、原価・販売価格の自動取得・保存、CSV出力項目拡張） |
| 仕入・発注：処理確定文言・CSV名・名称引き継ぎ・JAN/オプション | ✅ 完了（#P0000表示・CSVファイル名統一・発注→仕入名称・loadItemsでJAN/オプション補完）。残りはPOS仕入タイル（#B0000） |
| 在庫変動履歴機能（Phase 5-2） | ✅ 完了（共通ユーティリティ・Webhook実装・一覧表示・CSV出力・UI調整） |
| 在庫履歴のアクティビティ種別振り分け | ✅ 完了（管理/ロス/仕入/入出庫/棚卸/売上/返品。Webhook二重防止・api/log-inventory-change で種別記録・上書き。2026-02-10 に出庫確定・入庫通常受領でのAPI呼び出しを追加し全確定処理で網羅） |
| 公開アプリ用 appUrl 統一・切り替え | ✅ 完了（extensions/common/appUrl.js で public/inhouse 切り替え、全POS拡張で参照） |
| リリース時必須対策の要件整理 | ✅ 完了（RELEASE_REQUIREMENTS_PUBLIC_APP.md セクション5 に記載。デプロイで履歴が消えないよう本番DB永続化、管理画面を開かなくても動くよう初回オープン案内） |
| 在庫・変動履歴の改善（2026-02-10 以降） | ✅ 完了（スナップショット共通化・変動日付TZ統一・バッチAPI・ロスと同様の処理に統一・履歴オプション3列。本文「このチャットで決めた要件・実装と進捗」に詳細） |
| 在庫変動履歴のロケーション名表示 | ✅ 完了（api/log-inventory-change でロケーション名が未設定または「出庫元」等ラベルのとき GraphQL で実ロケーション名を取得して保存。一覧・CSVで「ロケーション」列に正しい名前を表示） |
| 希望納品日・到着予定日ボタン設定UI | ✅ 完了（発注：希望納品日を発注先マスタと分離・CSV風リストでチェック・並び順・ボタン名・日数・上下。出庫：到着予定日も同様。ボタン名のカスタムラベル保存・POSで表示。初期は希望納品日=1週間後/1ヶ月後含む、到着=1日後/2日後） |
| 入出庫・仕入・ロス・棚卸のCSV出力項目設定 | ✅ 完了（設定画面の入庫・仕入・ロス・棚卸各タブに「〇〇履歴CSV出力項目設定」を追加。発注と同様のUIで項目のオン/オフ・並び順・デフォルトに戻す。各履歴画面のCSVダウンロードは設定の並び・含める列で出力） |

---

### 本番リリース時の2つの課題と対策（在庫変動履歴・情報取得）

本番デプロイで次の2つを満たすための要件をまとめ直したものです。

| 課題 | 望ましい状態 | 対策 | 備考 |
|------|--------------|------|------|
| **① 在庫変動履歴がデプロイ当日に消える** | デプロイ後も履歴一覧が残り、当日の履歴が消えない | **永続DB（PostgreSQL）を1つ用意する** | 下記 A / B の**どちらか一方**でよい |
| **② 管理画面を開かないと情報が取得できない** | POS・Webhook から不備なく API が動く | **インストール後（または初回利用前）に、1回は「管理画面でアプリを開く」**ことを利用手順で案内する | DBの有無とは別。OAuth でオフライントークンが保存されるタイミングのため |

**永続DBについて（①の対策）**

- 本番では Render のディスクがエフェメラルなため、SQLite（`dev.sqlite`）はデプロイのたびに消えます。在庫変動履歴とセッションを残すには **PostgreSQL などの永続DBが必須**です。
- 次の **A と B のどちらか一方** を用意すれば十分です（両方用意する必要はありません）。接続URLを環境変数 **`DATABASE_URL`** に設定し、Prisma 本番用設定・マイグレーションを行います。

| 選択肢 | 内容 |
|--------|------|
| **A. Render PostgreSQL** | Render の「Add-ons」で PostgreSQL を追加し、発行される `DATABASE_URL` を環境変数に設定する。 |
| **B. Supabase（PostgreSQL）** | Supabase で DB を作成し、接続URLを `DATABASE_URL` で渡す。（.cursorrules の本番環境予定に沿う場合） |

**情報取得について（②の対策）**

- POS や Webhook から `api/log-inventory-change` 等を呼ぶときは **オフラインアクセストークン** を使います。このトークンは **「管理画面でアプリを開いたとき」に OAuth が完了し、初めて Session テーブルに保存**されます。
- そのため、**「インストール後（または初回利用前）に、必ず1回は Shopify 管理画面でアプリを開く」** ことを利用手順・オンボーディングに明記する運用が必須です。多くの Shopify アプリが同じ前提です。1回開いた後は、管理画面を開かなくとも不備なく情報を取得できます。
- **在庫高の日次スナップショット**（Cron で `/api/inventory-snapshot-daily` を呼ぶ運用）では、**オフラインアクセストークンが期限切れの場合に Cron 実行時にリフレッシュトークンで自動更新**する処理を入れているため、**Cron が毎日動いていれば管理画面の開き直しは不要**です。リフレッシュトークンが90日使われないと失効する場合のみ「管理画面でアプリを1回開く」案内が必要です。詳細は `docs/INVENTORY_INFO_SNAPSHOT_AND_HISTORY_DATES.md`。
- 詳細・Prisma 設定例・手順は **RELEASE_REQUIREMENTS_PUBLIC_APP.md の「5. 本番で必須の2つの対策」** を参照してください。

---

**任意で残っているもの**: 履歴タブのCSV案内文言の見直し。

### 在庫情報の改善（2026-02-10 対応）

在庫情報で発生していた問題と対応内容です。

| 区分 | 問題 | 対応内容 |
|------|------|----------|
| **①在庫高** | 日付が変わるタイミングで自動保存されていない。管理画面を開いていなくても確実に保存したい。 | **Cron 必須**：`/api/inventory-snapshot-daily` を Render の Cron Job で毎日（例: 23:59）呼ぶ設定が必須。手順は `docs/CRON_JOB_SETUP_GUIDE.md` 参照。**フォールバック**：管理画面「在庫高」タブを開いたときに、前日分のスナップショットが無ければその場で1回だけ保存する `ensureYesterdaySnapshot` を追加（Cron が動いていない日も補完）。 |
| **①在庫高** | 管理画面を閉じたあと Cron 実行で「Invalid API key or access token」になる。 | **原因**：有効期限付きオフライントークン（`expiringOfflineAccessTokens: true`）で、アクセストークンが約1時間で期限切れになる。管理画面を閉じていると更新されず、Cron が期限切れトークンで API を呼ぶためエラーになる。**対応**：`/api/inventory-snapshot-daily` 実行時に、期限切れ（またはまもなく期限切れ）ならリフレッシュトークンで自動更新してから在庫取得・保存する処理を追加。Cron が毎日動いていれば**開き直し不要**で日次スナップショットが継続する。リフレッシュトークンが90日使われないと失効するため、その場合のみ「管理画面でアプリを1回開く」案内。詳細は `docs/INVENTORY_INFO_SNAPSHOT_AND_HISTORY_DATES.md`。 |
| **①在庫高** | 日付選択の枠がスマホで領域をはみ出している。 | 日付入力の親要素に `width: 100%`, `minWidth: 0`, `overflow: hidden` を指定し、領域内に収まるよう修正（`app.inventory-info.tsx`）。 |
| **②変動履歴** | POS からの変動がロスしかアクティビティが振り分けられず、他が全て「管理」になる。参照IDも空。 | **原因**：①インストール後しばらく管理画面を開いていないとオフラインセッションが無く、POS から `api/log-inventory-change` が 401 で失敗する。②その場合、後から `inventory_levels/update` Webhook だけが記録され「管理」・参照IDなしになる。**対策**：利用手順で「初回は必ず1回管理画面でアプリを開く」を案内（上記「本番リリース時の2つの課題」と同一）。各 POS 確定処理では既に `api/log-inventory-change` と `sourceId` を渡す実装済み。詳細は `docs/INVENTORY_CHANGE_ACTIVITY_WHY_MANAGEMENT.md`・`docs/INVENTORY_HISTORY_ADMIN_AND_DELTA_CAUSE.md`。 |
| **②変動履歴** | 履歴の項目を、商品名・オプションを含め他商品リスト・CSV と同等にしたい。「変動量」→「変動数」に変更したい。 | **一覧・CSV**：表示項目を「発生日時・商品名・SKU・オプション・ロケーション・アクティビティ・**変動数**・変動後数量・参照ID・備考」に変更。商品名・オプションはバリアントを GraphQL で一括取得して付与。CSV はオプションを「オプション1」「オプション2」「オプション3」列で出力。 |
| **②変動履歴** | 一覧・CSVの「ロケーション」列に ID や「出庫元」等のラベルではなく、実ロケーション名を表示したい。 | **api/log-inventory-change**：POS から送信される `locationName` が未設定または「出庫元」等のラベルのとき、GraphQL（`location(id).name`）で実ロケーション名を取得し、保存時に `resolvedLocationName` として DB に記録。管理画面の在庫変動履歴一覧・CSV の「ロケーション」列で正しい名前が表示される。実装: `resolveLocationName`（api.log-inventory-change.tsx）。 |

**メタフィールドから Render DB への方向性変更について**  
在庫変動履歴は当初メタフィールドで検討していたが、データ量・検索要件のため **Prisma（Render の PostgreSQL 等）の `InventoryChangeLog`** で実装済み。在庫高の日次スナップショットは引き続き **Metafield** に保存（Cron またはフォールバックで保存）。処理の分岐は「スナップショット＝Metafield 読み書き」「変動履歴＝DB 読み書き」で整理されている。

### このチャットで決めた要件・実装と進捗（2026-02-10 以降）

| 区分 | 内容 | 状態 |
|------|------|------|
| **在庫高** | スナップショット取得・集計・保存のロジックを共通モジュール化（`app/utils/inventory-snapshot.ts`）。在庫高タブ・Cron API・前日フォールバックの3箇所で共有。 | ✅ 完了 |
| **在庫高** | Metafield 肥大化への注意を `docs/INVENTORY_INFO_SNAPSHOT_AND_HISTORY_DATES.md` に追記（長期運用時の保持日数・別ストレージ検討）。 | ✅ 完了 |
| **在庫高** | Cron 実行時にオフラインアクセストークンが期限切れの場合、リフレッシュトークンで自動更新してからスナップショット保存する処理を追加（`api.inventory-snapshot-daily.tsx`）。管理画面を閉じていても、Cron が毎日動いていれば開き直し不要で日次保存が継続する。 | ✅ 完了 |
| **変動履歴** | 変動の日付をショップタイムゾーンに統一。Webhook（orders/refunds）・仕入の `logInventoryChange` で `date` を渡すように変更。`inventory-change-log.ts` は `data.date` があればそれを使用。 | ✅ 完了 |
| **変動履歴** | `api/log-inventory-change` をバッチ対応（`body.entries` で複数件受付）。POS 共通 `logInventoryChange.js` は1回の POST で複数件送信。 | ✅ 完了 |
| **変動履歴** | 入庫・出庫・棚卸・仕入を**ロスと全く同じ処理**に統一。Webhook では adjustment_group の有無にかかわらず種別を判定せず常に `admin_webhook` で保存し、種別はすべて API で上書き（`webhooks.inventory_levels.update.tsx` の adjustment 判定を廃止）。 | ✅ 完了 |
| **変動履歴** | 履歴一覧のオプション表示を「オプション1」「オプション2」「オプション3」の3列に分割（`app.inventory-info.tsx`）。CSV はもともと3列のため変更なし。 | ✅ 完了 |
| **ドキュメント** | `docs/INVENTORY_CHANGE_ACTIVITY_WHY_MANAGEMENT.md` に実装の所在・「ロスしか記録されていないときの確認」チェックリストを追記。ロスと他を「同じ処理」に統一した旨を反映。 | ✅ 完了 |

---

### 公開アプリ完了までにあと何が必要か

**機能・コード面**: ほぼ完了。以下は**運用・環境・審査提出**の準備。

| # | やること | 参照 | 必須度 |
|---|----------|------|--------|
| 1 | **本番用永続DBの用意**（PostgreSQL：Render Add-on または Supabase）。`DATABASE_URL` 設定・Prisma 本番用設定・マイグレーション。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md セクション5 | **必須**（デプロイで履歴が消えないように） |
| 2 | **初回オープン案内**：「インストール後（または初回利用前）に、必ず1回は管理画面でアプリを開く」を利用手順・オンボーディングに明記。 | 同上・REQUIREMENTS_FINAL 本番リリース時の2つの課題 | **必須**（POS・Webhook の API が動くため） |
| 3 | **Cron の設定**：在庫高の日次スナップショット用に `/api/inventory-snapshot-daily` を毎日（例: 23:59）呼ぶ。`INVENTORY_SNAPSHOT_API_KEY` を環境変数に設定。 | docs/CRON_JOB_SETUP_GUIDE.md | **推奨**（設定しないと前日分は管理画面を開いたときのフォールバックのみ） |
| 4 | **公開アプリ用環境**：パートナーで公開アプリを新規作成、Client ID/Secret 取得、公開用デプロイ先（例: pos-stock.onrender.com）・環境変数・`shopify.app.public.toml` の設定。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md ステップ1〜5 | **必須**（公開として動かすため） |
| 5 | **リスティング用アセット**：アイコン（1200×1200）、フィーチャー画像（1600×900）、スクリーンショット、紹介文・詳細文、プライバシーポリシーURL。 | docs/LISTING_ASSETS_GUIDE.md・RELEASE セクション3 | **必須**（審査提出の前提） |
| 6 | **パートナーでのリスティング入力**：デモ動画・テスト用認証情報・緊急連絡先など審査用項目の登録。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md | **必須**（審査提出前） |
| 7 | **App Store 審査に提出**：提出後は Shopify の審査待ち（数日〜1週間程度のことが多い）。指摘があれば修正して再提出。 | 同上 推奨する進行順 | **必須**（公開アプリ完了のため） |
| 8 | 履歴タブのCSV案内文言の見直し | REQUIREMENTS_FINAL 任意で残っているもの | 任意 |

**まとめ**: コード・機能はリリース可能な状態。あとは **①本番DB ②初回オープン案内 ③Cron（推奨）** の運用と、**④公開用環境 ⑤リスティング ⑥審査提出** で公開アプリ完了まで進められる。

---

**文言・UIトンマナの統一（必須）**  
新規・既存を問わず、**文言（ラベル・ボタン・メッセージ・モーダル見出し等）およびUIのトーン＆マナー（レイアウト・表記・コンポーネントの使い方）は、同一機能や他画面（入出庫・ロス・棚卸・仕入・発注など）と必ず統一すること。** 例：商品リストモーダルの見出しは「商品リスト」に統一（機能名を冠しない）。ボタン表記・読み込み表示・ステータスバッジ・フッター配置などは、既存の直近の統一実装に合わせる。実装・修正時は他画面との整合を確認すること。

**POS：タイルモーダル・タイトルバー内のカメラスキャン（2026-02 実装・仕様まとめ）**  
- **タイトルバー内ボタン**: **s-page** の **slot="secondary-actions"** で、×と同じ1本のアクションバーに「カメラスキャン」を設置可能。**出庫・入庫・ロス・棚卸の全タイル**で実装済み。  
- **カメラの起動・終了**: ホストから渡される **api**（posModalApi）の `api.scanner.showCameraScanner()` / `hideCameraScanner()` を使用（globalThis.shopify は未設定のことがあるため渡された api を優先）。**api_version は 2026-01**（showCameraScanner は 2026-01 で追加）。  
- **カメラを閉じる**: カメラ表示中は同じスロットのボタンを「**カメラを閉じる**」に切り替え、タップで `hideCameraScanner()` を呼ぶ。モーダルを閉じずにカメラだけ終了可能。  
- **連続スキャン**: カメラを開いたまま複数回スキャンし、終了したいときだけ「カメラを閉じる」をタップする運用（スキャンごとにカメラは閉じない）。  
- **表示領域**: **showCameraScanner()** では**指定不可**（API は引数なし、表示はホスト任せ）。表示領域を制御したい場合は **CameraScanner コンポーネント**（React POS API）をレイアウト内に配置する方式が必要（当プロジェクトは Polaris + Preact のため該当画面の React 化が必要）。  
- 詳細・要因・対応履歴は `docs/POS_HEADER_CAMERA_SCAN_FEASIBILITY.md` を参照。

---

## ✅ 要件完了サマリー（2026-02 再まとめ）

**ほぼ要件は完了**。以下を前提に本番リリース・運用を進める。

| 区分 | 内容 |
|------|------|
| **完了** | 棚卸ID発行UI（レイアウト・説明）、履歴モーダルのデバッグ情報削除、履歴のページネーション表示 |
| **不具合なし** | CSV1行目、コレクション/SKU検索（現時点で問題なし） |
| **実装なしで進行** | 一覧でのCSVまとめてダウンロード（入出庫履歴の一括CSVは未実装のまま） |
| **完了** | POS棚卸アプリの読み込み速度を入庫並みに最適化（一覧の数量表示・商品リスト表示の遅延を解消） |
| **微調整済み** | 棚卸ページ：上部メニュー下の余白を狭く（タブ＋区切り線を1ブロックにまとめて余白削減）。設定ページ：「破棄」「保存」ボタンを右寄せし、上下余白を抑えて浮き感を軽減 |

**直近の主な更新（2026-02）**:
- **在庫高日次Cron：オフライントークン自動リフレッシュ（2026-02-11）**: 管理画面を閉じたあと Cron 実行で「Invalid API key or access token」になる現象に対応。**原因**：有効期限付きオフライントークン（約1時間で期限切れ）のため、管理画面を閉じているとトークンが更新されず Cron が失敗する。**対応**：`/api/inventory-snapshot-daily` で、各ショップ処理前に「期限切れまたはまもなく期限切れならリフレッシュトークンで更新」する `refreshOfflineSessionIfNeeded` を実行。Cron が毎日動いていれば開き直し不要で日次スナップショットが保存される。ドキュメント：`docs/INVENTORY_INFO_SNAPSHOT_AND_HISTORY_DATES.md` に「管理画面を閉じたあと Cron でエラーになる理由」を追記。
- **在庫変動履歴のロケーション名修正（別チャットで実装）**: 在庫変動履歴一覧・CSVで「ロケーション」列に正しいロケーション名が表示されるよう修正。**api/log-inventory-change** で `locationName` が未設定または「出庫元」等のラベルのとき、GraphQL（`location(id)`）で実ロケーション名を取得し DB に保存。管理画面の在庫変動履歴タブの一覧・CSV出力の「ロケーション」列で、ID やラベルではなくショップのロケーション名が表示される。実装: `app/routes/api.log-inventory-change.tsx`（`resolveLocationName`、保存時の `resolvedLocationName`）。
- **希望納品日・到着予定日ボタン設定のUI改善（2026-02-11）**: ①**希望納品日の表示箇所**: 発注先マスタと分離し、仕入先マスタと同様に「左：タイトル＋説明／右：白カード」で「希望納品日の使用」を独立ブロックに。右側にラジオ（使用する/使用しない）＋日程ボタンリストを配置。②**日程ボタンのリストUI**: 希望納品日・到着予定日ともに、CSV出力項目設定に似た縦リストに変更（チェック・並び順・**ボタン名**・日数・↑↓）。チェックを外すとリストから削除、並び順は数字入力または上下ボタンで変更。③**ボタン名の編集**: アプリに表示するボタン名を管理画面で編集可能に。`order.desiredDeliveryQuickDayLabels` / `outbound.arrivalQuickDayLabels`（日数→ラベル）を保存。未設定時は日数から自動（7→1週間後、30→1ヶ月後、それ以外→○日後）。④**初期値**: 希望納品日は 1,2,3,7,30 日後（1週間後・1ヶ月後含む）、到着予定日は 1,2 日後。いずれも編集・追加可能。⑤**POSでの表示**: OrderConditions（発注）・ModalOutbound（出庫）でカスタムラベルを参照し、設定したボタン名を表示。実装: `app.settings.tsx`（型・サニタイザー・ヘルパー・UI）、`OrderConditions.jsx`、`ModalOutbound.jsx`。
- **入出庫・仕入・ロス・棚卸のCSV出力項目設定（2026-02-11）**: ①**設定画面**: 入庫設定タブに「入出庫履歴CSV出力項目設定」、仕入設定タブに「仕入履歴CSV出力項目設定」、ロス設定タブに「ロス履歴CSV出力項目設定」、棚卸設定タブに「棚卸履歴CSV出力項目設定」を追加。いずれも発注のCSV出力項目設定と同様のUI（左：タイトル＋説明、右：選択中項目のチェック・並び番号・項目名・上下ボタン、未選択項目の追加、デフォルトに戻す）。②**型・サニタイザー**: `SettingsV1` に `inbound.csvExportColumns` / `purchase.csvExportColumns` / `loss.csvExportColumns` / `inventoryCount.csvExportColumns` を追加。`sanitizeSettings` で各配列を検証し、空の場合はデフォルト並びを代入。③**各履歴画面のCSV連動**: 入出庫（app.history）・仕入（app.purchase）・ロス（app.loss）・棚卸（app.inventory-count）の loader で設定から該当 `csvExportColumns` を取得し、一括・モーダル両方のCSV出力で設定の並び・含める列でヘッダーと行を生成。入出庫は出庫も入庫と同じ設定を共有。棚卸は明細あり/明細なしの両方に対応（明細なしは設定のうち先頭7項目のみ）。実装: `app.settings.tsx`（定数・サニタイザー・4タブのCSV設定UI）、`app.history.tsx` / `app.purchase.tsx` / `app.loss.tsx` / `app.inventory-count.tsx`（loader で設定取得・CSV生成で設定参照）。
- **在庫変動履歴：出庫・入庫の確定処理から確実に api/log-inventory-change を呼ぶよう修正（2026-02-10）**: ①**出庫**: POS「出庫タイル→出庫モーダルで確定」のメインフロー（`submitTransferCore`）では、Transfer 作成後に `logInventoryChangeToApi` を呼んでおらず「管理」のままだったため、Transfer 作成成功直後に `logInventoryChangeToApi`（`activity: outbound_transfer`）を呼ぶ処理を追加（`extensions/stock-transfer-tile/src/ModalOutbound.jsx`）。②**入庫**: 通常受領分（plannedItems / cappedItems）で `receiveShipmentWithFallbackV2` 後に API が呼ばれていなかったため、単一シップメント・複数シップメントの両方で受領後に `logInventoryChangeToApi`（`activity: inbound_transfer`）を呼ぶ処理を追加（`extensions/stock-transfer-inbound/src/screens/InboundListScreen.jsx`）。③**棚卸・仕入・ロス**は全確定処理で既に API を呼んでいることをコード上で確認済み。④**ドキュメント**: 「なぜロス以外が管理になるか」「種別を付けるには api/log-inventory-change を各確定処理で呼ぶ」旨を `docs/INVENTORY_CHANGE_ACTIVITY_WHY_MANAGEMENT.md` に新規作成。
- **出庫マルチシップメント挙動の定義**: `docs/OUTBOUND_MULTI_SHIPMENT_BEHAVIOR.md` を作成。出庫リストの「確定する」「下書き保存」「配送準備完了にする」の挙動を明確化。Shopify Admin API 検証に基づき、既存 Transfer へのシップメント追加は `inventoryShipmentCreate`（下書き）または `inventoryShipmentCreateInTransit`（確定）で `movementId` に Transfer ID を渡すことで可能であることを確認。`READY_TO_SHIP` な Transfer の lineItems 更新は `inventoryTransferSetItems` で可能だが、`READY_TO_SHIP` から `DRAFT` への戻しは API がサポートしていないことを明記。UI では「編集」モーダルから「シップメントを確定」を削除し、出庫リストの「確定する」で Transfer またはシップメント全体の確定が行われるように簡素化。
- **POS拡張の4分割**: 出庫・入庫・ロス・棚卸を各1拡張に分割（stock-transfer-tile=出庫のみ `ModalOutbound.jsx`、stock-transfer-inbound=入庫のみ、stock-transfer-loss=ロスのみ・棚卸関連ファイル削除、stock-transfer-stocktake=棚卸のみ・新規作成）。ビルドサイズ対策・単一機能化。4分割後の検証結果は `docs/EXTENSION_VERIFICATION_4SPLIT.md` に記載。
- **出庫メニュー廃止**: タイルを開くと直接「出庫コンディション」画面を表示（MenuScreen を経由しない）。
- **4モーダル コンディション画面フッター**: 左下の「閉じる」「戻る」（機能しない）を「軽量モード」ボタンに変更。ロス・棚卸には `liteMode` / `onToggleLiteMode` のサポートと UI 設定の永続化を追加。出庫はフッター中央に「履歴一覧」ボタンを配置し、スクロール内の履歴ブロックを削除（ロスと同様の構成）。
- **出庫フッターが消える問題の解消**: 履歴一覧・商品リストからコンディションに戻った際にフッターが消えていた要因（Extension の useEffect が screen===OUTBOUND_COND のときに setFooter(null) していた）を削除して解消。
- **タイル名の統一**: 各タイルの heading/subheading を「メイン / サブ」に統一（出庫/在庫処理、入庫/在庫処理、ロス/在庫調整、棚卸/在庫調整）。モーダル内 s-page heading は短い表記（出庫、入庫、ロス、棚卸）。
- **管理画面「POSのアプリ追加」のアプリ名**: 各拡張の shopify.extension.toml の `name` を「出庫 / 在庫処理」「入庫 / 在庫処理」「ロス / 在庫調整」「棚卸 / 在庫調整」に変更。管理画面で古いアプリ名が表示される問題に対し、**`description` も同表記に更新**（stock-transfer-tile / inbound / loss / stocktake の各 shopify.extension.toml）。デプロイ後も表示が変わらない場合は、ダッシュボードのキャッシュや読み取り専用表示の可能性あり。
- **2カラムレイアウトのSP対応**: 入出庫履歴・ロス履歴・棚卸（商品グループ設定、棚卸ID発行、履歴）・設定画面全タブで、PC時は**左：タイトル＋説明 / 右：白カード（フィルターや一覧・フォーム）**の2カラム構成、SP時は右カラムを左カラム下部に回す。flexWrap + flex-basis で折り返し。
- **コレクション全件読み込み**: 250件以上のコレクションを持つショップに対応。ページネーションで全件取得。
- **商品SKU全件読み込み**: 650件以上のSKUを持つショップに対応。商品・バリアントをページネーションで全件取得（250商品/ページ、250バリアント/商品）。
- **アプリ表示件数の入力検証**: 半角数字以外（全角数字・スペース等）の検証と対処。範囲外・不正入力時は「値を確認してください。半角数字で入力をお願いします。」を入力欄下に表示。バックエンドでもサニタイズ。
- **読み込み中表示**: loader実行中に画面上部に「読み込み中…」バナーを表示（棚卸等の重いloader対応）。
- **棚卸リストのページネーション**: コレクション一覧・SKU一覧を1000件/ページで表示。検索・絞り込み結果の先頭1000件を表示し、リスト下部に「前へ」「1-1000 / 全X件」「次へ」を配置。大量データ時のタブ切り替え遅延を解消。
- **コレクション・SKUリストの下線追加**: 各項目の下に1pxの区切り線を追加し、視認性を向上。選択時は緑枠を優先。
- **コレクション商品選択モーダル強化**: 10000SKU超のコレクション対応。API全件取得（ページネーション）、モーダル内に検索枠・選択済みボタン・1000件/ページのページネーションを追加。
- **出庫履歴一覧のレイアウト統一（入庫リストと同型）**: 出庫の「未出庫/出庫済み」履歴カードを入庫の「未入庫/入庫済み」と同じ行単位レイアウトに変更。1行目：出庫ID｜日付、5行目：状態｜数量（`justifyContent="space-between"`）。配送準備完了時は右端に「編集」ボタン。差の説明は `docs/INBOUND_VS_OUTBOUND_LIST_LAYOUT.md` に記載。
- **出庫履歴の「状態｜数量」行の改行防止**: 状態と数量の行に `flexWrap: "nowrap"` を指定し、数量を `s-box`（`flexShrink: 0`）で囲んで改行しないように修正。ModalOutbound.jsx と OutboundHistoryScreens.jsx の両方に適用。
- **出庫履歴の「未確定：1」表示対応**: API が `shipments` を配列・nodes・edges・単体オブジェクトのいずれで返すか正規化し、処理済みでない配送が1件だけのときも「（未確定：1）」が表示されるように修正。
- **配送リストの「キャンセル」ボタン**: タップで確認モーダル（「この出庫（Transfer）をキャンセルします。よろしいですか？」）を表示し、モーダル内の「キャンセルする」で実行。商品リスト（OutboundHistoryDetail）のキャンセルと同様のフローに統一。
- **出庫履歴一覧から詳細を開いたときのフッター**: 履歴一覧で Transfer をタップして詳細を開く際に `historyFromShipmentSelection: false` を設定。これにより詳細フッターに「戻る」「編集」「キャンセル」が表示され、左に戻るボタンがなくなる問題を解消。
- **Transfer の lineItems を仮想行として表示（2026-02）**: Transfer が READY_TO_SHIP かつ lineItems を持つ場合、シップメントリストの**先頭**に「発送準備完了」相当の仮想行を追加。管理画面の「発送準備完了」ブロック（Shipment ID なし）と同一表示にする。仮想行のラベルは **#T0127-L**（L = Line items）、実 Shipment は **#T0127-1, #T0127-2...** とし、管理画面のシップメント ID と重複しない形式に統一。
- **仮想行タップ時の商品リスト（2026-02）**: 仮想行をタップしたときは **Transfer の lineItems のみ**を表示（Shipment ID が付与されていない商品リストのみ）。下書き・処理中の Shipment の商品は含めず、`loadDetail_` で仮想行選択時は `d.lineItems`（fetchInventoryTransferDetailForHistory の Transfer lineItems）のみで items を構築。
- **複数シップメント追加・編集時の確定モーダル（2026-02）**: ③複数シップメント「追加」および ②④複数シップメント「編集」時は、確定モーダルを**「確定する」「下書き保存」の2種のみ**に変更。「配送準備完了にする」は非表示。詳細は `docs/OUTBOUND_CONFIRM_FLOWS.md` を参照。
- **出庫リストに「配送情報」ボタン・モーダル（2026-02）**: OutboundList ヘッダーに「軽量」「在庫更新」に続けて**「配送情報」**ボタンを追加。タップでモーダルを開き、コンディション画面と同様の入力（配送業者・配送番号・到着予定日、1日後/2日後/クリア）が可能。複数シップメント追加時など、2つ目以降の配送情報をアプリ内で入力できる。
- **「在庫再取得」→「在庫更新」に名称変更（2026-02）**: 出庫・入庫・ロス・棚卸の各リスト画面で、ヘッダーボタン表記を「在庫再取得」から**「在庫更新」**に統一。対象: ModalOutbound.jsx, OutboundListScreen.jsx, Modal.jsx, Screens.jsx, Screens_part2.jsx, Modal_tmp.jsx, InventoryCountList.jsx。
- **入庫の REFERENCE 整合（2026-02）**: 入庫専用拡張（stock-transfer-inbound）を Modal_REFERENCE.jsx の入庫部分と揃える対応を実施。**表示・UI**: 商品画像を inboundApi の fetchInventoryShipmentEnriched で includeImages に応じたクエリに変更し画像表示を有効化。InboundList ヘッダーの配送情報（配送業者・配送番号・予定日）を REFERENCE と同様に常時3行表示に変更。**確定処理・状態**: InboundShipmentSelection で selectedOriginLocationId 設定、確定前メモの overForLog に sku、receiveConfirm の readOnly/二重送信防止・複数シップメント・予定外出庫元マイナス・capped 超過の extraDeltasMerged・確定後メモ（在庫調整履歴）・onAfterReceive 条件を REFERENCE と同一に実装。**遷移・表示**: 確定後の振り分け（完了時 INBOUND_COND＋inbound クリア、未完了時 INBOUND_SHIPMENT_SELECTION＋シップメントのみクリア）、transferForShipment の算出（pendingTransfers から readOnly/originLocationId/ヘッダー表示を優先）、listLimit を appState?.outbound?.settings?.inbound?.listInitialLimit に統一、appendInventoryTransferNote_ に processLogCallback を渡す。**モーダル**: 確定モーダルの「一部入庫」「確定する」に onPress を追加（REFERENCE 互換）。警告エリアの「確認しました」は現行の理由＋メモ＋一方向 ack を維持（意図的）。**監査ログ**: appendInboundAuditLog の extras を確定後実際に反映した extraDeltasMerged から組み立てるよう変更。差分一覧・方針は `docs/INBOUND_REFERENCE_DIFF_ITEMS.md` に記載。
- **商品リストヘッダー・再読込統一・配送一覧フッター（2026-02）**: **① 商品リストヘッダー**: 検索枠以外のボタン（画像表示・全入庫・リセット等）を上下中央配置に変更。入庫 InboundListScreen のヘッダー行を `alignItems="center"` に変更（出庫履歴商品リストは既に中央配置）。**② ボタン表記統一**: 「再取得」と「再読込」の混在を解消し、全拡張で**「再読込」**に統一。ローディング表記は「取得中...」→**「読込中...」**に統一。対象：出庫（ModalOutbound.jsx）、入庫（InboundListScreen.jsx, InboundShipmentSelection.jsx, Modal.jsx）、ロス（LossConditions.jsx, LossHistoryList.jsx）、棚卸（InventoryCountConditions.jsx, InventoryCountProductGroupSelection.jsx）。**③ 配送一覧フッター**: 出庫の配送一覧（OutboundShipmentSelection）のフッターを**左：戻る、中央：キャンセル、右：再読込**に変更。キャンセル不可（TRANSFERRED/CANCELED）時はキャンセルボタンを無効化（グレーアウト）。キャンセル可時はタップで確認モーダル（「この出庫をキャンセルします。よろしいですか？」＋戻る／キャンセルする）を表示し、履歴商品リストのキャンセルモーダルと同じフローでキャンセル処理（inventoryTransferCancelSafe＋在庫を出庫元に戻す＋メモ追記）を実行。
- **入庫：確定済み時の検索・数量グレーアウト・画像表示は有効（2026-02）**: 確定済み（readOnly）の InboundList で、検索枠と数量ボタン（−／数値／＋）をグレーアウト（disabled＋tone="subdued"）。画像表示トグルは確定済みでも**グレーアウトせず機能させる**（readOnly の影響から除外）。InboundUiParts.jsx の QtyControlCompact_3Buttons に disabled 対応、renderInboundShipmentItems_／InboundAddedLineRow に readOnly を渡して数量コントロールを無効化。
- **出庫履歴商品リスト：ヘッダーボタン並び・表記（2026-02）**: ヘッダー右側のボタン並びを**画像表示 → 在庫更新 → 複製**に統一。画像表示ボタンは「画像表示」のみ表示（ON/OFF表記なし）。下書き複製ボタンは**「複製」**のみ表示。
- **ロス・入庫・読み込み表示のUI統一（2026-02）**:
  - **ロス**: ①コンディション画面のフッターで、ボタン上のロケーション・スタッフ・日付/理由のサマリー行を非表示。②商品リストのヘッダーを「ロス登録」「ロケーション：」「日付：」「理由：」に変更。③履歴商品リストのフッター（ボタン上）を**左：ステータス（バッジ）／右：合計：N（商品リストの数量合計）**に変更。④画像表示ON/OFFが商品リストに反映されていなかった問題を修正：LossScreen から LossProductList に `liteMode` / `onToggleLiteMode` を渡し、親の設定を優先。⑤ロス商品リストのヘッダーで、左のステータス文領域の**右寄せ上下中央**に「画像表示」ボタンを設置（リセットは右端に分離）。
  - **入庫**: ①商品リストのフッターにステータスバッジを追加（履歴含む）。②バッジはボタン上ではなく、中央の「予定0/入庫3」の**左**に表示。③商品リストのステータスがトランスファー一覧のステータスを引き継ぐよう修正：`inbound.selectedTransferStatus` および `transferForShipment?.status` を一覧と同じ `STATUS_LABEL`（下書き・配送準備完了・処理中・進行中・入庫・入庫済み・キャンセル・その他）で表示。
  - **読み込み表示の統一**: 画面上の「取込中...」「読込中...」「商品を読み込み中...」「検索中...」「取得中...」等を全て**「読み込み中...」**に統一。ボタン**内**のラベル（再読込ボタン・読込ボタン等のローディング時）は**「読込中...」**に統一。
  - **出庫の商品リスト「読み込み中...」**: 出庫履歴詳細（OutboundHistoryDetail）の商品リストで、読み込み中が領域左上に空白なしで表示され直下に下線が出ていた問題を修正。他商品リストと同様、`detailLoading` 時は早期 return で `<s-box padding="base">読み込み中...</s-box>` のみ表示（下線なし）。
- **入庫・棚卸のまとめて表示UI改善・棚卸下書き修正（2026-02）**:
  - **入庫複数シップメント・まとめて表示**: ①処理済みシップメントの商品リストの数量ボタンをグレーアウト（per-shipment readOnly）。②シップメントタイトル行を右寄せにステータスバッジ（入庫済み/未入庫）を表示。③ステータスバッジの横に件数（〇件）を表示。
  - **入庫複数シップメント・シップメントごと表示**: 処理済みの商品リストで検索枠と数量ボタン（全入庫・リセット・検索候補の数量/追加）をグレーアウト。検索枠に `opacity: 0.6`、InboundCandidateRow に `readOnly` を渡して disabled＋tone="subdued"。
  - **棚卸複数商品グループ・まとめて表示**: ①商品グループタイトル右のステータスを `s-badge` 化（完了済み/未完了）。②件数の括弧を削除（`(3/5)` → `3/5`、`(5件)` → `5件`）。
  - **棚卸自動下書き・復元の不具合修正**: 複数商品グループ・単一商品グループともに下書きが動作しなかった要因を解消。①Storage API 戻り値のハンドリング（`got?.[key] ?? got` で wrapped 形式に対応、入庫と同様）。②countId/locationId の GID 形式差異に対応（正規化して比較）。③`currentGroupId` の重複宣言を削除。
  - **棚卸複数商品グループの下書きを商品グループIDごとに連動（2026-02）**: 商品グループリストから1つだけ表示して自動保存すると全グループが同じリストで復元されていた不具合を修正。下書きキー判定を「表示中のグループ数」ではなく「棚卸IDが持つグループ数」（`count.productGroupIds.length > 1`）に変更。複数グループの棚卸IDは常にグループIDごとのキーで保存・復元し、まとめて表示とグループごと表示が連動。単一商品グループの棚卸IDは従来どおりレガシーキーのみで影響なし。
  - **ロス商品リストヘッダー**: 画像表示とリセットボタンを2つとも右寄せに調整（`justifyContent="end"`）。
  - **検索からの商品追加トースト**: 棚卸・入庫のトースト文言を出庫ベースに統一（「〇〇 を追加しました（+N）」形式）。
- **POS画像表示ON/OFFの設置箇所一覧・棚卸連動・ロス履歴（2026-02）**:
  - **設置箇所ドキュメント**: 出庫・入庫・ロス・棚卸で画像表示を設置している画面・箇所を一覧化。`docs/POS_IMAGE_DISPLAY_PLACEMENT.md` に記載。各機能のコンディション（フッター左／中央）、商品リスト（ヘッダー右）、履歴一覧・履歴詳細の設置箇所を表で整理。
  - **棚卸の画像表示引き継ぎ**: コンディション画面と商品リストで画像表示ON/OFFが引き継がれていなかった問題を修正。StocktakeScreen から InventoryCountList に `liteMode` / `onToggleLiteMode` を渡し、商品リストでは親の設定を優先（ロスと同様）。単一拡張内で連動。
  - **ロス履歴の画像表示**: 履歴一覧のフッター中央に「画像表示:ON/OFF」ボタンを追加（出庫履歴一覧と同様）。履歴詳細のヘッダー右に「画像表示」ボタンを追加（商品リストヘッダーと同様）。LossScreen から LossHistoryList に `liteMode` / `onToggleLiteMode` を渡し、ロス内で連動。
- **管理画面：入出庫履歴モーダルを棚卸UIに寄せた表示（2026-02）**: Action の戻り値に `groupedLineItems`（配送単位のグループ配列）を追加。モーダル上部に進捗状況を情報欄最下部で表示（各配送の入庫済み/未入庫・予定外入庫件数）。モーダル本文は配送ごとのブロック表示（各ブロックにタイトル＋明細テーブル、商品0件は「この配送には商品がありません」）。CSVは従来どおり `lineItems` のフラット形式を維持。
- **管理画面：棚卸モーダルの進捗・ブロック・予定外（2026-02）**: 進捗状況を情報欄の最下部に移動（入出庫と同様）。単一グループ時も複数と同じブロック＋背景色で表示。予定外は各グループのテーブルから分離し、一覧最後に「予定外（N件）」ブロックとして表示（入出庫の予定外入庫ブロックと同様）。
- **管理画面：ステータスをバッジ表示に統一（2026-02）**: 入出庫・ロス・棚卸の一覧およびモーダルで、ステータスをピル型バッジ（完了系=緑、キャンセル系=グレー/赤、進行中=青等）で表示。管理画面でもアプリと同様のバッチ表示を実装。
- **POS 棚卸アプリの読み込み速度を入庫並みに最適化（2026-02）**: 棚卸タイルの「一覧の数量表示」と「商品リスト表示」が遅かった要因に対応。①商品リストの在庫取得をバッチ並列化（15件ずつ Promise.all）し、返り値に `currentQuantity` を付与。②商品リスト画面で在庫の二重取得を廃止（fetch 1回で表示まで完結）。③商品グループ名の取得で `readProductGroups` を 60秒 TTL でキャッシュ。④一覧の未完了グループ取得を最大3並列で実行。詳細・要因分析は `docs/POS_STOCKTAKE_SLOWNESS_ANALYSIS.md` に記載。実装: stocktakeApi.js, InventoryCountList.jsx, InventoryCountConditions.jsx。
- **ロケーション切り替え（出庫のみ実装済み・他機能は将来対応）**: 2026-02時点で **出庫** のみ画面上部「出庫元」「宛先」の右に「変更」ボタンを設置し、ロケーション切り替えが可能（`ModalOutbound.jsx`）。**2026-02追記**: モーダルから **インライン展開** に変更。ボタン押下で同一画面内に検索窓とロケーションリストを展開（到着時刻・配送業者変更と同様）。「変更」ボタンは展開中「閉じる」に切り替わる。ロス・入庫・棚卸については、POSセッションロケーションを利用する従来仕様を維持しつつ **将来的な実装候補として管理**（タイル上部のボタンは非表示に戻す）。必要となる追加作業（管理画面のロケーション設定との連携、各処理フローでのロケーション ID 受け渡しの再設計）は `docs/FUTURE_LOCATION_SWITCH_NOTES.md` にまとめた。
- **出庫UI：ロケーション選択・到着時刻のボタン統一（2026-02）**: ①ロケーション選択をモーダルから **インライン展開** に変更。「変更」ボタン押下で検索窓＋スクロール可能なリストを同一画面内に表示。②「閉じる」ボタンを廃止し、「変更」「時間を選択」ボタンを展開中は「閉じる」に切り替えてトグルで開閉。③到着時刻の表示ラベルを「到着時刻」→**「時間指定」**に変更（`ModalOutbound.jsx`）。
- **管理画面：入出庫履歴の商品リストモーダルに配送情報を追加（2026-02）**: 商品リストモーダルの情報欄で、入庫先とステータスの間に **配送業者**・**配送番号**・**予定日** の3行を追加。Action で `shipments` に `tracking { trackingNumber company trackingUrl arrivesAt }` を取得し、先頭シップメントの `transferTracking` を返却。出庫アプリで登録した配送情報が管理画面でも確認可能（`app.history.tsx`）。
- **仕入・発注の進捗（2026-02-06）**:  
  ①処理確定モーダルで「仕入予定（#P0000）が作成されました。」と表示（`purchaseName` 使用）。  
  ②CSVファイル名を統一（一覧: 機能_日付、単一: 機能_名称_日付。発注は orderName、仕入は purchaseName をサニタイズ）。  
  ③発注→仕入の名称引き継ぎ（#P0000 / #P0000-1）は既存実装で完了。  
  ④発注・仕入の `loadItems` で JAN（barcode）・オプション（selectedOptions）を API から補完し、キャンセル時・CSV出力でも利用。  
  ⑤POS 仕入拡張 `extensions/stock-transfer-purchase` を実装：  
  　- コンディション: ロケーション＋仕入先（**選択時は「選択中」バッジ（info/ブルー）、未選択時は「必須」バッジ（critical/赤）**・サプライヤーマスタ＋「その他（仕入先入力）」は設定の `purchase.allowCustomSupplier` で表示制御）、備考、履歴一覧ボタン。仕入先未選択時はピッカー初期展開（**「仕入先を選択してください」エラーテキストは削除**）。下書き復元時に選択済みの場合はピッカーを閉じた状態で復元（発注と同様）。  
  　- 仕入商品リスト: 出庫商品リストUIをベースに、数量ボタン幅・予定/仕入表示・検索リスト・在庫表示・予定外仕入セクションを入庫と同じ仕様で実装。下書き自動保存/復元あり。  
  　- 仕入履歴一覧＋商品リスト: 入庫コンディション/商品リストUIをベースに、ステータスバッジ・予定/仕入/超過/不足/予定外サマリ、検索からの追加（予定行加算 or 予定外行追加）、確定時の在庫加算＋`purchase_entries_v1` 更新（#P→#B 採番）、履歴ごとの下書き自動保存/復元を実装。  
  　- カメラスキャン: 発注/ロス/棚卸と同じく、`api.scanner.showCameraScanner()` / `hideCameraScanner()` を利用（`api_version = "2026-01"`）。スキャン値はストレージキュー経由で商品リストに連携し、トースト「スキャン: 値」を表示。  
  ⑥POS 発注コンディションの仕入先UIを仕入と統一：ロケーション直下に仕入先ブロックを配置し、**選択時は「選択中」バッジ（info/ブルー）、未選択時は「必須」バッジ（critical/赤）**を表示（「仕入先を選択してください」エラーテキストは削除）、未選択時はピッカー初期展開、「その他（仕入先入力）」は設定の `purchase.allowCustomSupplier` で表示制御（ラベル・説明文なしのテキストフィールド）。  
  ⑦POS 発注/ロスコンディションのフッター summaryLeft に「ロケーション: {locationName}」を表示し、全拡張でロケーション表示と画像ON/OFFボタンの配置を統一。
- **公開アプリリリース向け・本番前整理（2026-02）**: ①**本番前コード整理**: server 側（app/routes、api、webhooks）および **全POS拡張**（出庫・入庫・ロス・棚卸）のデバッグ用 `console.log` / `console.warn`（`[検証]` や詳細ダンプ系含む）を削除。loader/action の catch 内の `console.error` は本番時の障害追跡のため残置。②**リスティング用ガイド**: `docs/LISTING_ASSETS_GUIDE.md` を新規作成。フィーチャー画像・スクリーンショットの内容、紹介文・詳細文の案、プライバシーポリシーURL・価格帯の目安（月額単一プラン 1,980〜2,980円、プラン分け時ベーシック 980〜1,480円・プロ 2,480〜3,980円）、デモ用ストアの必要性、チェックリストを記載。③**SKU数・明細の表現一覧**: `docs/POS_SKU_MEMORY_LIST.md` を新規作成。POS 各画面で「明細」「SKU数」「〇件」を表示している箇所を一覧化し、表記統一の参照用に整理。
- **POS 微調整・表記統一（2026-02）**:
  - **入庫**: 商品リストヘッダーのリセットボタンをロスと同様に赤（`tone="critical"`）に変更。
  - **出庫**: ①履歴商品リストフッターを**左：戻る、中央：キャンセル、右：編集**に変更。②コンディションの時間帯選択（午前中・12:00等）を**横並び・左寄せ**に変更。③配送情報モーダルから「戻る」ボタンとその上の区切り線を削除（閉じるで閉じる想定）。④**棚卸画像ON/OFF**: 画像切替時に商品リストを再読込しないよう変更（常に includeImages: true で初回取得し、表示切替のみ。ロス・入庫・出庫と同様）。⑤画像ボタン表記を全拡張で**「画像ON」「画像OFF」**に統一（コンディション・一覧・商品リストの全ページ）。⑥複数配送の配送リスト（OutboundShipmentSelection）フッターを**中央：キャンセル、右：再読込**に変更。⑦出庫商品リストフッター中央の画像ON/OFF表記を削除し、「明細 X / 合計 Y」のみ表示・中央寄せ（入庫の商品リストフッターと合わせる）。
  - **ロス**: 商品リスト内サマリーの「合計ロス」を**「合計」**に変更（他機能と表記統一）。
  - **棚卸**: 一覧カードの「N SKU」表記を**「N件」**に変更（InventoryCountConditions.jsx の2箇所、InventoryCountProductGroupSelection.jsx の1箇所）。数量（qtyText）の表示は従来どおり。
- **管理画面：ロス区分設定の実装（2026-02-06）**: ①**ロス区分（lossReasons）のCRUD機能**: 管理画面「ロス設定」タブで、ロス理由（破損・紛失など）を登録・編集・削除・並び替え可能に。デフォルトで「破損」「紛失」の2区分を自動設定。②**「その他（理由入力）」の表示制御**: ラジオボタンで「表示する」「表示しない」を選択可能（`loss.allowCustomReason`）。デフォルトは「表示する」。③**POSロス画面との連動**: POSロスコンディション画面で、設定から読み込んだ `lossReasons` を理由ボタンとして表示。「その他」が許可されている場合は「その他」ボタン＋テキスト入力欄を表示。実装: `app.settings.tsx`（ロス設定タブ）、`LossConditions.jsx`（設定読み込み＋動的ボタン生成）。
- **管理画面：「その他」表示制御の統一（2026-02-06）**: ①**仕入設定**: 「その他（仕入先入力）」の表示/非表示をラジオボタンで制御（`purchase.allowCustomSupplier`）。デフォルトは「表示する」。②**出庫設定**: 「その他（配送会社入力）」の表示/非表示をラジオボタンで制御（`outbound.allowCustomCarrier`、フラグ先行実装）。デフォルトは「表示する」。③**UIトンマナ統一**: すべて「『その他（〇〇入力）』を表示」という見出し＋「表示する」「表示しない」のラジオボタン形式に統一。実装: `app.settings.tsx`（仕入設定タブ・出庫設定タブ）、`PurchaseConditions.jsx`・`OrderConditions.jsx`（設定に応じた「その他」ボタン表示制御）。
- **POS UI：選択中バッジ・ボタン表記統一（2026-02-06）**: ①**出庫タイル**: 配送業者・時間指定に選択時に「選択中」バッジ（`tone="info"`/ブルー）を表示。未選択時はバッジ非表示。「変更」ボタンは開いている時「閉じる」に変更。「その他」ボタンを最下部に配置し、タップでテキストフィールドを表示。②**仕入・発注タイル**: 仕入先行に選択時に「選択中」バッジ（`tone="info"`/ブルー）、未選択時は「必須」バッジ（`tone="critical"`/赤）を表示。「仕入先を選択してください」エラーテキストを削除。③**下書き復元時のピッカー制御**: 仕入コンディション画面で、選択済みの場合は閉じた状態で復元（発注と同様）。実装: `ModalOutbound.jsx`（配送業者・時間指定）、`PurchaseConditions.jsx`・`OrderConditions.jsx`（仕入先バッジ・ピッカー制御）。

- **在庫変動履歴のアクティビティ種別振り分け・二重記録防止（2026-02-07）**: ①**表示文言**: アクティビティ「管理画面」→**「管理」**、「仕入キャンセル」→**「仕入-」**（`app.inventory-info.tsx`）。②**売上・返品 Webhook**: `shopify.clients` が無い場合の session ベース GraphQL フォールバック追加（`webhooks.orders.updated` / `webhooks.refunds.create`）。③**ロス**: `referenceDocumentUri` 付与＋確定後に `api/log-inventory-change`（`activity: loss_entry`）。管理／ロスでのロケーション ID 表示はロケーション名取得・GID 変換で対応。④**入庫・出庫・棚卸**: 各拡張で確定後に `api/log-inventory-change` 呼び出し（対応する activity で履歴に種別記録）。⑤**仕入**: `purchaseApi.js` に `referenceDocumentUri` 追加。PurchaseProductList / PurchaseHistoryList で確定後に `api/log-inventory-change`（`activity: purchase_entry`）。⑥**inventory_levels/update Webhook**: `inventoryAdjustmentGroups` は API に存在しないためフォールバック削除。同一変動が既に記録されていれば保存スキップ（`knownActivities`: loss_entry, purchase_entry, inbound_transfer, outbound_transfer, inventory_count, order_sales, refund）。売上・返品時の二重「管理」防止。⑦**種別上書き**: `api/log-inventory-change` 呼び出し時に直近の「管理」行（同一 item/location/quantityAfter）があれば activity をロス・仕入等に更新。⑧**二重表示解消**: ロス1個が「4個マイナス」表示になっていた要因（Webhook とアプリの二重記録）をスキップ・上書きで解消。

- **公開アプリ用 appUrl 設定・切り替え（2026-02-07）**: ①**共通設定**: `extensions/common/appUrl.js` を新規作成。`APP_MODE = "public"` で本番 `https://pos-stock.onrender.com`、`"inhouse"` で `https://stock-transfer-pos.onrender.com`。開発用 `DEV_APP_URL` はトンネル利用時に手動変更可。②**全POS拡張で参照**: ロス・仕入・入庫・出庫・棚卸・発注で `/api/log-inventory-change` 等のベース URL を `getAppUrl()` で取得。参照パスは `../../../../common/appUrl.js` 等で統一。③**公開開発**: 本番ビルド時は `getAppUrl()` を使用。Render への push と `shopify app deploy` で公開アプリとして利用可能。

- **api.log-inventory-change デバッグログ削除（2026-02-07）**: 本番運用前に `app/routes/api.log-inventory-change.tsx` からデバッグ用ログを削除。①トークン payload の未検証デコード＋`console.warn`（aud/iss/dest 等）のブロック削除。②リクエスト受信時の `[api.log-inventory-change] Called: ...` および専用変数（rawItemIdLog / rawLocIdLog / qtyAfterLog）の削除。③`Updated admin_webhook to ...` の `console.log` 削除。認証エラー時の `No Authorization Bearer header`・`decodeSessionToken error`・`POS auth failed` は本番追跡のため残置。

- **在庫変動履歴：全確定処理で log-inventory-change API 呼び出しを網羅（2026-02-10）**: 出庫・入庫・棚卸・仕入・ロスの**全ての確定処理**で `api/log-inventory-change` が呼ばれるよう補完・確認。**出庫**: `submitTransferCore` で Transfer 新規作成成功後に `logInventoryChangeToApi`（outbound_transfer）を追加。**入庫**: 通常受領（plannedItems/cappedItems）で API が未呼び出しだったため、単一・複数シップメント両方で受領後に呼び出しを追加（inbound_transfer）。**棚卸・仕入・ロス**: 既存で全パス呼び出し済みであることをコード確認。詳細は `docs/INVENTORY_CHANGE_ACTIVITY_WHY_MANAGEMENT.md` 参照。

- **リリース時必須対策の要件整理（2026-02-07）**: デプロイで履歴が消える・管理画面を開かないとエラーになる問題の原因と対処を RELEASE_REQUIREMENTS_PUBLIC_APP.md の「5. 本番で必須の2つの対策」に記載。①**履歴が消える**: 本番は SQLite がエフェメラルなため、Render PostgreSQL または Supabase 等の永続DBを用意し DATABASE_URL 設定・Prisma 本番用設定・マイグレーション実施が必須。②**管理画面を開かないとエラー**: オフラインセッションは初回に管理画面でアプリを開いたときに保存されるため、インストール後「1回は管理画面でアプリを開く」旨を利用手順で案内する運用で対応。詳細・Prisma 設定例は RELEASE_REQUIREMENTS_PUBLIC_APP.md セクション5 参照。

**以前の主な更新**:
- **SKU/CSVグループの確認・編集**: 編集で「SKU選択から作成」タブに切り替え、選択済みSKUを復元。一覧外のinventoryItemIdは維持。右パネルに「SKU一覧（N件）を確認・編集」を表示。
- **CSV**: 登録済みをCSVダウンロード、インポートモード（新規作成・追加・上書き）、新規作成を選択肢の一番上に配置。
- **CSV行数**: 最大10000行まで対応。SKU解決をバッチ（25件/クエリ）＋並列（10本）で行い、行数に応じて処理を分岐。
- 商品グループ作成方法: コレクション / SKU選択 / CSV一括登録の3方式。タブ・ボタン・編集中バナー統一、選択済み絞り込み、編集リセットバグ修正済み。

## 📋 目次
1. [ここまでの要件まとめ](#ここまでの要件まとめ)（直近チャットで整理した要件・対応状況）
2. [管理画面](#1-管理画面)
3. [ロス登録](#2-ロス登録)
4. [棚卸](#3-棚卸)
5. [データベース設計](#4-データベース設計)
6. [実装優先順位](#5-実装優先順位)

---

## ここまでの要件まとめ

棚卸管理画面（`/app/inventory-count`）まわりで要望された要件と、対応済み・未対応の整理。

### 対応済み

| 要件 | 内容 | 対応内容 |
|------|------|----------|
| 商品グループ作成方法 | コレクションに依存せず、グループ名＋SKUで指定したい | **コレクションから作成** / **SKU選択から作成** / **CSVで一括登録** の3方式を実装。CSVは「グループ名,SKU」行で指定可能 |
| CSVテンプレート | CSVインポート近くにテンプレートダウンロードが欲しい | 「CSVテンプレートダウンロード」ボタンを「CSVでインポート」付近に配置 |
| 上部タブのスタイル | 選択中タブだけ背景をつけたい（ライトグレー・角丸） | 商品グループ設定 / 棚卸ID発行 / 履歴のタブを `borderRadius: 8px`、選択時 `background: #e5e7eb` に統一 |
| 商品グループ作成ボタン | タブと同様の見た目にしたい | コレクションから作成 / SKU選択から作成 / CSVで一括登録を通常ボタンで実装し、選択時はグレー背景・角丸でタブと統一 |
| 編集中バナー | 背景色・はみ出し・文言を調整したい | 背景を薄グレー、枠線をグレーに変更。長文のはみ出しを防止。「（コレクションから作成）」等の接尾辞を削除し「「{グループ名}」編集中」のみ表示 |
| コレクション・SKU一覧UI | 履歴フィルターのように、絞り込み＋選択済み表示にしたい | コレクションは「コレクションで絞り込み」、SKUは全件取得＋クライアント絞り込み。いずれも「選択済み」トグルで選択済みのみ表示可能に |
| SKU検索の不具合 | 検索結果が表示されない | 初回ロードでバリアント一覧を loader 取得（最大1000件）、クライアント側で SKU・商品名・JAN・オプションで絞り込み。useFetcher 依存を廃止し表示安定化 |
| 編集中の編集が戻る | グループ編集でコレクションを外すと数秒で元に戻る | 編集中フォーム初期化の useEffect の依存を `[editingGroupId]` のみに変更し、loader 再検証で上書きされないように修正 |
| SKU/CSVグループの確認・編集 | SKU選択・CSVで作成したグループのリストを確認・編集したい | 編集クリックで「SKU選択から作成」タブに切り替え、選択済みSKUを復元。一覧外のinventoryItemIdは `editingSkuOnlyPreservedIds` で維持。右パネルに「SKU一覧（N件）を確認・編集」を表示。更新・キャンセル対応。アクション側で一覧外SKUの skus を既存グループから補完して保存。 |
| CSVダウンロード・上書き | アップロードしたものをダウンロードして再度上書きアップロードしたい | 「登録済みをCSVダウンロード」でSKU指定グループをCSV出力。インポートモードに「上書き」を追加（同じグループ名のSKUをCSVの内容で置き換え）。 |
| CSVインポートモード「新規作成」 | 既存は触れず、存在しない名前だけ新規作成したい | 選択肢「新規作成」を追加（既存のグループ名はスキップ、存在しない名前だけ新規グループ作成）。選択肢の並びは新規作成・追加・上書きの順。 |
| CSV最大行数 | 10000行まで耐えたい | 最大行数を10000行に変更。SKU解決をバッチ（25件/クエリの OR 検索）＋並列（10本）で実行。3件以下は従来の1件1クエリ。OR失敗時はそのバッチのみ1件ずつフォールバック。 |
| 2カラムレイアウトのSP対応 | PCで2カラムの画面がSPで右カラムが狭すぎる | 入出庫履歴・ロス履歴・棚卸（商品グループ設定、棚卸ID発行、履歴）で flexWrap と flex-basis を調整し、SP時は右カラムを左カラム下部に回す |
| コレクション250件以上の全件読み込み | 5000件以上のコレクションを持つショップで250件しか表示されない | loader でページネーション（first: 250, after: cursor）をループし、全件取得 |
| 商品SKU650件以上の全件読み込み | 22000件以上のSKUを持つショップで650件しか表示されない | loader で商品・バリアントをページネーション（products first: 250, variantsFirst: 250）でループし、全件取得 |
| アプリ表示件数の入力検証 | 半角数字以外（全角・スペース等）の検証が未対応 | フロント・バックエンドでサニタイズ。不正入力・範囲外時に「値を確認してください。半角数字で入力をお願いします。」を入力欄下に表示 |
| loader 読み込み中表示 | 棚卸等の重いloader実行中の表示がない | 画面上部に「読み込み中…」バナーを固定表示（useNavigation().state === 'loading'） |
| 棚卸リストのページネーション | コレクション・SKU一覧が2万件超でタブ切り替えが遅い | コレクション・SKU一覧を1000件/ページで表示。検索・絞り込み結果に対してページネーション。リスト下部に「前へ」「1-1000 / 全X件」「次へ」を配置 |
| コレクション・SKUリストの下線 | 一覧の各項目の区切りが分かりにくい | 各項目の下に `borderBottom: 1px solid #e5e7eb` の区切り線を追加。選択時は緑枠を優先し下線非表示 |
| コレクション商品選択モーダルの強化 | 1コレクションに10000SKU超があると全件表示できない・重い | `get_collection_products` APIを全件取得（ページネーション対応）に変更。モーダル内に検索枠・選択済みボタン・1000件/ページのページネーションを追加 |
| 入出庫履歴の件数表示 | 管理画面の表示ロジックをアプリ（POS）と一致させたい | 拒否分はマイナス、予定外はプラス。`receivedQuantityDisplay = receivedQuantity - rejectedQuantity + extrasQuantity` で統一。loader で shipments.totalRejectedQuantity を取得して反映 |
| 棚卸メニュー下の余白 | 上部タブ下の領域が広く感じる | タブと s-divider を1つのブロックでラップし、タブ下パディングを0に。ブロック下のみ4pxにしてメニュー下の余白を狭くした |
| 設定の破棄・保存ボタン | 少し浮いているので右寄せにしたい | `width: 100%` と `justifyContent: flex-end` で右寄せ。上下パディングを 16px→8px に変更し浮き感を軽減 |
| 入出庫履歴モーダルを棚卸UIに寄せた表示 | 複数配送時も棚卸のようにブロック分けで表示したい | Action で `groupedLineItems` を返す。モーダル上部に進捗状況（配送ごと・予定外件数）を最下部に表示。本文は配送ごとのブロック＋各ブロック内テーブル。予定外は「予定外入庫」ブロックで表示 |
| 棚卸モーダルの進捗状況の表示位置 | 入出庫と同様に情報欄の最下部にしたい | ステータス・作成日時・完了日時の後に「進捗状況」を配置。予定外がある場合は「予定外: N件」を追加 |
| 棚卸単一グループ時のブロック背景 | 単一の場合も背景色をつけたい | 単一グループ時も複数と同じブロック（padding・角丸・背景色：完了=緑系・未完了=黄系）とタイトル行で表示 |
| 棚卸の予定外を別ブロックで表示 | 入出庫と同様に予定外だけ分けて表示したい | 各グループのテーブルには通常商品のみ。全予定外を集め、一覧最後に「予定外（N件）」ブロックを追加。進捗状況にも「予定外: N件」を表示 |
| 管理画面のステータスをバッジ表示に | 入出庫・ロス・棚卸のステータスをアプリと同様バッチ表示にしたい | 一覧・モーダルでステータスをピル型バッジ（padding・角丸・ステータス別の背景色）で表示。app.history / app.loss / app.inventory-count に getStatusBadgeStyle を追加 |

### コード確認結果（2026-02-01）

上記「対応済み」および下記「未対応」について、コード上で実装有無を確認した結果です。

**実装済みと確認した項目（未対応表から除外）**

| 要件 | 確認内容 |
|------|----------|
| 設定レイアウト | `app.settings.tsx`: 左右2カラム（`flex: "1 1 360px"` / 右カラム）、項目ごとに section でブロック分け済み |
| 店舗設定UI | `app.settings.tsx`: ロケーションを履歴フィルター同様の選択式（チェック・背景色）で表示。「アプリ表示件数」は左カラム内に配置済み |
| 設定の保存・破棄ボタン | `app.settings.tsx`: 保存・破棄ボタンは画面上部（`s-scroll-box` 内の先頭）に配置済み |
| 入出庫履歴とロス履歴の統一 | `app.tsx`: ナビは「ロス履歴」表記。`app.loss.tsx`: 画面見出しは「ロス履歴」。入出庫・ロスとも左フィルター＋右一覧の同一レイアウトで統一済み |
| 履歴フィルターUI | `app.history.tsx` / `app.loss.tsx`: フィルターは左側の選択式（チェック・背景色で選択状態表示）で実装済み |
| 管理画面ロス登録履歴 | `app.loss.tsx`: ロス履歴一覧・フィルター・CSV出力・詳細モーダルが実装済み（2.5の「未実装」は古い記述） |

**完了・方針確定した項目（未対応表から除外）**

| 要件 | 状態 |
|------|------|
| 棚卸ID発行UI | **完了**（レイアウト・説明は現状でOK） |
| 履歴モーダルのデバッグ情報 | **完了**（デバッグ表示削除対応済み） |
| 履歴のページネーション | **完了**（左: 表示件数、右: 前へ・次へ。入出庫・ロス・棚卸で統一） |
| CSV1行目 | **不具合なし**（問題あれば随時対応） |
| コレクション/SKU検索 | **不具合なし**（問題あれば随時対応） |
| 一覧でのCSVまとめてダウンロード | **実装なしで進行**（入出庫履歴の一括CSVは未実装のまま） |
| 未完了グループの商品リスト読込 | **改善レベルで完了**（多少時間はかかるが許容範囲と判断） |

**未対応・今後の改善要件（必要に応じて対応）**

| 要件 | 内容・希望 | 備考 |
|------|------------|------|
| 履歴タブのCSV案内 | 「履歴タブで結果を確認・CSV出力できます」の文言・配置の見直し | 必要に応じて修正 |
| 本番前のデバッグログ | server 側の `console.log` 削除・整理 | ✅ 実施済み（2026-02） |

### 残りの進行の整理（2026-02 最終）

**完了している範囲**
- Phase 1〜4 の主要機能はすべて実装済み（管理画面・POS UI・設定・履歴・棚卸・ロス）。
- 設定レイアウト・店舗設定UI・保存・破棄ボタン（右寄せ＋余白調整）・履歴フィルターUI・入出庫とロスの表記統一・履歴件数表示（拒否分マイナス・予定外プラス）・ページネーション表示・2カラムSP対応は対応済み。
- 棚卸：上部メニュー下の余白を狭くする微調整（タブ＋区切り線を1ブロックにまとめ）・設定：破棄・保存ボタン右寄せ＋上下余白8pxで浮き感軽減を反映済み。

**今後のアクション（任意）**
1. 履歴タブのCSV案内文言・配置の見直し（必要に応じて）
2. **公開アプリリリースに向けて**: ① 更新されたコードのデプロイ ② **本番で必須の2つの対策**（RELEASE_REQUIREMENTS_PUBLIC_APP.md セクション5）：永続DB（PostgreSQL 等）の用意・DATABASE_URL 設定・マイグレーション、および「インストール後1回は管理画面でアプリを開く」旨の利用案内 ③ リスティング用アセットの準備（`docs/LISTING_ASSETS_GUIDE.md` 参照） ④ アプリの審査提出。手順は RELEASE_REQUIREMENTS_PUBLIC_APP.md および docs/LISTING_ASSETS_GUIDE.md を参照。
3. **外部DB前提の全体設計**: 永続DBを前提にしたデータ配置・移行対象の洗い出しとおすすめDB（Supabase）は **`docs/ARCHITECTURE_EXTERNAL_DB.md`** に整理済み。ロス・棚卸・仕入・発注・日次スナップ等の DB 移行は Phase に分けて実施可能。
4. **Render PostgreSQL で実装し将来 Supabase を想定する場合**: ゴールとタスク整理は **`docs/TASKS_RENDER_POSTGRES_AND_FUTURE_SUPABASE.md`** を参照（Phase A: Prisma を PostgreSQL 対応、Phase B: Render で Postgres 追加・デプロイ、Phase C: ドキュメント・将来移行手順）。

---

## 1. 管理画面構成

### 管理画面の構造
管理画面は以下の **6つのページ** に分割します（2026-02 追記）：

1. **在庫情報**: `/app/inventory-info` - 在庫高 / 在庫変動履歴（※詳細は別紙）
2. **入出庫**: `/app/history` - 入出庫の履歴管理（従来: 入出庫履歴）
3. **仕入**: `/app/purchase` - 仕入の履歴管理（新規）
4. **ロス**: `/app/loss` - ロス履歴管理（従来: ロス履歴）
5. **発注**: `/app/order` - 発注の履歴管理（新規）
6. **棚卸**: `/app/inventory-count` - 棚卸（商品グループ設定 / 棚卸ID発行 / 履歴）

**別紙（新規・検討中の要件）**:
- 在庫情報（在庫高/在庫変動履歴）: `docs/REQUIREMENTS_INVENTORY_INFO_AND_SETTINGS.md`
- 在庫変動履歴で「管理」になる要因・種別の付け方: `docs/INVENTORY_CHANGE_ACTIVITY_WHY_MANAGEMENT.md`
- 仕入/発注（POS/管理画面）: `docs/REQUIREMENTS_PURCHASE_AND_ORDER.md`

---

### 1.1 設定画面（`/app/settings` - TOP）

#### 現在の実装状況（2026-01-27更新）
- ✅ **店舗グループ（destinationGroups）設定**: 実装済み（後方互換性のため残す、非推奨）
- ✅ **配送会社（carriers）設定**: 実装済み
- ✅ **表示ロケーション選択設定**: 実装済み（`visibleLocationIds`）
- ✅ **出庫：強制キャンセル処理許可設定**: 実装済み（`outbound.allowForceCancel`）
- ✅ **入庫：過剰入庫許可設定**: 実装済み（`inbound.allowOverReceive`）
- ✅ **入庫：予定外入庫許可設定**: 実装済み（`inbound.allowExtraReceive`）
- ✅ **表示件数設定**: 実装済み
  - ✅ **履歴一覧リスト**: 出庫履歴・入庫履歴・ロス履歴に適用（`outbound.historyInitialLimit`、`inbound.listInitialLimit`）
  - ✅ **商品リスト**: 出庫・入庫・ロス登録に適用（`productList.initialLimit`）
  - ✅ **検索リスト**: 出庫・入庫・ロス登録に適用（`searchList.initialLimit`）

#### 設定画面のタブ化（2026-02 実装）
設定は棚卸画面と同じように **タブで分ける**（見つけやすくするため）。  
2026-02 時点で `/app/settings` に実装済み（`app.routes/app.settings.tsx`）。

| タブ | 内容 |
|------|------|
| ① アプリ設定 | 店舗設定（表示ロケーション等）/ アプリ表示件数設定 |
| ② 出庫設定 | 出庫設定 / 配送設定（carriers） |
| ③ 入庫設定 | 入庫設定（過剰入庫・予定外入庫の許可など） |
| ④ 仕入設定 | 仕入設定 |
| ⑤ ロス設定 | ロス区分設定（ロス理由の登録・「その他（理由入力）」表示制御） |

- **レイアウト共通ルール（PC）**: 各タブ内の設定セクションは、**左カラムにタイトル＋説明テキスト（グレー背景） / 右カラムに設定フォームを収めた白いカード**の2カラム構成に統一。
- **SPレイアウト**: 画面幅が狭い場合は `flexWrap` により、右カラム（白カード）が左カラム（タイトル＋説明）の**下**に縦積みされる。
- **適用範囲**: この「左説明 / 右白カード」パターンは、設定画面全タブに加え、入出庫履歴（`/app/history`）、ロス履歴（`/app/loss`）、棚卸（商品グループ設定 / 棚卸ID発行 / 履歴）のフィルター＋一覧レイアウトにも適用済み。
- **保存・破棄ボタンの挙動**: `/app/settings` 上部の「破棄」「保存」ボタンは、**設定値に変更がない場合はグレーアウト**し（クリック不可）、何か1つでも変更が入ったときにのみ有効化される。表示件数入力にバリデーションエラーがある場合は「保存」のみグレーアウトされ、「破棄」は常に変更前の状態へ戻せる。

**新規追加する設定（検討中）**:
- **サプライヤー設定**（仕入で選べるようにする）: `docs/REQUIREMENTS_PURCHASE_AND_ORDER.md`

**実装済み設定（2026-02-06追加）**:
- ✅ **ロス区分設定**（破損/紛失…を設定から登録）: 管理画面「ロス設定」タブで実装済み。詳細は下記「⑥ ロス区分設定」を参照。

#### 実装済み設定項目の詳細

##### ① 表示ロケーション選択設定 ✅ 実装済み
- **目的**: POS側で表示するロケーションを制限
- **データ構造**:
  ```typescript
  {
    visibleLocationIds: string[]; // 表示するロケーションIDの配列（空配列=全ロケーション表示）
  }
  ```
- **UI**: ボタンでロケーションを選択（複数選択可、選択済みは緑色で表示）
- **デフォルト**: 空配列（全ロケーション表示）
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ② 配送業者選択設定 ✅ 実装済み
- **現在の実装**: `carriers` として実装済み
- **機能**: 表示名、company、表示順の設定が可能
- **デフォルト**: 日本の配送会社（ヤマト運輸、佐川急便、日本郵便、エコ配）
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ③ 出庫：強制キャンセル処理許可設定 ✅ 実装済み
- **目的**: 出庫処理で強制キャンセル（在庫を戻す処理）を許可するかどうか
- **データ構造**:
  ```typescript
  {
    outbound: {
      allowForceCancel: boolean; // デフォルト: true（許可）
    }
  }
  ```
- **UI**: ボタンで許可/不許可を切り替え（許可時は緑色）
- **デフォルト**: `true`（許可）
- **影響範囲**: 出庫履歴画面のキャンセルボタンの表示/非表示
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ④ 入庫：過剰入庫許可設定 ✅ 実装済み
- **目的**: 予定数量を超える入庫を許可するかどうか
- **データ構造**:
  ```typescript
  {
    inbound: {
      allowOverReceive: boolean; // デフォルト: true（許可）
    }
  }
  ```
- **UI**: ボタンで許可/不許可を切り替え（許可時は緑色）
- **デフォルト**: `true`（許可）
- **影響範囲**: 入庫処理時の過剰入庫チェック
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ⑤ 入庫：予定外入庫許可設定 ✅ 実装済み
- **目的**: 予定にない商品の入庫を許可するかどうか
- **データ構造**:
  ```typescript
  {
    inbound: {
      allowExtraReceive: boolean; // デフォルト: true（許可）
    }
  }
  ```
- **UI**: ボタンで許可/不許可を切り替え（許可時は緑色）
- **デフォルト**: `true`（許可）
- **影響範囲**: 入庫処理時の予定外商品チェック
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ⑥ 表示件数設定 ✅ 実装済み
- **目的**: 各画面の初回読み込み時の表示件数を設定
- **データ構造**:
  ```typescript
  {
    outbound: {
      historyInitialLimit?: number; // 履歴一覧リスト（出庫・入庫・ロス履歴）初回件数。API上限250、推奨100
    },
    inbound: {
      listInitialLimit?: number; // 履歴一覧リスト（出庫・入庫・ロス履歴）初回件数。API上限250、推奨100
    },
    productList?: {
      initialLimit?: number; // 商品リスト（出庫・入庫・ロス登録）初回件数。lineItems上限250、推奨250
    },
    searchList?: {
      initialLimit?: number; // 検索リスト（出庫・入庫・ロス登録）初回件数。productVariants上限50、推奨50
    }
  }
  ```
- **UI**: 数値入力フィールド（履歴一覧リスト、商品リスト、検索リスト）。半角数字以外（全角・スペース等）は検証し、入力欄下に「値を確認してください。半角数字で入力をお願いします。」を表示（2026-02追加）
- **デフォルト**: 
  - 履歴一覧リスト: 100件
  - 商品リスト: 250件
  - 検索リスト: 50件
- **影響範囲**: 
  - 履歴一覧リスト: 出庫履歴・入庫履歴・ロス履歴の一覧表示
  - 商品リスト: 出庫・入庫・ロス登録の商品リスト表示
  - 検索リスト: 出庫・入庫・ロス登録の検索結果表示
- **実装ファイル**: `/app/routes/app.settings.tsx`

##### ⑦ ロス区分設定 ✅ 実装済み（2026-02-06）
- **目的**: POSロス登録画面で選択できるロス理由（破損・紛失など）を管理画面から登録・編集可能にする
- **データ構造**:
  ```typescript
  {
    lossReasons?: LossReasonOption[]; // ロス区分設定（破損/紛失 など）
    loss?: {
      allowCustomReason?: boolean; // 「その他（理由入力）」を表示するかどうか（デフォルト: true）
    };
  }
  type LossReasonOption = {
    id: string;
    label: string; // ロス区分名（例：破損、紛失）
    sortOrder?: number; // 表示順（小さい順、デフォルト: 999）
  };
  ```
- **UI**: 
  - ロス設定タブ右カードで、ロス区分の一覧・追加・編集・削除・並び替えが可能
  - デフォルトで「破損」「紛失」の2区分を自動設定
  - 「その他（理由入力）」の表示/非表示をラジオボタンで制御（見出し：「その他（理由入力）」を表示、選択肢：「表示する」「表示しない」）
- **デフォルト**: 
  - `lossReasons`: `[{ id: "damage", label: "破損" }, { id: "lost", label: "紛失" }]`
  - `loss.allowCustomReason`: `true`（表示する）
- **影響範囲**: 
  - POSロスコンディション画面（`LossConditions.jsx`）で、設定から読み込んだ `lossReasons` を理由ボタンとして表示
  - 「その他」が許可されている場合は「その他」ボタン＋テキスト入力欄を表示
- **実装ファイル**: `/app/routes/app.settings.tsx`（ロス設定タブ）、`extensions/stock-transfer-loss/src/screens/loss/LossConditions.jsx`（設定読み込み＋動的ボタン生成）

##### ⑧ 仕入設定：「その他（仕入先入力）」表示制御 ✅ 実装済み（2026-02-06）
- **目的**: POS仕入・発注画面で「その他（仕入先入力）」ボタンと入力欄を表示するかどうかを制御
- **データ構造**:
  ```typescript
  {
    purchase?: {
      allowCustomSupplier?: boolean; // 「その他（仕入先入力）」を表示するかどうか（デフォルト: true）
    };
  }
  ```
- **UI**: 仕入設定タブ右カードの先頭に、「その他（仕入先入力）」の表示/非表示をラジオボタンで制御（見出し：「その他（仕入先入力）」の表示、選択肢：「表示する」「表示しない」）
- **デフォルト**: `true`（表示する）
- **影響範囲**: 
  - POS仕入コンディション画面（`PurchaseConditions.jsx`）で、設定に応じて「その他」ボタンと入力欄を表示/非表示
  - POS発注コンディション画面（`OrderConditions.jsx`）でも同じ設定を参照
- **実装ファイル**: `/app/routes/app.settings.tsx`（仕入設定タブ）、`extensions/stock-transfer-purchase/src/screens/purchase/PurchaseConditions.jsx`・`extensions/stock-transfer-order/src/screens/order/OrderConditions.jsx`（設定に応じた表示制御）

##### ⑨ 出庫設定：「その他（配送会社入力）」表示制御 ✅ 実装済み（2026-02-06、フラグ先行）
- **目的**: POS出庫画面で「その他（配送会社入力）」ボタンと入力欄を表示するかどうかを制御（将来の実装に向けたフラグ先行）
- **データ構造**:
  ```typescript
  {
    outbound?: {
      allowCustomCarrier?: boolean; // 「その他（配送会社入力）」を表示するかどうか（デフォルト: true）
    };
  }
  ```
- **UI**: 出庫設定タブ「配送設定」右カードの先頭に、「その他（配送会社入力）」の表示/非表示をラジオボタンで制御（見出し：「その他（配送会社入力）」の表示、選択肢：「表示する」「表示しない」）
- **デフォルト**: `true`（表示する）
- **影響範囲**: 将来のPOS出庫画面での「その他（配送会社入力）」実装時に使用予定
- **実装ファイル**: `/app/routes/app.settings.tsx`（出庫設定タブ）

#### 設定データの保存先
- **現在**: `currentAppInstallation.metafield` (namespace: `stock_transfer_pos`, key: `settings_v1`)
- **拡張**: 既存の `SettingsV1` 型を拡張して保存

#### 実装ファイル
- `/app/routes/app.settings.tsx` を拡張（基本的な設定項目のみ）

---

### 1.2 入出庫履歴管理画面（新規作成: `/app/history`）

#### 実装状況
- ✅ **履歴一覧表示**: 実装済み（出庫・入庫を統合表示）
- ✅ **フィルター機能**: 実装済み（出庫ロケーション、入庫ロケーション、ステータス - 複数選択対応）
- ✅ **ページネーション**: 実装済み（次へ/前へボタン、ページ表示）
- ✅ **モーダル表示**: 実装済み（履歴クリックで商品リストをモーダル表示）
- ✅ **CSV出力**: 実装済み（モーダルから個別CSV出力）
- ✅ **予定数/入庫数表示**: 実装済み（予定数と入庫数を分けて表示）
- ✅ **予定外入庫表示**: 実装済み（メモから抽出、薄い赤背景で表示）
- ✅ **予定外入庫を含めた数量**: 実装済み（一覧表示の数量に予定外入庫を含める）
- ✅ **予定外入庫の件数表示**: 実装済み（一覧の状態横に「（予定外: X件）」を表示）
- ⏸️ **一括CSV出力**: 調整中（一時的に非表示、チェックボックス機能も非表示）
- ❌ **詳細ページ**: 不要と判断（モーダルで代替）

#### 機能概要
- 出庫・入庫履歴をID毎に確認
- 全ロケーション＋フィルター可能
- モーダルから個別CSV出力
- 予定外入庫の表示と数量計算

#### 画面構成

##### ① 履歴一覧画面
- **表示項目**:
  - 履歴ID（Transfer ID）
  - 名称
  - 出庫元 / 入庫先（改行表示）
  - 日付
  - ステータス（予定外入庫がある場合は「（予定外: X件）」を表示）
  - 数量（入庫数/予定数、予定外入庫を含む）
- **フィルター機能**:
  - 出庫ロケーションフィルター（複数選択可）
  - 入庫ロケーションフィルター（複数選択可）
  - ステータスフィルター（複数選択可）
- **ページネーション**:
  - 次へ/前へボタン
  - ページ表示（1/2形式）
  - 表示件数/全件数表示
- **CSV出力機能**:
  - ⏸️ 一括CSV出力: 調整中（一時的に非表示）
  - ✅ モーダルから個別CSV出力: 実装済み

##### ② 商品リストモーダル
- **表示項目**:
  - 履歴情報（履歴ID、名称、日付、出庫元、入庫先、**配送業者**、**配送番号**、**予定日**（2026-02追加・入庫先とステータスの間）、ステータス【バッジ表示】、数量、**進捗状況**（情報欄最下部・各配送の入庫済み/未入庫・予定外入庫件数））
  - 商品リストは**配送ごとのブロック**表示（棚卸の商品グループブロックと同様）。各ブロックにタイトル行（配送ID＋ステータス）＋その配送の明細テーブル（配送ID・配送ステータス列は省略）。予定外は「予定外入庫」ブロックで最後に表示。
  - 予定外入庫は薄い赤背景で表示（ブロック全体も薄い赤系）
- **CSV出力機能**:
  - 表示している商品リストをCSVでダウンロード（従来どおりフラット形式・配送ID・配送ステータス列あり）
  - CSV形式: 履歴ID, 名称, 日付, 出庫元, 入庫先, ステータス, 配送ID, 配送ステータス, 商品名, SKU, JAN, オプション1-3, 予定数, 入庫数, 種別

#### データ取得方法
- **出庫履歴**: `inventoryTransfers` GraphQLクエリ（出庫元ロケーションでフィルター）
- **入庫履歴**: `inventoryTransfers` GraphQLクエリ（入庫先ロケーションでフィルター）
- **監査ログ**: 既存の `readInboundAuditLog()` を使用（入庫履歴の詳細情報取得）

#### 実装ファイル
- 新規作成: `/app/routes/app.history.tsx`
- 必要に応じて: `/app/routes/app.history.$id.tsx`（詳細画面）

---

### 1.3 ロス登録履歴管理画面（新規作成: `/app/loss`）

#### 機能概要
- ロス登録履歴をID毎に確認
- 全ロケーション＋フィルター可能
- 選択した履歴をCSV出力
- 詳細確認時は表示詳細のCSV出力

#### 画面構成

##### ① 履歴一覧画面
- **表示項目**:
  - チェックボックス（選択用）
  - ロス登録ID
  - ロケーション
  - 日付
  - 理由
  - 商品数
  - 数量サマリー（合計ロス数量）
  - ステータス（登録済み / キャンセル済み）
- **フィルター機能**:
  - ロケーションフィルター（全ロケーション / 特定ロケーション）
  - 日付範囲フィルター（開始日 / 終了日）
  - 理由フィルター（破損 / 紛失 / その他 / カスタム）
  - ステータスフィルター（登録済み / キャンセル済み）
- **CSV出力機能**:
  - チェックボックスで選択した履歴をCSVでダウンロード
  - CSV形式: ロス登録ID, ロケーション, 日付, 理由, 商品数, 数量サマリー, ステータス

##### ② 履歴詳細画面
- **表示項目**:
  - ロス登録ID
  - ロケーション
  - 日付
  - 理由
  - 商品明細（商品名, SKU, 数量等）
  - ステータス
- **CSV出力機能**:
  - 表示している詳細情報をCSVでダウンロード
  - CSV形式: 商品名, SKU, 数量等

#### 実装ファイル
- 新規作成: `/app/routes/app.loss.tsx`
- 必要に応じて: `/app/routes/app.loss.$id.tsx`（詳細画面）

---

## 2. ロス登録（POS UI機能）✅ 実装完了（2026-01-27更新）

**実装状況**: POS UI機能は実装完了。商品リスト画面の初期化エラーは修正完了。管理画面（履歴管理・CSV出力）も実装完了。

### 2.1 機能概要
- 出庫処理のロス（在庫マイナス調整）版
- コンディション画面でロケーション、日付、理由、スタッフ名を選択入力
- ロス登録リストから対象ロケーションの履歴確認（現在のロケーションで自動フィルター）
- 商品リスト画面は出庫商品リストと完全に同じUI/UX、確定で選択SKUと数量の差分調整

### 2.2 実装状況（2026-01-27更新・機能検証完了）
- ✅ **コンディション画面**: 実装完了（`LossConditions.jsx`）
  - ✅ 自動保存・復元機能: 実装完了（入力値変更時に500msデバウンスで自動保存、確定時にクリア）
  - ✅ 復元時に「下書きを復元しました」トーストを表示
  - ✅ 商品リストに進む時点では下書きをクリアしない（確定時のみクリア）
  - ✅ 商品リストから戻った時に下書きを復元
- ✅ **商品リスト画面**: 実装完了（`LossProductList.jsx`）- **エラー修正完了・機能検証完了**
  - ✅ スキャナー処理を`Modal.jsx`に移動、出庫/入庫と同じ実装に統一
  - ✅ 設定から検索リストの表示件数を読み込むように修正
  - ✅ 自動保存・復元機能: 実装完了
  - ✅ 確定時にコンディション画面の下書きもクリア
- ✅ **履歴一覧画面**: 実装完了（`LossHistoryList.jsx`）
- ✅ **キャンセル機能**: 実装完了（`LossHistoryList.jsx`内で実装、在庫を戻す処理も含む）
- ✅ **データ保存**: 実装完了（Metafield方式、`loss_entries_v1`）
- ✅ **在庫調整**: 実装完了（`inventoryAdjustQuantity` GraphQL mutation）

### 2.3 画面構成

#### ① コンディション画面（ロス登録開始画面）✅ 実装完了
- **入力項目**:
  - ✅ ロケーション選択（必須、セッションのロケーションをデフォルト選択）
  - ✅ 日付選択（必須、デフォルト: 今日）
  - ✅ 理由選択（必須、**管理画面のロス設定から読み込んだ区分を動的に表示**）
    - ✅ デフォルトで「破損」「紛失」の2区分を設定から取得
    - ✅ 設定で追加した区分もボタンとして表示（横並びで均等に表示）
    - ✅ 「その他（理由入力）」は設定の `loss.allowCustomReason` が `true` のときのみ表示
    - ✅ 「その他」選択時はテキスト入力欄を表示（必須）
  - ✅ スタッフ名入力（必須、手入力）
- **機能**:
  - ✅ 「次へ」ボタンで商品リスト画面へ遷移
  - ✅ 「履歴一覧」ボタンで履歴一覧画面へ遷移
  - ✅ 自動保存機能: 入力値変更時に500msデバウンスで自動保存
  - ✅ 下書き復元機能: マウント時に下書きを復元、復元時に「下書きを復元しました」トーストを表示
  - ✅ 商品リストに進む時点では下書きをクリアしない（確定時のみクリア）
  - ✅ 商品リストから戻った時に下書きを復元（コンポーネント再マウント）
  - ✅ **設定読み込み**: `fetchSettings()` で `lossReasons` と `loss.allowCustomReason` を取得し、理由ボタンを動的生成（2026-02-06追加）
- **実装ファイル**: `/extensions/stock-transfer-loss/src/screens/loss/LossConditions.jsx`、`lossApi.js`（`fetchSettings()`）

#### ② 商品リスト画面 ✅ 実装完了（機能検証完了）
- **表示**: 出庫商品リストと完全に同じUI/UX
  - ✅ 検索フィールド（商品名 / SKU / バーコード）
  - ✅ 検索結果リスト（OutboundListと同じデザイン）
  - ✅ 追加済み商品リスト（OutboundListと同じデザイン）
  - ✅ 数量コントロール（OutboundListと同じUI）
  - ✅ 「さらに表示」ボタン（検索結果が50件以上の場合）
- **機能**:
  - ✅ 商品スキャンまたは手動選択
  - ✅ 数量入力（マイナス調整用）
  - ✅ 確定ボタンで確認モーダルを表示（OutboundListと同じ仕様）
  - ✅ 確認モーダルで確定すると在庫調整を実行
- **在庫調整処理**:
  - ✅ `inventoryAdjustQuantity` GraphQL mutationを使用
  - ✅ 数量はマイナス値として処理（例: ロス5個 → -5で調整）
- **修正内容（2026-01-27）**:
  - ✅ スキャナー処理を`Modal.jsx`に移動、出庫/入庫と同じ実装に統一
  - ✅ エラー解消完了
  - ✅ 設定から検索リストの表示件数を読み込むように修正
  - ✅ 確定時にコンディション画面の下書きもクリア
- **実装ファイル**: `/extensions/stock-transfer-loss/src/screens/loss/LossProductList.jsx`

#### ③ ロス登録リスト画面 ✅ 実装済み
- **表示項目**:
  - ✅ ロス登録ID（自動生成: `loss_${timestamp}_${random}`）
  - ✅ ロケーション
  - ✅ 日付
  - ✅ 理由
  - ✅ スタッフ名
  - ✅ 商品数
  - ✅ 数量サマリー（合計ロス数量）
  - ✅ ステータス（登録済み / キャンセル済み）
- **機能**:
  - ✅ 現在のロケーションで自動フィルター（フィルターUIは削除済み）
  - ✅ 詳細確認（商品明細表示）
  - ✅ キャンセル機能（実装済み、在庫を戻す処理も含む）
- **実装ファイル**: `/extensions/stock-transfer-loss/src/screens/loss/LossHistoryList.jsx`

### 2.4 データ保存 ✅ 実装済み

#### データ構造
```typescript
type LossEntry = {
  id: string; // ロス登録ID（自動生成: loss_${timestamp}_${random}）
  locationId: string; // ロケーションID
  locationName: string; // ロケーション名
  date: string; // ISO日付文字列（YYYY-MM-DD形式）
  reason: string; // 理由（破損 / 紛失 / その他 / カスタム入力）
  staffMemberId: string | null; // スタッフID（現在は使用しない、null）
  staffName: string | null; // スタッフ名（手入力）
  items: Array<{
    inventoryItemId: string;
    variantId: string;
    sku: string;
    title: string;
    quantity: number; // ロス数量（正の値で保存、調整時はマイナスで処理）
  }>;
  status: "active" | "cancelled"; // ステータス（現在は "active" のみ）
  createdAt: string; // 作成日時（ISO）
  cancelledAt?: string; // キャンセル日時（ISO、未実装）
};
```

#### 保存先 ✅ 実装済み
- **実装方法**: `currentAppInstallation.metafield` にJSON配列として保存
  - namespace: `stock_transfer_pos`
  - key: `loss_entries_v1`
- **実装ファイル**: `/extensions/stock-transfer-loss/src/screens/loss/lossApi.js`
  - `readLossEntries()`: ロス登録履歴を読み取り
  - `writeLossEntries()`: ロス登録履歴を書き込み

### 2.5 実装ファイル ✅ 実装済み
- ✅ POS UI: `/extensions/stock-transfer-loss/src/screens/loss/` に実装
  - `LossConditions.jsx`: コンディション画面
  - `LossProductList.jsx`: 商品リスト画面
  - `LossHistoryList.jsx`: 履歴一覧画面
  - `lossApi.js`: API関数（検索、在庫調整、データ保存）
  - `FixedFooterNavBar.jsx`: フッターナビゲーション（出庫処理から移植）
- ✅ 管理画面: `/app/routes/app.loss.tsx` - **実装済み**（ロス履歴一覧・フィルター・CSV・詳細モーダル、2026-02 コード確認）

### 2.6 修正履歴（2026-01-27更新）

#### 問題1: 商品リスト画面の初期化エラー ✅ 解決完了
- **発生タイミング**: コンディション画面から「次へ」を押した瞬間
- **エラーメッセージ**: `undefined is not an object (evaluating 'Object.prototype.hasOwnProperty.call(e,t)')`
- **根本原因**: スキャナー処理の実装場所の違い（出庫/入庫は`Modal.jsx`でタイルを開いた時点で開始、ロス登録は`LossProductList`内で開始）
- **最終修正（2026-01-27）**:
  1. ✅ `Modal.jsx`にscanner subscribeを追加（出庫/入庫と同じ実装）
  2. ✅ `LossScreen`からviewを親に通知する仕組みを追加
  3. ✅ `LossProductList`内のscanner subscribeを削除
  4. ✅ `pushScanToQueue_`を`Modal.jsx`に移動
  5. ✅ `normalizeScanQueueObj_`を出庫/入庫と同じ実装に修正（`if (raw && typeof raw === "object")`）
- **修正結果**: ✅ 完了（エラー解消確認済み）

#### 追加実装（2026-01-27）
- ✅ ロスコンディション画面の自動保存・復元機能を実装（500msデバウンス）
  - ✅ 復元時に「下書きを復元しました」トーストを表示
  - ✅ 商品リストに進む時点では下書きをクリアしない（確定時のみクリア）
  - ✅ 商品リストから戻った時に下書きを復元（コンポーネント再マウント）
- ✅ 出庫コンディション画面にも自動保存・復元機能を実装（ロス登録と同様）
  - ✅ 復元時に「下書きを復元しました」トーストを表示
  - ✅ 商品リストに進む時点では下書きをクリアしない（確定時のみクリア）
- ✅ モーダルの「キャンセル」を「戻る」に修正（ロス登録のリセット確認モーダル）
- ✅ 設定から検索リストの表示件数を読み込むように修正
- ✅ スキャナーのトースト整理
  - ✅ `scanner subscribe start`のトーストを削除（出庫/入庫、ロス登録の両方）
  - ✅ `env: toast=... scanner=...`のデバッグ用トーストを削除
  - ✅ `SCAN: ${data} (${source})`のトーストは残す（スキャン確認用）
- ✅ 配送番号のスキャン機能を実装
  - ✅ 出庫コンディション画面でスキャンした際に配送番号に自動入力
  - ✅ 確定モーダル内でもスキャン可能（モーダルが開いている時は配送番号に自動入力）
  - ✅ ラベルを「配送番号（任意）※スキャン可能」に変更

---

## 3. 棚卸 ✅ 実装完了（2026-01-27更新）

**実装状況**: 管理画面は実装完了。POS UI機能も実装完了（UI改善・バグ修正完了）。

### 3.1 機能概要
- 棚卸の指定された商品をPOS UIから実数のスキャン・入力処理
- 在庫絶対値処理（現在の在庫数を実数に更新）
- 入庫機能の棚卸版として実装（UI/UXを模倣）

### 3.2 管理画面での設定と履歴管理（`/app/inventory-count`）

#### ① 対象商品グループ設定（カテゴリ設定）✅ 実装完了（2026-01更新）

- **画面**: `/app/inventory-count` の「商品グループ設定」タブ
- **UIレイアウト**: ✅ 二分割レイアウト
  - **左側（約300px固定幅）**: グループ名入力 + 「グループを追加する」ボタン + 作成方法タブ（コレクションから作成 / SKU選択から作成 / CSVで一括登録）＋ 編集モード時のフォーム
  - **右側（残りの幅）**: 登録済み商品グループのリスト（各グループにコレクション/SKU/CSV由来の内容と商品数量を表示）
- **商品の選択方法（3方式）**:
  - **方法1: コレクションから作成** ✅ 実装済み
    - Shopifyコレクションから選択（複数選択可）。ラベル「コレクションで絞り込み」、クライアント側絞り込み。「選択済み」トグルで選択済みコレクションのみ表示可能。
    - 1000件/ページで表示、リスト下部にページネーション（前へ/次へ）を配置（2026-02追加）。
    - コレクション内商品の個別選択: モーダルでデフォルト全選択、チェックで対象外に可能。コレクション名横に「選択数 / 合計数」表示。モーダル内に検索枠・選択済みボタン・1000件/ページのページネーションを追加（10000SKU超のコレクション対応、2026-02追加）。
    - 右側のコレクション名クリックで直接編集可能。
  - **方法2: SKU選択から作成** ✅ 実装済み
    - ページネーションで全商品・全バリアントを loader 取得（250件以上のショップ対応）。クライアントで SKU・商品名・JAN・オプションにて絞り込み。「選択済み」トグルで選択済みSKUのみ表示可能。
    - 表示形式: 商品名 / SKU / JAN / オプション（4行）。1000件/ページで表示、「表示: 1-1000件 / 全Y件」形式。リスト下部にページネーション（前へ/次へ）を配置（2026-02追加）。
  - **方法3: CSVで一括登録** ✅ 実装済み
    - CSV形式: `グループ名,SKU` の行で指定。コレクションに依存せずグループ名＋SKUで商品グループを定義可能。
    - 「CSVテンプレートダウンロード」でテンプレートをダウンロード。「CSVでインポート」で一括登録。
    - **登録済みをCSVダウンロード**: SKU指定のグループのみをCSV出力。編集して再アップロード可能。
    - **インポートモード**: 新規作成（既存のグループ名はスキップ）・追加（同じグループ名にSKUを足す）・上書き（同じグループ名のSKUをCSVの内容で置き換え）。選択肢の並びは新規作成・追加・上書き。
    - **行数**: 1ファイル最大10000行。SKU解決はバッチ（25件/クエリの OR 検索）＋並列10本で実行し、タイムアウトを抑制。
- **タブ・ボタンスタイル**: 上部タブ（商品グループ設定 / 棚卸ID発行 / 履歴）および作成方法ボタンは、選択時のみ `background: #e5e7eb`、`borderRadius: 8px` で統一。
- **リスト項目の下線**: コレクション・SKU一覧の各項目の下に `borderBottom: 1px solid #e5e7eb` の区切り線を追加。選択時は緑枠を優先し下線非表示（2026-02追加）。
- **編集中バナー**: 「「{グループ名}」編集中」のみ表示。背景・枠は薄グレー。長文のはみ出し防止のスタイル適用。
- **編集中のリセット不具合**: 編集フォーム初期化の useEffect 依存を `[editingGroupId]` のみにし、loader 再検証で編集中内容が上書きされないよう修正済み。
- **データ構造**:
  ```typescript
  type CollectionConfig = {
    collectionId: string; // コレクションID
    selectedVariantIds: string[]; // 選択されたバリアントIDの配列（空配列=全選択）
    totalVariantCount?: number; // コレクション内の全バリアント数（0/0表示用）
  };

  type ProductGroup = {
    id: string; // グループID（自動生成）
    name: string; // グループ名（カテゴリ名）
    collectionIds: string[]; // ShopifyコレクションIDの配列（後方互換性のため残す）
    collectionConfigs?: CollectionConfig[]; // コレクションごとの選択商品設定
    productIds?: string[]; // 直接指定する商品ID（オプション）
    variantIds?: string[]; // 直接指定するバリアントID（SKU選択・CSVで一括登録時に使用）
    inventoryItemIds?: string[]; // 商品グループに含まれるinventoryItemIdのリスト（判定用に保存）
    createdAt: string; // 作成日時（ISO）
  };
  ```
  - **CSV一括登録**: 取り込み後は `variantIds` / `inventoryItemIds` 等に展開して保存。フォーマットは「グループ名,SKU」行。

#### ② 棚卸ID発行処理 ✅ 実装完了（2026-01-27更新）
- **画面**: `/app/inventory-count` の「棚卸ID発行」セクション
- **機能**:
  - ✅ ロケーション選択（必須、検索機能付き、空白で全ロケーション表示）
  - ✅ 対象商品グループ選択（必須、複数選択可、チェックボックス形式）
  - ✅ 「棚卸ID発行」ボタンで棚卸IDを生成
  - ✅ 棚卸ID表示形式: `#C0000`形式（ロス登録の`#L0000`と同様）
- **データ構造**:
  ```typescript
  type InventoryCount = {
    id: string; // 棚卸ID（自動生成: count_${timestamp}_${random}）
    countName?: string; // 表示用名称（#C0000形式）
    locationId: string; // ロケーションID
    locationName?: string; // ロケーション名
    productGroupId?: string; // 商品グループID（後方互換性のため残す）
    productGroupIds: string[]; // 商品グループIDの配列（複数選択対応）
    productGroupName?: string; // 後方互換性のため残す
    productGroupNames?: string[]; // 商品グループ名の配列
    inventoryItemIdsByGroup?: Record<string, string[]>; // ✅ 商品グループごとのinventoryItemIds（生成時の状態を保持、2026-01-27追加）
    status: "draft" | "in_progress" | "completed" | "cancelled";
    createdAt: string; // 作成日時（ISO）
    completedAt?: string; // 完了日時（ISO）
    groupItems?: Record<string, Array<{
      inventoryItemId: string;
      variantId?: string;
      sku?: string;
      title?: string;
      currentQuantity?: number; // 現在の在庫数
      actualQuantity?: number; // 実数
      delta?: number; // 差分（actualQuantity - currentQuantity）
    }>>; // 商品グループごとの完了データ（key: productGroupId）
    items?: Array<{
      inventoryItemId: string;
      variantId?: string;
      sku?: string;
      title?: string;
      currentQuantity?: number; // 現在の在庫数
      actualQuantity?: number; // 実数
      delta?: number; // 差分（actualQuantity - currentQuantity）
    }>; // 後方互換性のため残す（最後に完了したグループのデータ）
  };
  ```
- **注意**: 
  - `productGroupId`（単数）から`productGroupIds`（複数）に変更
  - **複数グループ対応**: `groupItems`でグループごとの完了データを管理、全グループ完了時のみ`status: "completed"`に設定
  - ✅ **商品グループ編集の影響を受けないようにする**: 棚卸ID生成時に`inventoryItemIdsByGroup`を保存し、POS UI側で商品リストを取得する際は保存された`inventoryItemIdsByGroup`を優先的に使用（2026-01-27追加）
    - これにより、商品グループを編集しても、既に生成済みの棚卸IDには影響しない
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

#### ③ 棚卸履歴表示
- **画面**: `/app/inventory-count` の「履歴」タブまたはセクション
- **表示項目**: 
  - チェックボックス（選択用）
  - 棚卸ID
  - ロケーション
  - 商品グループ（複数選択時は「グループ1, グループ2...」形式で表示）
  - ステータス（draft / in_progress / completed / cancelled）
  - 作成日時
  - 完了日時
- **フィルター機能**: 
  - ロケーションフィルター（全ロケーション / 特定ロケーション）
  - 商品グループフィルター
  - ステータスフィルター
  - 日付範囲フィルター（開始日 / 終了日）
- **CSV出力機能**: 
  - チェックボックスで選択した棚卸履歴をCSVでダウンロード
  - 詳細画面からも詳細情報をCSV出力可能
  - CSV形式: 棚卸ID, ロケーション, 商品グループ, ステータス, 作成日時, 完了日時, 商品明細（商品名, SKU, 現在在庫数, 実数, 差分等）

### 3.3 POS UIでの処理

#### 画面遷移フロー
```
棚卸ID入力画面（コンディション相当）
  ↓
商品グループ選択画面（シップメント選択相当、商品グループが複数の場合のみ）
  ↓
商品リスト画面（入庫商品リスト相当）
  ↓
確定処理（在庫絶対値調整）
```

#### ① 棚卸ID入力画面（コンディション画面相当）✅ 実装完了
- **機能**: 
  - ✅ 棚卸ID一覧を表示（未完了/完了済みタブ）
  - ✅ 棚卸IDが存在し、ステータスが `draft` または `in_progress` であることを確認
  - ✅ 商品グループが1つの場合は直接商品リストへ、複数の場合は商品グループ選択画面へ
  - ✅ 選択時にステータスを`in_progress`に更新（`draft`の場合のみ）
- **UI**: 入庫のコンディション画面（入庫ID一覧）と同じUI/UX
  - ✅ 棚卸ID表示形式: `#C0000`形式（既存データにも自動付与）
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountConditions.jsx`

#### ② 商品グループ選択画面（シップメント選択画面相当）✅ 実装完了（2026-01-27更新）
- **表示条件**: 棚卸IDに紐づく商品グループが複数の場合のみ表示
- **機能**: 
  - ✅ 商品グループ一覧を表示（入庫のシップメント選択画面と同じUI/UX）
  - ✅ 商品グループごとに状態（未処理/処理中/処理済み）と数量進捗（実数/在庫数）を表示
  - ✅ 商品グループを選択して商品リスト画面へ遷移
  - ✅ 選択時にステータスを`in_progress`に更新（`draft`の場合のみ）
  - ✅ **完了済みグループの判定**: `groupItems[productGroupId]`が存在するか、または`count.status === "completed"`の場合、`readOnly`モードで表示
  - ⏸️ 「まとめて表示」オプション（管理画面で設定可能な場合、デフォルト動作を設定、将来拡張）
- **スキップ条件**: 商品グループが1つの場合は自動で商品リスト画面へ遷移
- **管理画面設定（将来拡張）**: 
  - 商品グループが複数の場合のデフォルト動作を設定可能に
  - 選択肢: 「リスト選択（個別選択）」「まとめて表示（全グループの商品を1画面で表示）」
  - 入庫処理にも同様の設定を追加（シップメントが複数の場合のデフォルト動作）
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountProductGroupSelection.jsx`

#### ③ 商品リスト画面（入庫商品リスト相当）✅ 実装完了
- **表示**: 
  - ✅ 選択した商品グループ（カテゴリ）に含まれる商品リスト
  - ✅ **重要**: 対象ロケーションに在庫レベルがないSKUは初期表示では非表示
  - ✅ スキャンや検索入力で該当商品が見つかった場合は、リストに追加して有効化（表示・編集可能）して処理できる
- **機能**:
  - ✅ 商品をスキャンまたは手動選択（検索機能、VariantCache活用）
  - ✅ 実数を入力（初期値は0、スキャンで積み上げる方式）
  - ✅ 「データ数量反映」ボタン: 現在在庫数を実数に一括反映
  - ✅ 「リセット」ボタン: 実数を0にリセット
  - ✅ 確定ボタンで確認モーダルを表示（入庫の確定モーダルを参考）
  - ✅ 確認モーダルで確定すると在庫調整を実行
  - ✅ 在庫レベルがないSKUもスキャン/検索で追加可能
- **在庫調整処理**:
  - ✅ `inventorySetQuantities` GraphQL mutationを使用（ロス登録と同じ処理方法）
  - ✅ **絶対値処理**: 現在の在庫数に関係なく、入力した実数に在庫を設定
  - ✅ 例: 現在10個、実数8個 → 在庫を8個に設定
  - ✅ 例: 現在5個、実数10個 → 在庫を10個に設定
- **UI**: 入庫商品リスト画面と完全に同じUI/UX
  - ✅ 軽量モードボタン（ヘッダー右側、「軽量」のみ表示、色でON/OFF表現）
  - ✅ ヘッダーに「在庫更新」「全数量反映」「リセット」ボタン
  - ✅ フッターに「在庫 / 実数」表示（ボタンと上下中央揃え）
  - ✅ フッターに「超過 / 不足」表示（差分がある場合は赤色表示）
  - ✅ 予定外リスト表示（初期リストにない商品を最下部に別表示、数量1の場合は×ボタンで削除可能）
- **自動保存・復元機能**: ✅ 実装完了
  - ✅ 下書きの自動保存（lines変更時に300msデバウンスで保存）
  - ✅ 下書きの復元（マウント時に下書きを確認、条件一致時のみ復元）
  - ✅ 確定時に下書きをクリア
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### ④ 棚卸完了処理 ✅ 実装完了（2026-01-27更新）
- **機能**: 全ての商品の実数入力が完了したら「確定」ボタンで確認モーダルを表示
- **確認モーダル**: 
  - ✅ 入庫の確定モーダルを参考に実装
  - ✅ サマリー表示（在庫 / 実数 / 差分）
  - ✅ 調整対象の明細表示（1件のみ表示、「…他X件」形式）
  - ✅ 「戻る」ボタンと「確定する」ボタン
  - ✅ 空白ボタン問題を修正（slot="footer"を明示的に空にする）
- **処理**: 
  - ✅ 在庫調整を実行（`inventorySetQuantities`で絶対値設定、ロス登録と同じ方法）
  - ✅ 在庫調整と履歴更新を分離し、エラーハンドリングを改善（HTTP 400エラー修正）
  - ✅ **複数グループ対応**: `groupItems[productGroupId]`にグループごとの完了データを保存
  - ✅ **完了判定の修正**: 全`productGroupIds`の`groupItems[id]`が存在し、かつ配列の長さが0より大きい場合のみ`status: "completed"`に設定
  - ✅ 下書きをクリア
- **完了済み商品リストの編集不可対応** ✅ 実装完了（2026-01-27）
  - ✅ `readOnly`モード: `count.status === "completed"`または`groupItems[productGroupId]`が存在する場合、編集不可
  - ✅ 編集不可時の挙動: 商品追加・数量変更・削除を禁止、在庫更新・全数量反映・リセット・確定ボタンを無効化
  - ✅ 完了済みグループタップ時のフリーズ修正: `groupItems`から直接読み込み、API取得をスキップ

### 3.4 データ保存

#### 保存先
- **商品グループ**: `currentAppInstallation.metafield` (namespace: `stock_transfer_pos`, key: `product_groups_v1`)
- **棚卸ID**: `currentAppInstallation.metafield` (namespace: `stock_transfer_pos`, key: `inventory_counts_v1`)

### 3.5 実装ファイル ✅ 実装完了
- ✅ **管理画面**: `/app/routes/app.inventory-count.tsx`（設定・履歴・CSV出力を含む）
- ✅ **POS UI**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/` に実装
  - `InventoryCountConditions.jsx`: 棚卸ID入力画面
  - `InventoryCountProductGroupSelection.jsx`: 商品グループ選択画面
  - `InventoryCountList.jsx`: 商品リスト画面
  - `stocktakeApi.js`: API関数（商品検索、在庫調整、データ保存、VariantCache）
  - `StocktakeScreen.jsx`: 画面ルーター
- ✅ **エントリポイント**: 4分割後は棚卸は独立拡張（stock-transfer-stocktake）。`/extensions/stock-transfer-stocktake/src/Modal.jsx` がタイルのモーダル。タイルを開くと棚卸ID入力（コンディション相当）画面を表示。
  - ✅ 軽量モードボタンを追加（コンディション画面、商品リスト画面）
  - ✅ スキャナー処理を実装（出庫/入庫と同じ方式）

### 3.7 入庫処理UIの流用（実装時の参考）

棚卸機能のPOS UIは、入庫（受領）処理のUIをそのまま流用します。以下の対応関係で実装します：

#### 画面構成の対応関係

| 入庫処理（既存） | 棚卸処理（新規） | 説明 |
|----------------|----------------|------|
| `InboundConditions` | `InventoryCountConditions` | 棚卸ID入力画面（コンディション画面相当） |
| `InboundShipmentSelection` | `InventoryCountProductGroupSelection` | 商品グループ選択画面（シップメント選択相当） |
| `InboundList` | `InventoryCountList` | 商品リスト画面（入庫商品リスト相当） |

#### ① InventoryCountConditions（棚卸ID入力画面）

**流用元**: `InboundConditions` (7463行目～)

**変更点**:
- 入庫ID一覧 → 棚卸ID一覧
- Transfer → InventoryCount
- タブ「未受領/受領済み」→ タブ「未完了/完了済み」
- 出庫元/入庫先 → ロケーション/商品グループ
- `fetchTransfersForDestinationAll` → 棚卸ID取得API
- `onTapTransfer` → `onTapInventoryCount`（商品グループが1つの場合は直接商品リストへ、複数の場合は商品グループ選択画面へ）

**実装箇所**: 4分割後は `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountConditions.jsx` に実装

#### ② InventoryCountProductGroupSelection（商品グループ選択画面）

**流用元**: `InboundShipmentSelection` (8070行目～)

**変更点**:
- シップメント選択 → 商品グループ選択
- シップメント一覧 → 商品グループ一覧
- Transfer情報 → 棚卸ID情報
- `onSelectShipment` → `onSelectProductGroup`
- シップメントの数量情報 → 商品グループの対象SKU数（オプション）

**実装箇所**: 4分割後は `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountProductGroupSelection.jsx` に実装

**表示条件**: 棚卸IDに紐づく商品グループが複数の場合のみ表示（1つの場合は自動で商品リストへ）

#### ③ InventoryCountList（商品リスト画面）

**流用元**: `InboundList` (8346行目～)

**変更点**:
- 入庫商品リスト → 棚卸商品リスト
- 予定数/受領数 → 現在在庫数/実数
- 受領確定処理 → 在庫絶対値調整処理
- `receiveConfirm` → `inventoryCountConfirm`（絶対値処理）
- 予定外入庫/過剰入庫の警告 → 不要（絶対値処理のため）
- ヘッダーの「出庫元/入庫先」→「ロケーション/商品グループ」
- フッターの「予定/受領」→「現在在庫/実数」

**実装箇所**: 4分割後は `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx` に実装

**重要な違い**:
- **在庫調整処理**: 入庫は差分調整、棚卸は絶対値調整
- **初期表示**: 在庫レベルがないSKUは非表示（スキャン/検索で追加可能）
- **数量入力**: 実数を直接入力（現在在庫数は参考表示のみ）

#### データ構造の対応関係

| 入庫処理 | 棚卸処理 | 説明 |
|---------|---------|------|
| `inbound.selectedShipmentId` | `inventoryCount.selectedProductGroupId` | 選択中の商品グループID |
| `inbound.selectedTransferId` | `inventoryCount.selectedCountId` | 選択中の棚卸ID |
| `inbound.selectedTransferName` | `inventoryCount.selectedCountName` | 棚卸ID名 |
| `inbound.selectedOriginName` | `inventoryCount.selectedLocationName` | ロケーション名 |
| `inbound.selectedDestinationName` | `inventoryCount.selectedProductGroupName` | 商品グループ名 |

#### 実装時の注意事項

1. **appStateの拡張**: `appState` に `inventoryCount` スライスを追加
   ```typescript
   type AppState = {
     // ... 既存のスライス ...
     inventoryCount?: {
       selectedCountId: string;
       selectedCountName: string;
       selectedLocationId: string;
       selectedLocationName: string;
       selectedProductGroupId: string;
       selectedProductGroupIds: string[]; // 複数選択時
       productGroupMode: "single" | "multiple";
       selectedProductGroupName: string;
       selectedReadOnly: boolean;
       // ... その他の状態 ...
     };
   };
   ```

2. **SCREENS定数の追加**: 
   ```javascript
   const SCREENS = {
     // ... 既存の画面 ...
     INVENTORY_COUNT_COND: "inv_count_cond",
     INVENTORY_COUNT_PRODUCT_GROUP_SELECTION: "inv_count_group_selection",
     INVENTORY_COUNT_LIST: "inv_count_list",
   };
   ```

3. **メニュー画面への追加**: メニュー画面に「棚卸」ボタンを追加

4. **スキャナー処理**: 入庫処理と同じように `Modal.jsx` の `Extension` コンポーネントでスキャナーを購読し、`INVENTORY_COUNT_LIST` 画面の時だけキューに積む

5. **在庫調整API**: `inventoryAdjustQuantity` GraphQL mutationを使用（絶対値処理）

### 3.6 実装時の注意事項

#### 在庫レベルがないSKUの扱い
- **初期表示**: 対象ロケーションに在庫レベルがないSKUは商品リストに表示しない
- **スキャン/検索時**: スキャンや検索入力で該当商品が見つかった場合、リストに追加して有効化（表示・編集可能）して処理できる
- **実装方法**: 
  - 商品グループのコレクションから商品を取得する際、在庫レベルでフィルタリング
  - スキャン/検索時は在庫レベルの有無に関係なく商品を検索し、見つかった場合はリストに追加

#### 商品グループ選択画面の表示制御
- **商品グループが1つの場合**: 商品グループ選択画面をスキップして商品リスト画面に直接遷移
- **商品グループが複数の場合**: 商品グループ選択画面を表示（入庫のシップメント選択と同じUI/UX）
- **将来拡張**: 管理画面でデフォルト動作を設定可能に（「リスト選択」or「まとめて表示」）

#### 入庫処理への影響
- 棚卸機能実装時に、入庫処理にも同様の設定を追加することを検討
- シップメントが複数の場合のデフォルト動作を管理画面で設定可能にする

---

## 4. データベース設計

### 外部DB前提の全体設計（2026-02 方針）

本番で「デプロイで履歴が消えない」「管理画面を開かなくても情報取得が可能」を満たすため、**全体設計を外部DB（PostgreSQL）使用前提で組み直す**方針としました。

- **全体設計・データ洗い出し・DB選定**: **`docs/ARCHITECTURE_EXTERNAL_DB.md`** を参照してください。
  - 現状のデータ保存箇所の整理（Prisma / Metafield）
  - 在庫変動履歴以外で外部DBに寄せた方がスムーズになるデータの洗い出し（日次スナップ・ロス・棚卸・仕入・発注・設定など）
  - 外部DB前提のデータ配置方針と移行 Phase
- **おすすめのDB**: 全体設計を外部DB前提で見直し、データを増やしていく場合は **Supabase（PostgreSQL）** を推奨。Render のみで完結させたい場合は Render PostgreSQL（Add-ons）も選択肢。比較と理由は上記ドキュメントの「4. おすすめのDB」を参照。

以下は現行実装と、在庫変動履歴まわりの確定事項です。Metafield から DB への移行対象・スキーマ案は ARCHITECTURE_EXTERNAL_DB.md に記載しています。

### 4.1 現在の実装
- **Session管理**: Prisma SQLite（開発）/ 本番は PostgreSQL 必須（`/prisma/schema.prisma`）
- **在庫変動履歴**: Prisma（`InventoryChangeLog`）。本番は PostgreSQL 必須。
- **設定データ**: Shopify Metafield（`currentAppInstallation.metafield`）
- **ロス・棚卸・仕入・発注の履歴／マスタ**: 各 Metafield（250KB/値の制限あり）。外部DB移行対象は ARCHITECTURE_EXTERNAL_DB.md 参照。

### 4.2 新規データの保存方法（方針）

#### 外部DB前提の方針（2026-02）
- **永続化が必要なデータ**（セッション・在庫変動履歴・および移行対象のロス/棚卸/仕入/発注/日次スナップ等）は **PostgreSQL（外部DB）** に保存する。本番では SQLite は使わない。
- **Metafield** は、外部DBに移行するまでは現状どおり利用。移行後は該当キーは書込をやめ、DB を正とする（詳細は ARCHITECTURE_EXTERNAL_DB.md）。

#### 参考：Metafield と DB の比較（移行前の現状）
- **Metafield方式**: 実装が簡単・Shopify標準。デメリットは 250KB 制限・検索・集計のしづらさ。適用: ロス登録、棚卸設定・棚卸ID、仕入・発注履歴（現状）。
- **Prisma（PostgreSQL）方式**: 検索・集計が容易・データ量制限なし。適用: Session、在庫変動履歴（必須）。その他は段階的に移行（ARCHITECTURE_EXTERNAL_DB.md の Phase 参照）。

#### 確定事項（在庫情報実装方針 - 2026-02-06更新）

**Phase 1: 在庫高表示（合計のみ） - Metafieldベース実装**
- **在庫高（過去日付）の日次スナップショット** は、**Metafieldに保存**する（合計小売価値・合計原価のみをロケーション別に日次で集計）。
  - 理由: 合計値のみであればデータ量が少なく、Metafieldの250KB制限内に収まる見込み。
  - データ構造: `namespace: "inventory_info", key: "daily_snapshots"` に日付別のスナップショットを保存。
  - 実装確認済み: Webhook（`inventory_levels/update`）とOrders API（売上時の変動検知）の実装可能性を確認済み。

**Phase 2以降: 在庫変動履歴 - ✅ 完了（2026-02-06）**
- **在庫変動履歴（Change Log）** は、データ量と検索要件を考慮して**Prisma DB**で実装（`InventoryChangeLog`モデル）。
- **実装方式**：
  - アプリ実行分（仕入確定・キャンセル）は、在庫調整成功後に直接ログ記録
  - 入庫・出庫・ロス・棚卸は、既存の`inventory_levels/update` Webhookで検知（`admin_webhook`として記録）
  - 売上時の変動は、`orders/updated` Webhookで検知（`order_sales`として記録）
- **データ保存**：Prisma DB（SQLite開発環境 / 本番は PostgreSQL）。**本番リリース時**は Render 等のエフェメラルなディスクでは SQLite がデプロイごとに消えるため、**永続DB（PostgreSQL）の利用が必須**。**Render PostgreSQL（Add-ons）と Supabase のどちらか一方**を用意し、接続URLを `DATABASE_URL` に設定すればよい。手順・Prisma 設定例は RELEASE_REQUIREMENTS_PUBLIC_APP.md の「5. 本番で必須の2つの対策」を参照。
- **検索・フィルター**：期間・ロケーション・商品（InventoryItem ID）・アクティビティ種別でフィルター可能
- **表示件数**：最大1000件まで表示
  - 変動履歴には「どの操作が原因か」を必ず追えるように、参照IDを保存する。
  - 例: `sourceType`（inbound/outbound/loss/stocktake/purchase/admin_webhook など） + `sourceId`（Transfer IDやMetafieldエントリーID）

### 4.3 データ構造の統一

#### SettingsV1 の実装（2026-01-27更新）
```typescript
type SettingsV1 = {
  version: 1;
  destinationGroups?: DestinationGroup[]; // 非推奨（後方互換性のため残す）
  carriers: CarrierOption[];
  // 2026-02 追加予定（仕入・ロス）
  suppliers?: Array<{
    id: string;
    name: string; // サプライヤー名
    code?: string; // 任意
    sortOrder?: number;
  }>;
  lossReasons?: Array<{
    id: string;
    label: string; // ロス区分（例: 破損、紛失）
    sortOrder?: number;
  }>;
  // 実装済み設定項目
  visibleLocationIds?: string[]; // 表示ロケーション選択設定（空配列=全ロケーション表示）
  outbound?: {
    allowForceCancel?: boolean; // 強制キャンセル処理許可（デフォルト: true）
    historyInitialLimit?: number; // 履歴一覧リスト（出庫・入庫・ロス履歴）初回件数。API上限250、推奨100
  };
  inbound?: {
    allowOverReceive?: boolean; // 過剰入庫許可（デフォルト: true）
    allowExtraReceive?: boolean; // 予定外入庫許可（デフォルト: true）
    listInitialLimit?: number; // 履歴一覧リスト（出庫・入庫・ロス履歴）初回件数。API上限250、推奨100
    shipmentSelectionMode?: "list" | "all"; // シップメントが複数の場合のデフォルト動作（"list": リスト選択, "all": まとめて表示、将来拡張）
  };
  productList?: {
    initialLimit?: number; // 商品リスト（出庫・入庫・ロス登録）初回件数。lineItems上限250、推奨250
  };
  searchList?: {
    initialLimit?: number; // 検索リスト（出庫・入庫・ロス登録）初回件数。productVariants上限50、推奨50
  };
  inventoryCount?: {
    productGroupSelectionMode?: "list" | "all"; // 商品グループが複数の場合のデフォルト動作（"list": リスト選択, "all": まとめて表示、将来拡張）
  };
};
```

**注意**: 
- `outbound.historyInitialLimit`と`inbound.listInitialLimit`は、設定画面で統合して「履歴一覧リスト」として表示・設定されます
- 設定画面で変更すると、両方の値が同時に更新されます（出庫履歴・入庫履歴・ロス履歴に適用）
- `productList.initialLimit`と`searchList.initialLimit`は、出庫・入庫・ロス登録の全てに適用されます

---

## 5. 実装優先順位

### Phase 1: 管理画面の設定拡張（最優先）✅ 完了
1. ✅ 設定画面の拡張（`/app/settings.tsx`）- 完了（2026-01-27）
   - ✅ 表示ロケーション選択設定
   - ✅ 履歴一覧リスト表示件数設定（出庫・入庫・ロス履歴に適用）
   - ✅ 商品リスト表示件数設定（出庫・入庫・ロス登録に適用）
   - ✅ 検索リスト表示件数設定（出庫・入庫・ロス登録に適用）
   - ✅ 各種許可設定（強制キャンセル、過剰入庫、予定外入庫）

### Phase 2: 入出庫履歴管理画面（高優先度）
2. ✅ 履歴管理画面の作成（`/app/history.tsx`）
   - ✅ 履歴一覧表示（出庫・入庫統合表示）
   - ✅ フィルター機能（出庫ロケーション、入庫ロケーション、ステータス - 複数選択対応）
   - ✅ ページネーション（次へ/前へボタン、ページ表示）
   - ✅ モーダル表示（履歴クリックで商品リストをモーダル表示）
   - ✅ モーダルから個別CSV出力
   - ✅ 予定数/入庫数表示（分けて表示）
   - ✅ 予定外入庫表示（メモから抽出、薄い赤背景）
   - ✅ 予定外入庫を含めた数量計算（一覧表示に反映）
   - ✅ 予定外入庫の件数表示（一覧の状態横に表示）
   - ⏸️ 一括CSV出力（調整中、一時的に非表示）
   - フィルター機能
   - CSV出力機能
   - 詳細画面

### Phase 3: ロス登録機能（中優先度）✅ 完了
3. ✅ ロス登録機能の実装（POS UI・管理画面とも実装完了・エラー修正済み）
   - ✅ POS UIでのロス登録処理
     - ✅ コンディション画面（ロケーション、日付、理由、スタッフ名入力）
     - ✅ 商品リスト画面（出庫処理と完全に同じUI/UX）- **エラー修正済み**（2026-01-27、スキャナー処理を Modal.jsx に統一）
     - ✅ 履歴一覧画面（現在のロケーションで自動フィルター）
     - ✅ 在庫調整処理（`inventoryAdjustQuantity` GraphQL mutation）
     - ✅ データ保存（Metafield方式、`loss_entries_v1`）
   - ✅ 管理画面でのロス登録履歴表示（`/app/loss` 実装済み・コード確認済み）
   - ✅ CSV出力機能（実装済み）
   - ✅ キャンセル機能（実装済み、在庫を戻す処理も含む）

### Phase 4: 棚卸機能（中優先度）✅ 完了
4. ✅ 棚卸機能の実装（管理画面・POS UIとも実装完了）
   - ✅ 管理画面での商品グループ設定（実装済み）
   - ✅ 管理画面での棚卸ID発行処理（実装済み、複数商品グループ選択対応済み）
   - ✅ 管理画面での棚卸履歴表示（実装済み）
   - ✅ POS UIでの棚卸処理（実装済み・コード確認済み）
     - ✅ 棚卸ID入力画面（`InventoryCountConditions.jsx`）
     - ✅ 商品グループ選択画面（`InventoryCountProductGroupSelection.jsx`、商品グループが複数の場合のみ）

### Phase 5: 在庫情報（在庫高表示・変動履歴）✅ 完了（2026-02-06完了）
5. 🔄 在庫情報機能の実装
   - ✅ **Phase 5-1: 在庫高表示（合計のみ）** - Metafieldベース実装（2026-02-06完了）
     - ✅ 日次スナップショット保存機能（Metafieldに合計小売価値・合計原価をロケーション別に保存）
       - ✅ 日次バッチAPI（`/api/inventory-snapshot-daily`）の実装（Cronジョブから呼び出し可能）
       - ✅ ショップのタイムゾーンに基づく日付計算
       - ✅ 前日のスナップショットを自動保存（日付変更時に実行）
     - ✅ 在庫高表示画面（`/app/inventory-info`）の作成
       - ✅ 日付選択（今日はリアルタイム、過去日付はスナップショット）
       - ✅ ロケーション選択（複数選択対応）
       - ✅ 最初のスナップショット日付以降の日付選択制限
       - ✅ 履歴確認可能日付の可視化（YYYY/MM/DD形式で表示）
     - ✅ 日付指定での過去在庫高表示（Metafieldから取得）
     - ✅ ロケーション別サマリー表示
       - ✅ ロケーション名
       - ✅ 合計数量
       - ✅ 販売価格合計（上代合計）
       - ✅ 割引前価格合計
       - ✅ 原価合計
       - ✅ 全ロケーション合計のサマリー表示
     - ✅ CSV出力機能
       - ✅ ロケーション別サマリーのCSV出力
       - ✅ 日本語ヘッダー（日付、モード、ショップ、ロケーションID、ロケーション名、合計数量、販売価格合計、割引前価格合計、原価合計）
       - ✅ モード列（「現在」= リアルタイム、「確定」= スナップショット）
       - ✅ 合計行を含むCSV出力
       - ✅ CSV出力ボタンを合計タイトル行に配置
   - ✅ **Phase 5-2: 在庫変動履歴** - 完了（2026-02-06完了）
     - ✅ **在庫変動履歴記録の共通ユーティリティ関数**
       - ✅ `app/utils/inventory-change-log.ts` に共通関数を実装
       - ✅ `logInventoryChange`: 単一の在庫変動を記録
       - ✅ `logInventoryChangesFromAdjustment`: 在庫調整の結果から複数商品の変動を記録
       - ✅ `getShopTimezoneAndDate`: ショップタイムゾーンと日付を取得
       - ✅ `getInventoryItemInfo`: InventoryItemからSKUとvariantIdを取得
       - ✅ `getLocationName`: Locationからロケーション名を取得
       - ✅ `getVariantInfo`: ProductVariantからInventoryItem IDとSKUを取得
     - ✅ **アプリ実行分からの変動履歴記録**
       - ✅ 仕入確定時（`executePurchaseReceive`）にログ記録（`purchase_entry`）
       - ✅ 仕入キャンセル時（`executePurchaseCancel`）にログ記録（`purchase_cancel`）
       - ✅ 入庫・出庫・ロス・棚卸は既存の`inventory_levels/update` Webhookで検知（`admin_webhook`として記録）
     - ✅ **Webhook実装**
       - ✅ `inventory_levels/update` Webhook（既存実装を活用、`admin_webhook`として記録）
       - ✅ `orders/updated` Webhook（売上時の変動検知、`order_sales`として記録）
       - ✅ 注文履行時の在庫変動を検知し、履行された商品ごとにログ記録
       - ✅ idempotencyKeyによる二重登録防止
     - ✅ **変動履歴一覧表示**
       - ✅ タブUI実装（設定画面と同じスタイル、在庫高/在庫変動履歴を切り替え）
       - ✅ フィルターUI（左にフィルター、右にリスト、他の管理画面と統一）
       - ✅ 期間フィルター（開始日・終了日、縦並び表示）
       - ✅ ロケーション選択（チェックボックス形式、複数選択対応）
       - ✅ 商品検索（SKU・商品名・JANで検索、複数選択対応）
       - ✅ 選択済み商品の表示（検索結果エリア内にインライン表示）
       - ✅ 選択解除ボタン（選択済み商品を一括解除）
       - ✅ アクティビティ種別フィルター（チェックボックス形式、複数選択対応）
       - ✅ 並び順選択（新しい順/古い順）
       - ✅ フィルター適用ボタン（URLパラメータ更新）
       - ✅ 最大1000件まで表示
     - ✅ **日付選択の制限**
       - ✅ ログの最初の日付より前は選択不可（`firstChangeHistoryDate`を取得）
       - ✅ ログが1件もない場合は、今日の日付より前は選択不可
       - ✅ 開始日の初期値：ログがある場合は直近30日（ログ最初の日付より前の場合はログ最初の日付）、ログが無い場合は今日
       - ✅ 終了日の初期値：今日
     - ✅ **CSV出力機能**
       - ✅ 発生日時、SKU、ロケーション、アクティビティ、変動量、変動後数量、参照ID、備考を含むCSV出力
       - ✅ 日本語ヘッダー
       - ✅ BOM付きUTF-8形式
       - ✅ ファイル名に期間を含む（`在庫変動履歴_YYYY-MM-DD.csv` または `在庫変動履歴_YYYY-MM-DD_YYYY-MM-DD.csv`）
     - ✅ **UI/UX調整**
       - ✅ 日付入力の縦並び表示（開始日と終了日を縦に配置）
       - ✅ 日付入力の幅100%（ラベルは固定幅、入力欄は残り幅いっぱい）
       - ✅ 商品検索UIの改善（仕入画面と同じUIに統一）
       - ✅ 商品検索ボタンのサイズ調整（小さく）
       - ✅ 選択済み/選択解除ボタンの追加
       - ✅ 商品リストの間隔調整（ロケーション選択と同じ間隔に統一）
       - ✅ フィルター適用ボタンのUI統一（他の管理画面と統一）
     - ✅ **バグ修正**
       - ✅ ロス画面の`pageInfo`エラー修正（loaderから`pageInfo`を取得するように修正）
       - ✅ 日付初期値の調整（ログが無い場合の処理を追加）
       - ✅ カレンダーのmin属性の調整（在庫変動履歴の最初の日付のみを使用）
     - ✅ **データベーススキーマ**
       - ✅ `InventoryChangeLog`モデル（Prisma）
       - ✅ フィールド：shop, timestamp, date, inventoryItemId, variantId, sku, locationId, locationName, activity, delta, quantityAfter, sourceType, sourceId, adjustmentGroupId, idempotencyKey, note
       - ✅ アクティビティ種別：`inbound_transfer`, `outbound_transfer`, `loss_entry`, `inventory_count`, `purchase_entry`, `purchase_cancel`, `order_sales`, `refund`, `admin_webhook`
       - ✅ ユニーク制約：`shop_idempotencyKey`（二重登録防止）
       - ✅ インデックス：shop, date, inventoryItemId, locationId, activity

---

## 6. 実装時の注意事項

### 6.1 既存機能への影響
- 既存の出庫・入庫機能を壊さないよう注意
- 設定項目のデフォルト値は既存の動作を維持するように設定

### 6.2 パフォーマンス
- 履歴一覧の表示件数に制限を設ける（ページネーション対応）
- 大量データのCSV出力は非同期処理を検討

### 6.3 エラーハンドリング
- 在庫調整時のエラーを適切に処理
- キャンセル処理時の差分調整を確実に実行

### 6.4 UI/UX
- Shopify Polarisデザインガイドラインに準拠
- POS UI Extensionの制約を遵守
- タッチ操作に最適化
- **文言・UIトンマナの統一**: 本文冒頭「文言・UIトンマナの統一（必須）」に従い、他画面・同一機能内で文言およびUIのトーン＆マナーを必ず統一する。

---

## 7. 確認事項

### 7.1 現状コードの確認結果 ✅（2026-01-27更新）
- [x] 出庫履歴リストの現在の表示件数: **100件/ページ**（`fetchTransfersForOriginAll`、設定で変更可能）
- [x] 入庫リストの現在の表示件数: **100件/ページ**（設定で変更可能、`outbound.historyInitialLimit`と`inbound.listInitialLimit`で統合管理）
- [x] ロス履歴リストの表示件数: **設定画面の履歴一覧リスト設定に従う**（`outbound.historyInitialLimit`と`inbound.listInitialLimit`で統合管理）
- [x] 商品リストの現在の表示件数: **250件（初期）**、20件ずつ追加読み込み（`candidatesDisplayLimit`、設定で変更可能、`productList.initialLimit`）
- [x] 検索リストの現在の表示件数: **50件（初期）**（設定で変更可能、`searchList.initialLimit`、出庫・入庫・ロス登録に適用）
- [x] 強制キャンセル処理の現在の実装状況: **実装済み**（noteに"[強制キャンセル]"が含まれているかで判定、設定で許可/不許可を切り替え可能）
- [x] 過剰入庫・予定外入庫の現在の実装状況: **実装済み**（監査ログで管理、`over`と`extras`として処理、設定で許可/不許可を切り替え可能）

### 7.2 設計判断が必要な項目
- [x] 管理画面のURL構造: **決定済み**（4つのページに分割）
- [ ] ロス登録・棚卸のデータ保存方法（Metafield vs Prisma）
- [ ] 商品グループのネスト機能の必要性
- [ ] CSV出力の詳細フォーマット

---

## 8. 次のステップ

1. ✅ **現状コードの確認**: 完了（表示件数、強制キャンセル、過剰入庫・予定外入庫の実装状況を確認）
2. ✅ **管理画面の構造**: 決定済み（4つのページに分割）
3. ✅ **ロス登録機能のエラー修正**: **完了・機能検証完了**（2026-01-27）
   - エラー: `undefined is not an object (evaluating 'Object.prototype.hasOwnProperty.call(e,t)')`
   - 発生タイミング: コンディション画面から「次へ」を押した瞬間
   - 根本原因: スキャナー処理の実装場所の違い（出庫/入庫は`Modal.jsx`で開始、ロス登録は`LossProductList`内で開始）
   - 修正内容: スキャナー処理を`Modal.jsx`に移動、出庫/入庫と同じ実装に統一
   - 修正状況: ✅ 完了（機能検証完了）
4. ✅ **自動保存・復元機能の改善**: **完了**（2026-01-27）
   - ✅ ロスコンディション画面: 復元時にトースト表示、商品リストから戻った時に復元
   - ✅ 出庫コンディション画面: 自動保存・復元機能を実装（ロス登録と同様）
5. ✅ **配送番号のスキャン機能**: **完了**（2026-01-27）
   - ✅ 出庫コンディション画面でスキャンした際に配送番号に自動入力
   - ✅ 確定モーダル内でもスキャン可能
6. ✅ **スキャナーのトースト整理**: **完了**（2026-01-27）
   - ✅ 不要なデバッグ用トーストを削除
7. **棚卸機能（POS UI）の実装**: **✅ 完了**（コード確認済み 2026-02）
   - [x] 棚卸ID入力画面（`InventoryCountConditions.jsx`）
   - [x] 商品グループ選択画面（`InventoryCountProductGroupSelection.jsx`）
   - [x] 商品リスト画面（`InventoryCountList.jsx`）
   - [x] 在庫絶対値調整処理（`inventorySetQuantities`）
   - [x] 在庫レベルがないSKUの扱い（スキャン/検索で追加可能）
   - [x] 管理画面での棚卸ID発行処理の複数商品グループ選択対応
8. **設計判断**: データ保存方法、商品グループのネスト機能、CSV出力フォーマット等を決定
9. **実装開始**: Phase 1から順次実装
   - ✅ ナビゲーションメニューの更新（`/app/routes/app.tsx`）- 完了
   - ✅ 各管理画面ページの実装 - 完了
10. **テスト**: 各Phase完了後にテスト実施
11. **ドキュメント更新**: 実装完了後にREADME等を更新

---

## 9. 実装サマリー

### 9.1 管理画面の構成（4つのページ）

#### ① TOP（設定）: `/app/settings` ✅ 実装完了
- **ファイル**: `/app/routes/app.settings.tsx`
- **実装済み設定項目**: 
  - ✅ 店舗グループ（destinationGroups）設定（非推奨、後方互換性のため残す）
  - ✅ 配送会社（carriers）設定
  - ✅ 表示ロケーション選択設定（`visibleLocationIds`）
  - ✅ 出庫：強制キャンセル処理許可設定（`outbound.allowForceCancel`）
  - ✅ 入庫：過剰入庫許可設定（`inbound.allowOverReceive`）
  - ✅ 入庫：予定外入庫許可設定（`inbound.allowExtraReceive`）
  - ✅ 履歴一覧リスト表示件数設定（`outbound.historyInitialLimit`、`inbound.listInitialLimit`、出庫・入庫・ロス履歴に適用）
  - ✅ 商品リスト表示件数設定（`productList.initialLimit`、出庫・入庫・ロス登録に適用）
  - ✅ 検索リスト表示件数設定（`searchList.initialLimit`、出庫・入庫・ロス登録に適用）
- **データ保存**: `SettingsV1` 型で `currentAppInstallation.metafield` に保存

#### ② 入出庫履歴: `/app/history`
- **新規ファイル**: `/app/routes/app.history.tsx`（一覧画面）、`/app/routes/app.history.$id.tsx`（詳細画面、オプション）
- **機能**: 履歴一覧表示、フィルター、CSV出力、詳細表示
- **データ取得**: GraphQL `inventoryTransfers` クエリ + 監査ログ

#### ③ ロス登録履歴: `/app/loss`
- **ファイル**: `/app/routes/app.loss.tsx`（一覧画面、実装済み）
- **機能**: 履歴一覧表示、フィルター、CSV出力、詳細モーダル表示
- **データ保存**: `currentAppInstallation.metafield` (key: `loss_entries_v1`)
- **POS UI**: `/extensions/stock-transfer-loss/src/screens/loss/` に実装
  - ✅ **商品リスト画面**: 実装済み・エラー修正済み（2026-01-27）
- **在庫調整**: `inventoryAdjustQuantity` GraphQL mutation（マイナス値で処理）

#### ④ 棚卸: `/app/inventory-count` ✅ 実装完了（確定処理のエラー修正中）
- **ファイル**: `/app/routes/app.inventory-count.tsx`（設定・履歴・CSV出力を含む）
- **実装状況**: ✅ 管理画面は実装完了、✅ POS UIも実装完了（確定処理のエラー修正中）
- **機能**: 
  - ✅ 商品グループ設定（カテゴリ設定、コレクション選択）
  - ✅ 棚卸ID発行（ロケーション選択、商品グループ複数選択対応）
  - ✅ 履歴一覧表示、フィルター、CSV出力
  - ✅ 棚卸ID表示形式: `#C0000`形式（既存データにも自動付与）
- **データ保存**: 
  - ✅ 商品グループ: `currentAppInstallation.metafield` (key: `product_groups_v1`)
  - ✅ 棚卸ID: `currentAppInstallation.metafield` (key: `inventory_counts_v1`)
- **POS UI**: ✅ `/extensions/stock-transfer-stocktake/src/screens/stocktake/` に実装完了
  - ✅ 棚卸ID入力画面（コンディション画面相当）
  - ✅ 商品グループ選択画面（シップメント選択相当、商品グループが複数の場合のみ）
  - ✅ 商品リスト画面（入庫商品リスト相当）
  - ✅ 確定モーダル（入庫の確定モーダルを参考）
  - ✅ 自動保存・復元機能（下書きの自動保存・復元）
  - ✅ VariantCache活用（スキャン時の商品検索を高速化）
  - ✅ 軽量モード（画像OFF機能）
- **在庫調整**: ✅ `inventorySetQuantities` GraphQL mutation（ロス登録と同じ処理方法、絶対値設定）

### 9.5 実装優先順位（2026-01-27更新）
1. **Phase 1（最優先）**: 管理画面の構成 ✅ 完了
   - ✅ TOP（設定）: `/app/settings` の拡張（完了）
   - ✅ 入出庫履歴: `/app/history` の作成（完了）
   - ✅ ロス登録履歴: `/app/loss` の作成（完了）
   - ✅ 棚卸: `/app/inventory-count` の作成（完了）
2. **Phase 2（高優先度）**: POS UI機能の実装 ✅ 完了
   - ✅ ロス登録機能（POS UI）（完了、エラー修正済み）
   - ✅ 棚卸機能（POS UI）（実装完了、確定処理のエラー修正中）

---

## 10. 確認事項と判断が必要な項目

### 10.1 設計判断が必要な項目
- [x] 管理画面のURL構造: **決定済み**
  - `/app/settings` - TOP（設定）
  - `/app/history` - 入出庫履歴
  - `/app/loss` - ロス登録履歴
  - `/app/inventory-count` - 棚卸（設定・履歴）
- [ ] ロス登録・棚卸のデータ保存方法（Metafield vs Prisma）
  - **推奨**: Phase 1はMetafield方式で実装、必要に応じてPrismaに移行
- [ ] 商品グループのネスト機能の必要性
  - **判断**: まずはフラットな構造で実装、必要に応じてネスト機能を追加
- [ ] CSV出力の詳細フォーマット
  - **判断**: 基本的な項目（ID, 日付, ロケーション, 商品明細等）を出力、必要に応じて拡張

### 10.2 技術的な確認事項（2026-01-27更新）
- [ ] Metafieldのデータ量制限（大量の履歴データを保存する場合）
- [ ] CSV出力時のパフォーマンス（大量データの処理）
- [ ] 在庫調整時のエラーハンドリング（同時更新の競合等）
- [x] ✅ ロス登録機能の商品リスト画面の初期化エラー: **修正完了・機能検証完了**（2026-01-27）
  - エラー: `undefined is not an object (evaluating 'Object.prototype.hasOwnProperty.call(e,t)')`
  - 発生タイミング: コンディション画面から「次へ」を押した瞬間
  - 根本原因: スキャナー処理の実装場所の違い（出庫/入庫は`Modal.jsx`で開始、ロス登録は`LossProductList`内で開始）
  - 修正内容: スキャナー処理を`Modal.jsx`に移動、出庫/入庫と同じ実装に統一
  - 修正状況: ✅ 完了（機能検証完了）
- [x] ✅ 自動保存・復元機能の改善: **完了**（2026-01-27）
  - ロスコンディション画面: 復元時にトースト表示、商品リストから戻った時に復元
  - 出庫コンディション画面: 自動保存・復元機能を実装
- [x] ✅ 配送番号のスキャン機能: **完了**（2026-01-27）
  - 出庫コンディション画面と確定モーダル内でスキャン可能
- [x] ✅ 棚卸機能の確定処理: **修正完了**（2026-01-27）
  - 在庫調整と履歴更新を分離、エラーハンドリング改善済み。ロス登録と同様 `inventorySetQuantities` で絶対値設定

---

## 11. 参考情報

### 11.1 現状コードの主要な実装箇所
- **設定管理**: `/app/routes/app.settings.tsx`
- **ナビゲーション**: `/app/routes/app.tsx`（ナビゲーションメニューの更新が必要）
- **出庫処理**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`（4分割後は出庫専用。OutboundHistoryConditions, OutboundHistoryDetail, OutboundShipmentSelection 等）
  - ✅ 出庫コンディション画面: 自動保存・復元機能実装済み（2026-01-27）
  - ✅ 配送番号のスキャン機能実装済み（出庫コンディション画面、確定モーダル内）
  - ✅ 出庫マルチシップメント挙動: `docs/OUTBOUND_MULTI_SHIPMENT_BEHAVIOR.md` に定義。編集モーダルから「シップメントを確定」削除、リストの「確定する」で統一。
  - ✅ 出庫履歴一覧: 入庫リストと同型の行単位レイアウト（`docs/INBOUND_VS_OUTBOUND_LIST_LAYOUT.md`）。状態｜数量行の改行防止、未確定：1 表示（shipments 正規化）、履歴一覧から詳細を開くときのフッター（historyFromShipmentSelection: false）。
  - ✅ 仮想行・配送情報・確定2種（2026-02）: Transfer lineItems を仮想行（#T0127-L）で表示、仮想行タップ時は lineItems のみ表示。OutboundList に「配送情報」ボタン・モーダル。複数シップメント追加・編集時は確定モーダルを「確定」「下書き」の2種に。「在庫再取得」→「在庫更新」に名称変更。`docs/OUTBOUND_CONFIRM_FLOWS.md`、`docs/OUTBOUND_TRANSFER_VS_SHIPMENT_STATUS.md` 参照。
  - ✅ 配送一覧フッター（2026-02）: 左＝戻る、中央＝再読込、右＝キャンセル。キャンセル不可（TRANSFERRED/CANCELED）時はキャンセルボタンをグレーアウト。キャンセル可時はタップで確認モーダル（履歴商品リストと同じ）表示後、キャンセル処理を実行。
  - ✅ 全拡張でボタン表記「再取得」→「再読込」に統一（「取得中...」→「読込中...」含む）。商品リストヘッダーは検索枠以外のボタンを上下中央配置。
- **入庫処理**: `/extensions/stock-transfer-inbound/src/Modal.jsx`（4分割後は入庫専用。InboundConditions, InboundShipmentSelection, InboundListScreen 等）
  - ✅ **REFERENCE 整合（2026-02）**: Modal_REFERENCE.jsx の入庫部分との差分を `docs/INBOUND_REFERENCE_DIFF_ITEMS.md` に整理。確定処理・確定後遷移・transferForShipment・listLimit・processLogCallback・モーダル（onPress・警告「確認しました」は現行維持）・監査ログの extras を REFERENCE に合わせて反映済み。
  - ✅ 入庫リストの Jt/Ot 等 TDZ 対策は InboundListScreen.jsx でモジュールレベル関数化・dialog 宣言順等を反映済み（`docs/INBOUND_LIST_SCREEN_COMPLETE_CHECK.md` 参照）。
  - ✅ **確定済み時の検索・数量グレーアウト・画像表示は有効（2026-02）**: 確定済み（readOnly）の InboundList で検索枠と数量ボタン（−／数値／＋）をグレーアウト。画像表示トグルは確定済みでも有効のまま（readOnly の影響から除外）。InboundUiParts.jsx の QtyControlCompact_3Buttons に disabled 対応、renderInboundShipmentItems_／InboundAddedLineRow に readOnly を渡す。
- **監査ログ**: 入庫拡張内（readInboundAuditLog, appendInboundAuditLog 等）
- **ロス登録**: `/extensions/stock-transfer-loss/src/screens/loss/`（4分割後はロス専用。LossConditions, LossProductList, LossHistoryList 等）
  - ✅ 自動保存・復元機能実装済み（2026-01-27）
  - ✅ スキャナー処理を Modal に統一。棚卸関連ファイルは削除済み。
  - ✅ 画像表示の連動（2026-02）: 履歴一覧フッター中央・履歴詳細ヘッダー右に画像表示ボタンを追加。LossScreen から LossHistoryList に liteMode/onToggleLiteMode を渡し、ロス内で連動。
- **棚卸**: `/extensions/stock-transfer-stocktake/src/`（4分割後は棚卸専用。StocktakeScreen, InventoryCountConditions 等）
  - ✅ 画像表示ON/OFFをコンディションと商品リストで連動（2026-02）: StocktakeScreen から InventoryCountList に liteMode/onToggleLiteMode を渡し、親の設定を優先。
- **POS画像表示の設置箇所一覧**: 出庫・入庫・ロス・棚卸で画像表示を設置している画面・箇所の一覧は `docs/POS_IMAGE_DISPLAY_PLACEMENT.md` に記載。

### 11.4 ナビゲーションメニューの更新
`/app/routes/app.tsx` のナビゲーションメニューを以下のように更新する必要があります：

```tsx
<s-app-nav>
  <s-link href="/app">設定</s-link>
  <s-link href="/app/inventory-info">在庫情報</s-link>
  <s-link href="/app/history">入出庫</s-link>
  <s-link href="/app/purchase">仕入</s-link>
  <s-link href="/app/loss">ロス</s-link>
  <s-link href="/app/order">発注</s-link>
  <s-link href="/app/inventory-count">棚卸</s-link>
</s-app-nav>
```

**注意**: `/app` (Home) は `/app/settings` にリダイレクトするように実装済み（`/app/routes/app._index.tsx` で `redirect("/app/settings")` を実行）

### 11.2 GraphQL API
- **在庫調整**: `inventoryAdjustQuantity` mutation
- **Transfer取得**: `inventoryTransfers` query
- **Shipment取得**: `inventoryShipment` query
- **商品検索**: `productVariants` query

### 11.3 データ構造
- **SettingsV1**: `/app/routes/app.settings.tsx` で定義
- **監査ログ**: `/extensions/stock-transfer-tile/src/Modal.jsx` で定義（INBOUND_AUDIT_NS, INBOUND_AUDIT_KEY）

---

## 12. 最新の修正履歴（2026-01-27）

### 12.1 UI改善（2026-01-27）

#### ① タイル・メニュータイトルの変更 ✅ 完了
- **タイルタイトル**: 「ロス・棚卸」→「在庫調整」
- **タイルサブタイトル**: 「ロス登録/棚卸」→「ロス / 棚卸」
- **メニュータイトル**: 「ロス・棚卸」→「メニュー」
- **実装ファイル**: 
  - `/extensions/stock-transfer-loss/src/Tile.jsx`
  - `/extensions/stock-transfer-loss/src/Modal.jsx`

#### ② ロス登録コンディション画面の改善 ✅ 完了
- **理由ボタンのレイアウト**: 縦並び→横3列で均等に表示
- **実装ファイル**: `/extensions/stock-transfer-loss/src/screens/loss/LossConditions.jsx`

#### ③ 棚卸商品グループリストの改善 ✅ 完了
- **棚卸ID表示**: ID数値→名称（#C0000形式）で表示
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountProductGroupSelection.jsx`

#### ④ 棚卸商品リストの改善 ✅ 完了
- **フッター表示**: 「現在在庫」→「在庫」に変更、差分を改行して赤色表示
- **ヘッダーボタン**: 「軽量ON/OFF」→「軽量」のみ表示（色でON/OFF表現）、「在庫更新」ボタンを追加（旧「在庫再取得」、2026-02 名称変更）
- **予定外リスト**: 初期リストにない商品を最下部に別表示、数量1の場合は×ボタンで削除可能
- **検索リストの数量ボタン**: -数字+形式に変更（直接数字入力可能）
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### ⑤ 在庫更新機能の改善 ✅ 完了（ボタン名称は 2026-02 に「在庫再取得」→「在庫更新」に変更）
- **問題**: 在庫更新時に商品リストが消えてしまう、在庫数が更新されない
- **修正内容**:
  - `refreshing`状態を追加（出庫リストと同じ方式）
  - `stockLoading`フラグを使用して在庫数部分だけ「…」を表示
  - キャッシュを無効化するオプション（`noCache: true`）を追加
  - 在庫更新時に数量（actualQuantity）を保持し、在庫数（currentQuantity）だけを更新
- **実装ファイル**: 
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/stocktakeApi.js`

#### ⑥ 確定モーダルの改善 ✅ 完了
- **調整対象リスト**: 最大10件→1件のみ表示（「…他X件」形式）
- **空白ボタン問題**: `slot="footer"`を明示的に空にして解決
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### ⑦ 確定処理のエラーハンドリング改善 ✅ 完了
- **問題**: HTTP 400エラーが発生しても在庫調整が実行されてしまう
- **修正内容**:
  - 在庫調整（`adjustInventoryToActual`）と履歴更新（`writeInventoryCounts`）を分離
  - 在庫調整が失敗した場合は処理を中断
  - 在庫調整が成功しても履歴更新が失敗した場合は警告を表示
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### ⑧ 数量モーダルのレイアウト改善 ✅ 完了
- **問題**: 削除ボタンと戻るボタンの順序が不自然、幅が統一されていない
- **修正内容**:
  - レイアウト順序: 下線→削除ボタン→下線→戻るボタン→確定ボタン
  - 削除ボタンと戻るボタンの幅を統一（`padding="none"`を設定）
  - `slot="footer"`を明示的に空にして空白ボタンを防止
- **実装ファイル**: 
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`
  - `/extensions/stock-transfer-loss/src/screens/loss/LossProductList.jsx`

#### ⑨ 管理画面UI改善（2026-01-27）✅ 完了
- **商品グループ設定の改善**:
  - ✅ コレクション検索機能: 大量のコレクションがある場合を想定し、検索で候補を表示
  - ✅ コレクション内商品の個別選択: コレクション選択時にモーダルで商品リストを表示、デフォルトは全選択、チェックを外すと対象外
  - ✅ 選択数/合計数の表示: コレクション名の横に「選択数 / 合計数」を表示（例: `5 / 10`）
  - ✅ グループ合計数量の表示: 登録済み商品グループに「合計: 選択 X / Y」を表示
  - ✅ コレクション名をクリックすると、選択商品の確認・編集が可能
- **棚卸ID発行の改善**:
  - ✅ ロケーション検索機能: 検索で候補を表示、空白で全ロケーション表示
- **履歴画面の改善**:
  - ✅ 入出庫履歴・ロス登録履歴とUIを統一（フィルター、モーダル表示、CSV出力）
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

#### ⑫ 商品グループ設定UI改善（2026-01-27）✅ 完了
- **二分割レイアウトの実装**:
  - ✅ 左側（約300px固定幅）: グループ名入力 + 「グループを追加する」ボタン + 編集モード時のコレクション選択フォーム
  - ✅ 右側（残りの幅）: 登録済み商品グループのリスト（各グループにコレクションリストと商品数量を表示）
- **コレクション表示の改善**:
  - ✅ ボタン形式から画像カード形式に変更
  - ✅ 横並びから縦並びのカード形式に変更（画像・タイトル・数量が横並びの横長カード）
  - ✅ 画像サイズ: 40px × 40px（編集モード時と登録済みグループ内で統一）
  - ✅ 画像がない場合は、コレクション名の頭文字を表示
- **右側のコレクションリストから直接編集機能**:
  - ✅ 登録済み商品グループ内のコレクションリストをクリックするとモーダルが開く
  - ✅ モーダルで商品選択を変更して確定すると、直接その商品グループが更新される（編集モードに入る必要がない）
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

#### ⑬ 棚卸ID生成時の商品リスト保存機能（2026-01-27）✅ 完了
- **目的**: 商品グループを編集しても、既に生成済みの棚卸IDには影響しないようにする
- **実装内容**:
  - ✅ 棚卸ID生成時に、選択された商品グループの`inventoryItemIds`を`inventoryItemIdsByGroup`に保存
  - ✅ `InventoryCount`型に`inventoryItemIdsByGroup`フィールドを追加（商品グループごとの`inventoryItemIds`を保存）
  - ✅ POS UI側の`fetchProductsByGroups`関数を修正して、`inventoryItemIdsByGroup`が指定されている場合はそれを使用
  - ✅ `InventoryCountList.jsx`で`fetchProductsByGroups`を呼び出す際に、`count.inventoryItemIdsByGroup`を渡すように修正
- **動作**:
  - **生成済みの棚卸ID**: `inventoryItemIdsByGroup`に保存された生成時の商品リストを使用
  - **商品グループを編集後**: 既存の棚卸IDは生成時の商品リストを使用するため、影響なし
  - **新規生成の棚卸ID**: 編集後の商品グループの状態を使用
- **実装ファイル**: 
  - `/app/routes/app.inventory-count.tsx`
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/stocktakeApi.js`
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### ⑩ 複数グループ対応・完了判定修正（2026-01-27）✅ 完了
- **問題1**: 2つ以上の商品グループを持っていて片方だけ処理済みで他が未処理のものが完了済みに振り分けられている
  - **原因**: 完了判定が`Array.isArray(groupItems[id])`のみで、空配列でも完了扱いになっていた
  - **修正内容**: `Array.isArray(items) && items.length > 0`で、配列が存在し、かつ長さが0より大きい場合のみ完了と判定
- **問題2**: 完了済みの商品リストも編集できるようになっている
  - **原因**: `readOnly`判定が`groupItems[productGroupId]`の存在のみで、`count.status === "completed"`の場合を考慮していなかった
  - **修正内容**: 
    - `readOnly`判定を`readOnlyProp || count?.status === "completed"`に変更
    - `InventoryCountProductGroupSelection`でも`count.status === "completed"`を考慮
    - 完了済みグループタップ時のフリーズ修正: `groupItems`から直接読み込み、API取得をスキップ
- **実装ファイル**: 
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountProductGroupSelection.jsx`

#### ⑪ 棚卸機能のバグ修正・データ保存改善（2026-01-27）⏸️ 修正中
- **問題1**: 管理画面で完了しているグループが未完了と表示される
  - **原因**: `groupItems[groupId]`の存在チェックが不十分
  - **修正内容**: 
    - `isGroupCompleted`ロジックを改善: `groupId && groupItemsMap[groupId] && Array.isArray(groupItemsMap[groupId])`をチェック
    - `groupItemsFromMap.length > 0`で完了判定
- **問題2**: アプリ（まとめて表示）で完了しているグループも未完了と表示され、数量も反映されていない
  - **原因**: 
    - `groupItems[groupId]`から読み込んだデータの`currentQuantity`と`actualQuantity`が正しく設定されていない可能性
    - `barcode`フィールドが保存されていない
  - **修正内容**: 
    - `barcode`フィールドを`linesSnapshot`、`entry`、`mergedEntry`に追加
    - `handleComplete`で`barcode`を保存するように修正
    - 完了済みアイテムを読み込む際に`isReadOnly: true`を明示的に設定
- **問題3**: アプリ（グループごとに表示）で処理済みをタップしても全てのグループの商品一覧が表示される
  - **原因**: `storedItemsFromItems`が使用されている（`count.items`が全グループのデータを含んでいる）
  - **修正内容**: 
    - `storedItemsFromItems`の使用条件を修正: `!isMultipleGroups && !storedItemsFromGroup`の場合のみ使用
    - `storedItemsFromGroup`が存在する場合は、必ず`storedItemsFromGroup`を優先
- **問題4**: 管理画面のモーダルに「グループ名」列が表示されない
  - **修正内容**: 
    - テーブルヘッダーに「商品グループ」列を追加
    - 列を「商品グループ、商品名、SKU、JAN、オプション1、オプション2、オプション3、在庫、実数、差分」に変更
- **問題5**: `writeInventoryCounts`の重複呼び出し
  - **原因**: `handleComplete`内で`writeInventoryCounts`が2回呼ばれていた
  - **修正内容**: 重複呼び出しを削除
- **問題6**: ビルドエラー（`Unexpected "else"`）
  - **原因**: `if (itemsToAdjust.length === 0)`のブロック内で`else`ブロックが重複していた
  - **修正内容**: 重複した`else`ブロックを削除
- **実装ファイル**: 
  - `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`
  - `/app/routes/app.inventory-count.tsx`
- **修正状況**: ✅ 修正完了（2026-01-27）

### 12.16 POS入庫・出庫のリスト戻り時バグ修正（2026-02）✅ 完了

入庫確定後や出庫送信後にリストに戻り、別IDを開いた際に「先程確定した商品リストが表示されて別IDの商品が見れない」という現象の修正。

#### 要因
- **入庫**: 入庫確定後に入庫条件画面（INBOUND_COND）に戻る際、`inbound` の `selectedTransferId` / `selectedShipmentId` 等をクリアしていなかった。このため「続ける」で再度入庫リストを開くと前回確定したIDが選ばれたままになり、前の商品リストが表示されていた。
- **下書き復元**: 入庫の下書きは transferId 別キーで保存され、確定時に `clearInboundDraft` で削除されている。表示が前のままになる主因は「選択状態が残っていたこと」であり、下書き復元そのものは副次的。

#### 修正内容（入庫）
- `onAfterReceive` 内で、全シップメント完了で INBOUND_COND に戻る直前に `setStateSlice(setAppState, "inbound", { ... })` で入庫の選択状態（`selectedTransferId`, `selectedShipmentId`, `selectedShipmentIds`, `shipmentMode`, 表示用メタ）をクリア。
- 未完了でシップメント選択画面に戻る場合は、同じ Transfer の別シップメント選択のため、`selectedTransferId` 等は維持し、`selectedShipmentId` / `selectedShipmentIds` / `shipmentMode` のみクリア。

#### 修正内容（出庫）
- **送信成功時**: 既存下書き更新・新規作成の両方で、`setStateSlice` に `lines: []`, `result: null` を追加し、appState の `outbound` をクリア。次に別IDを開いたときに前の商品リストが残らないようにした。
- **履歴詳細から戻る時**: `goBackFromOutboundHistoryDetail` を新規追加。出庫履歴詳細で「戻る」を押したときに `historySelectedTransferId` をはじめとする履歴選択用 state をクリアし、その後 `nav.pop()`。`OutboundHistoryDetail` の `onBack` をこのコールバックに変更。

#### ロス・棚卸について
- **ロス**: `LossScreen` で商品リストから戻る際に `handleBackFromProduct` で `setConds(null)` しており、条件は戻るたびにクリアされている。同様の「前のIDが残る」現象は起きにくい構造のため、追加修正はしていない。
- **棚卸**: React Router の別ルートで、選択状態は主にコンポーネント内の `useState`。画面を離れるとアンマウントされるため、入庫・出庫と同じパターンのリスクは低いと判断。追加修正はしていない。

- **実装ファイル**: `/extensions/stock-transfer-tile/src/Modal.jsx`

### 12.17 本番検証対応（2026-02）✅ 完了

本番環境での検証で発見された問題の修正。

#### ① 2カラムレイアウトのSP対応 ✅ 完了
- **問題**: PCで2カラムのレイアウト（入出庫履歴一覧など）がSPで見ると右カラムの領域が狭すぎてUIが悪い
- **対応**: `app.history.tsx`、`app.loss.tsx`、`app.inventory-count.tsx` の2カラムレイアウトに `flexWrap: "wrap"` を追加。右カラムを `flex: "1 1 400px"`、左カラムを `flex: "0 1 260px"` に変更し、SP時は右カラムが左カラム下部に折り返されるように修正

#### ② コレクション250件以上の全件読み込み ✅ 完了
- **問題**: 5000件以上のコレクションを持つショップで、検索しても250件以上が表示されない
- **対応**: `app.inventory-count.tsx` の loader で、collections クエリにページネーション（pageInfo.hasNextPage, endCursor）を追加し、全件取得するまでループ

#### ③ 商品SKU650件以上の全件読み込み ✅ 完了
- **問題**: 22000件以上のSKUを持つショップで、検索しても650件以上が表示されない
- **対応**: `app.inventory-count.tsx` の loader で、products クエリにページネーションを追加（products first: 250, variantsFirst: 250）。全件取得するまでループ。SKUタブの説明を「全商品・全バリアントを読み込み」に変更

#### ④ アプリ表示件数の入力検証 ✅ 完了
- **問題**: 設定のアプリ表示件数（履歴一覧リスト、商品リスト、検索リスト）に半角数字以外（全角数字・スペース等）が入力された場合の検証と対処が未対応
- **対応**: 
  - フロント: 全角→半角変換、不正入力・範囲外時に「値を確認してください。半角数字で入力をお願いします。」を入力欄下（helpText）に表示
  - バックエンド: `normalizeToHalfWidthDigits` で全角→半角変換と数字以外除去を実装。`clampInt` が文字列を受け取るよう拡張

#### ⑤ loader 読み込み中表示 ✅ 完了
- **問題**: 棚卸等の重いloader実行中、何も表示されずフリーズしたかわかりにくい
- **対応**: `app/routes/app.tsx` で `useNavigation()` を用い、`state === "loading"` の間画面上部に「読み込み中…」バナーを固定表示（Shopifyグリーン背景）

- **実装ファイル**: 
  - `/app/routes/app.tsx`（読み込み中表示）
  - `/app/routes/app.history.tsx`（2カラムSP対応）
  - `/app/routes/app.loss.tsx`（2カラムSP対応）
  - `/app/routes/app.inventory-count.tsx`（2カラムSP対応、コレクション/SKU全件読み込み）
  - `/app/routes/app.settings.tsx`（表示件数入力検証）

### 12.18 POS入庫表示と運用メモ（2026-02）✅ 完了

#### ① 入庫未処理リストで「予定 / 入庫」に差がある行を赤表示 ✅ 完了
- **要望**: 入庫未処理の商品リストで、まだ何もカウントしていない（実数0）ときの「予定 1 / 入庫 0」も赤色で表示したい。編集前でも予定と入庫に差があるものは赤にしたい。
- **対応**: `renderInboundShipmentItems_` 内の差異判定を変更。従来は「進捗がある行だけ」赤にしていた（`hasAnyProgress && received !== planned`）ため、予定 1 / 入庫 0 は赤にならなかった。**予定と入庫に差がある行はすべて赤**にするよう、`hasDiff = (planned !== received)` に変更。編集前・未カウントでも差があれば赤で表示される。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/Modal.jsx`（`renderInboundShipmentItems_`）

#### ② 修正反映のための作業メモ（ビルド・プッシュ・デプロイ）
- **ビルド**: `npm run build` で実行。GitHub にプッシュするだけならビルドは必須ではない（ソースを push すればよい）。
- **プッシュ**: `git add` → `git commit` → `git push`。認証が必要なため、手元のターミナルで実行する。上流未設定の場合は `git push --set-upstream origin main`。
- **デプロイ**: `shopify app deploy`（または `npm run deploy`）。Shopify CLI が設定フォルダに書き込むため、手元のターミナルで実行する。非対話環境では `--force` が必要な場合あり。
- コードを残すだけなら「コミット＋プッシュ」、POS で実際に動かすには「デプロイ」まで実施する。

### 12.19 棚卸リストのページネーション（2026-02）✅ 完了

#### 問題
- **現象**: 棚卸タブで「SKU選択から作成」をタップした際、2万件超のSKUを持つショップでタブ切り替えに数秒かかる。コレクションから作成に切り替え、再度SKU選択に戻ると再度遅延する。
- **原因**: 全件を一度にDOMレンダリングしているため。タブ切り替え時にコンポーネントがアンマウントされ、戻るたびに再レンダリングが必要だった。

#### 対応内容
- **コレクション一覧**: 1000件/ページで表示。リスト下部に「前へ」「1-1000 / 全X件」「次へ」ボタンを配置。
- **SKU一覧**: 同様に1000件/ページで表示。トンマナを統一。
- **検索・絞り込み**: 検索結果・選択済み表示に対してもページネーション適用。検索/絞り込み変更時は1ページ目にリセット。
- **表示件数**: 1000件以下の場合はページネーション非表示（従来どおり全件表示）。

- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

### 12.21 出庫マルチシップメント挙動定義・拡張4分割検証（2026-02）✅ 完了

#### 1. 出庫マルチシップメント挙動の定義
- **ドキュメント**: `docs/OUTBOUND_MULTI_SHIPMENT_BEHAVIOR.md` を作成。
- **内容**: 出庫リストの「確定する」「下書き保存」「配送準備完了にする」の挙動を明確化。
- **API検証**: 既存 Transfer へのシップメント追加は `inventoryShipmentCreate`（下書き）または `inventoryShipmentCreateInTransit`（確定）で `movementId` に Transfer ID を渡すことで可能。`READY_TO_SHIP` な Transfer の lineItems 更新は `inventoryTransferSetItems` で可能。`READY_TO_SHIP` から `DRAFT` への戻しは API がサポートしていないことを明記。
- **UI簡素化**: 「編集」モーダルから「シップメントを確定」を削除。出庫リストの「確定する」で Transfer またはシップメント全体の確定が行われるように統一。

#### 2. 拡張4分割後の検証
- **ドキュメント**: `docs/EXTENSION_VERIFICATION_4SPLIT.md` に検証結果を記載。
- **stock-transfer-tile（出庫）**: ModalOutbound.jsx のスキャナー購読にあった SCREENS.INBOUND_LIST へのデッドコード分岐を削除。
- **stock-transfer-loss（ロス）**: 棚卸関連ファイル（StocktakeScreen.jsx、src/screens/stocktake/）を削除しデッドコードを解消。
- **stock-transfer-stocktake（棚卸）**: FixedFooterNavBar.jsx を common にコピー、fetchSettings を stocktakeApi.js に移植し、loss 拡張への参照を解消。ビルド成功を確認。

### 12.22 出庫履歴一覧・配送リストのUI修正（2026-02）✅ 完了

#### 1. 出庫履歴一覧のレイアウトを入庫リストと統一
- **対応内容**: 出庫の「未出庫/出庫済み」履歴カードを、入庫の「未入庫/入庫済み」と同じ**行単位**レイアウトに変更。
- **レイアウト**: 1行目＝出庫ID（左）｜日付（右）、2行目＝出庫元、3行目＝入庫先、4行目＝配送数、5行目＝状態（左）｜数量 received/total（右）。配送準備完了時はカード右端に「編集」ボタン。
- **ドキュメント**: 入庫リストと出庫履歴リストの差の説明は `docs/INBOUND_VS_OUTBOUND_LIST_LAYOUT.md` に記載。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`、`/extensions/stock-transfer-tile/src/screens/OutboundHistoryScreens.jsx`

#### 2. 「状態｜数量」行の改行防止
- **問題**: 履歴カードの5行目（状態と数量）で、数量だけが次の行に改行されてしまうことがあった。
- **対応内容**: 5行目の `s-stack` に `flexWrap: "nowrap"` を指定。左の「状態」に `minWidth: 0`, `flex: "1 1 0"` を付与し、右の数量を `<s-box style={{ flexShrink: 0 }}>` で囲み、数量が改行されないように修正。
- **実装ファイル**: 上記と同じ。

#### 3. 「未確定：1」の表示対応
- **問題**: 処理済みでない配送が1件だけのときに「（未確定：1）」が表示されない。2件以上のときは表示されていた。
- **原因**: API が `shipments` を配列以外（`nodes`・`edges`・単体オブジェクト）で返す場合に正規化が不足しており、`unconfirmedCount` が 0 になっていた。
- **対応内容**: `shipments` の正規化を追加。配列・`t.shipments.nodes`・`t.shipments.edges`（`edges.map(e => e.node)`）・単体オブジェクト（id または status を持つ場合は `[t.shipments]`）のいずれにも対応。
- **実装ファイル**: 上記と同じ。

#### 4. 配送リストの「キャンセル」ボタンに確認モーダルを追加
- **対応内容**: 配送リスト（OutboundShipmentSelection）のフッター「キャンセル」をタップしたとき、即実行せず確認モーダル（「この出庫（Transfer）をキャンセルします。よろしいですか？」）を表示。モーダル内の「戻る」で閉じる、「キャンセルする」で実行。商品リスト（OutboundHistoryDetail）のキャンセルと同様のフローに統一。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`（SHIPMENT_LIST_CANCEL_CONFIRM_MODAL_ID、s-modal、フッターの rightCommand/rightCommandFor）

#### 5. 履歴一覧から詳細を開いたときのフッター（戻るが表示されない問題）の修正
- **問題**: 履歴一覧で Transfer をタップして詳細（商品リスト表示）を開くと、フッターが「キャンセル」「編集」のみとなり、左に「戻る」が表示されない。商品リストが表示されずフリーズする報告もあった。
- **原因**: 履歴一覧から詳細を開く際に `historyFromShipmentSelection` を false にしていなかったため、前回の「配送リストから開いた」状態が残り、詳細画面が「配送リスト経由」用のフッター（キャンセル・編集）を表示していた。
- **対応内容**: `onTapHistoryTransfer` 内で詳細を開く直前に `historyFromShipmentSelection: false` を `setStateSlice` に含める。これにより、履歴一覧から開いた場合は詳細フッターに「戻る」「編集」「キャンセル」が表示される。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`（onTapHistoryTransfer）

### 12.26 ロス・入庫・読み込み表示のUI統一（2026-02）✅ 完了

本チャットで実施したロス・入庫・読み込み表示まわりの統一と修正。

#### 1. ロス：コンディション・商品リスト・履歴のUI
- **コンディション画面フッター**: ボタン上のサマリー行（ロケーション・スタッフ・日付/理由）を非表示。FixedFooterNavBar で summaryLeft/Center/Right がすべて空のときはサマリー行を描画しないように変更。LossConditions からは空で渡す。
- **商品リストヘッダー**: 「ロス登録」「ロケーション：」「日付：」「理由：」の形式に変更（LossProductList.jsx）。
- **履歴商品リストのフッター**: ボタン上の表示を**左：ステータス（バッジ）／右：合計：N（商品リストの数量合計）**に変更。FixedFooterNavBar で summaryLeft/summaryRight に React ノード（バッジ等）を渡せるように拡張。LossHistoryList で getStatusBadgeTone を用いてバッジ表示、合計は items の quantity 合計。
- **画像表示ON/OFFの反映**: コンディション画面で切り替えた画像表示モードが商品リストに反映されていなかった問題を修正。LossScreen から LossProductList に `liteMode` と `onToggleLiteMode` を渡す。LossProductList では親から渡された `liteMode` を優先し、ボタン押下時は `onToggleLiteMode` を呼ぶ。
- **ロス商品リストヘッダーに「画像表示」ボタン**: ヘッダー左のステータス文領域（ロス＋サマリー）の**右寄せ上下中央**に「画像表示」ボタンを設置。右端は「リセット」ボタンのみ。ラベルは「画像表示」のみ（ON/OFF表記なし、tone で状態表現）。

#### 2. 入庫：商品リストのステータスバッジ・一覧ステータス引き継ぎ
- **商品リストフッターにステータスバッジ**: フッター中央の「予定0/入庫3」の**左**にステータスバッジを表示（ボタン上ではなく中央行内）。下書き／未入庫／入庫済み等。
- **一覧のステータスを引き継ぐ**: 商品リストのステータスがトランスファー一覧の表示ステータスと一致するよう修正。一覧では `STATUS_LABEL`（DRAFT→下書き、READY_TO_SHIP→配送準備完了、IN_PROGRESS→処理中、IN_TRANSIT→進行中、RECEIVED→入庫、TRANSFERRED→入庫済み、CANCELED→キャンセル、その他）で表示。タップ時に `selectedTransferStatus` を保存しているため、InboundListScreen で `inbound.selectedTransferStatus` および `transferForShipment?.status` を同じ STATUS_LABEL で日本語化してフッターバッジに表示。inbound の getStateSlice 初期値に `selectedTransferStatus: ""` を追加。

#### 3. 読み込み表示の統一
- **画面上の表示**: 「取込中...」「読込中...」「商品を読み込み中...」「検索中...」「取得中...」「履歴を読み込み中...」「配送 読み込み中...」等を全て**「読み込み中...」**に統一。対象：ModalOutbound、InboundListScreen、Modal（入庫）、InboundUiParts、LossHistoryList、LossProductList、InventoryCountConditions、InventoryCountList、Modal_REFERENCE 等。
- **ボタン内のラベル**: 再読込・読込・入庫予定一覧等のボタンでローディング時に表示する文言は**「読込中...」**に統一（ユーザー要望で「読み込み中...」から変更）。
- **出庫の商品リスト「読み込み中...」の表示位置**: OutboundHistoryDetail の商品リストで、`detailLoading` 時に「読み込み中…」が領域左上に余白なく表示され直下に下線が出ていた問題を修正。他商品リスト（入庫・履歴等）と同様、`detailLoading` 時は早期 return で `<s-box padding="base">読み込み中...</s-box>` のみを返すようにし、下線は表示しない。

- **実装ファイル**:  
  - ロス: `/extensions/stock-transfer-loss/src/screens/LossScreen.jsx`, `/extensions/stock-transfer-loss/src/screens/loss/LossProductList.jsx`, `/extensions/stock-transfer-loss/src/screens/loss/LossConditions.jsx`, `/extensions/stock-transfer-loss/src/screens/loss/LossHistoryList.jsx`, `/extensions/stock-transfer-loss/src/screens/loss/FixedFooterNavBar.jsx`  
  - 入庫: `/extensions/stock-transfer-inbound/src/screens/InboundListScreen.jsx`  
  - 出庫: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`  
  - その他: 各拡張の Modal、InboundUiParts、InventoryCountConditions、InventoryCountList 等

### 12.27 入庫・棚卸まとめて表示UI・棚卸下書き修正（2026-02）✅ 完了

#### 1. 入庫複数シップメント・まとめて表示
- **処理済みシップメントの編集制御**: 処理済み（RECEIVED/TRANSFERRED）のシップメントの商品リストで数量ボタンをグレーアウト。`shipmentIdToReadOnly` Map で各シップメントの状態を判定し、`renderInboundShipmentItems_` に `readOnly` を渡す。編集試行時は `denyEdit_` でトースト表示。
- **ステータスバッジ・件数表示**: シップメントタイトル行（タイトル＋右寄せ）にステータスバッジ（入庫済み/未入庫）と件数（〇件）を表示。`s-stack direction="inline" justifyContent="space-between"` でレイアウト。

#### 2. 入庫複数シップメント・シップメントごと表示
- **処理済み時のグレーアウト**: 確定済み（readOnly）の InboundList で、検索枠（disabled＋opacity: 0.6）と InboundCandidateRow の数量ボタン・追加ボタン（disabled＋tone="subdued"）をグレーアウト。`readOnly` を InboundCandidateRow に渡す。

#### 3. 棚卸複数商品グループ・まとめて表示
- **ステータスバッジ化**: 商品グループタイトル右のステータスを `s-text` から `s-badge` に変更（完了済み/未完了）。
- **件数の括弧削除**: `(3/5)` → `3/5`、`(5件)` → `5件`、`(0件)` → `0件` に変更。

#### 4. 棚卸自動下書き・復元の不具合修正
- **要因**: ①Storage API が `{ [key]: value }` 形式で返す環境があり、直接オブジェクトとして扱うと countId 等が取得できなかった。②count.id / locationId が GID 形式と数値形式で揺れ、比較に失敗していた。
- **修正内容**:
  - Storage 取得時に `got?.[key] ?? got` パターンを適用（入庫と同様）。単一・複数グループ両方の draft 読み込みに適用。
  - countId / locationId の比較で `norm(id)`（GID 末尾抽出）を使った正規化比較を追加。
  - `currentGroupId` の重複宣言を削除（316行目と327行目で二重定義されていた問題）。

#### 5. 棚卸複数商品グループの下書きを商品グループIDごとに連動（2026-02）✅ 完了
- **現象**: ①複数商品グループの棚卸IDで、商品グループリストから「1つだけ選んで表示」して自動保存すると、別のグループを開いても同じ商品リストが復元されてしまう。②まとめて表示で編集した内容と、グループごとに表示して保存した内容が連動せず独立してしまう。
- **要因**: 商品グループを1つ選んで表示するとき、親は `productGroupIds: [選んだ1つ]` しか渡すため、`targetProductGroupIds.length === 1` となり、複数グループ用の per-group キーではなくレガシーキー（単一キー）で保存・復元していた。その結果、どのグループを開いても同じレガシーキーを読むため「全て同じ商品リストで復元」されていた。
- **修正内容**:
  - 下書きのキー判定を「表示中のグループ数」（`targetProductGroupIds.length > 1`）ではなく「棚卸IDが複数グループを持っているか」（`count.productGroupIds.length > 1`）に変更。変数 `countHasMultipleGroups` を追加。
  - **読み込み**: 単一グループモード時、`countHasMultipleGroups` が true の場合は常に「現在表示中の商品グループID」の per-group キーからのみ復元。これにより商品グループリストから1つだけ選んで表示している場合も、そのグループ用キーから正しく復元される。
  - **保存**: `countHasMultipleGroups` が true のときは、表示方法（グループごと／まとめて）に関係なく、常にグループIDごとのキーに分割して保存。まとめて表示とグループごと表示で同じキーを参照するため連動する。
  - **単一商品グループの棚卸ID**: `count.productGroupIds` が無い、または長さ1の場合は従来どおりレガシーキーのみを使用。既存の単一グループ棚卸の自動保存・復元には影響なし。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### 6. ロス商品リストヘッダー・検索追加トースト
- **ロス**: ヘッダーの画像表示とリセットボタンを2つとも右寄せ（`justifyContent="end"`）。
- **トースト**: 棚卸・入庫の検索追加トーストを出庫ベースに統一（「〇〇 を追加しました（+N）」形式）。

- **実装ファイル**:  
  - 入庫: `/extensions/stock-transfer-inbound/src/screens/InboundListScreen.jsx`, `/extensions/stock-transfer-inbound/src/InboundUiParts.jsx`  
  - 棚卸: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`  
  - ロス: `/extensions/stock-transfer-loss/src/screens/loss/LossProductList.jsx`

### 12.25 商品リストヘッダー・再読込統一・配送一覧フッター（2026-02）✅ 完了

#### 1. 商品リストヘッダーの検索枠以外のボタンを上下中央配置
- **対応内容**: 商品リストのヘッダーで、検索枠以外のボタン（画像表示・全入庫・リセット等）を縦方向で中央揃えに変更。
- **実装**: 入庫 InboundListScreen.jsx のヘッダー行（左：テキストブロック、右：ボタン群）の `alignItems="flex-start"` を **`alignItems="center"`** に変更。出庫履歴商品リストのヘッダーは既に `alignItems="center"` のため変更なし。
- **実装ファイル**: `/extensions/stock-transfer-inbound/src/screens/InboundListScreen.jsx`

#### 2. ボタン「再取得」を全て「再読込」に統一
- **対応内容**: ボタンラベル「再取得」と「再読込」の混在を解消し、全拡張で**「再読込」**に統一。ローディング中の表記は「取得中...」→**「読込中...」**に統一。
- **対象ファイル**: 出庫（ModalOutbound.jsx）、入庫（InboundListScreen.jsx, InboundShipmentSelection.jsx, Modal.jsx）、ロス（LossConditions.jsx, LossHistoryList.jsx）、棚卸（InventoryCountConditions.jsx, InventoryCountProductGroupSelection.jsx）。メッセージ「再取得を試してください」→「再読込を試してください」（LossConditions.jsx）も統一。

#### 3. 配送一覧のページフッター（左：戻る、中央：再読込、右：キャンセル）
- **対応内容**: 出庫の配送一覧（OutboundShipmentSelection）のフッターを**左：戻る、中央：再読込、右：キャンセル**の3構成に変更。中央ボタンは loadTransfer（ローディング時「読込中...」）、右ボタンはキャンセル。
- **実装**: FixedFooterNavBar に leftLabel="戻る", middleLabel="再読込"（loading 時は「読込中...」）, rightLabel="キャンセル" を渡す形に変更。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`

#### 4. 配送一覧のキャンセルボタン（グレーアウト・確認モーダル）
- **キャンセル不可時**: トランスファーのステータスが TRANSFERRED または CANCELED の場合はキャンセル不可。キャンセルボタンを **rightDisabled={true}** で無効化（グレーアウト）。
- **キャンセル可時**: キャンセルボタンタップで確認モーダル（「この出庫をキャンセルします。よろしいですか？」＋戻る／キャンセルする）を表示。履歴商品リストのキャンセルモーダルと同じ文言・フロー。モーダル内「キャンセルする」で executeCancelFromShipmentList を実行（inventoryTransferCancelSafe → 在庫を出庫元に戻す detail.lineItems の processableQuantity で deltas 構築 → ensureInventoryActivatedAtLocation → adjustInventoryAtLocationWithFallback → appendInventoryTransferNote_ → トースト「キャンセルしました」→ モーダル閉じる → loadTransfer）。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`（OutboundShipmentSelection 内の canCancelFromShipmentList, CONFIRM_CANCEL_SHIPMENT_LIST_MODAL_ID, executeCancelFromShipmentList, s-modal）

### 12.23 出庫：仮想行・配送情報モーダル・確定/下書き2種・在庫更新・シップメントID（2026-02）✅ 完了

#### 1. Transfer の lineItems を仮想行として表示
- **目的**: 管理画面の「発送準備完了」ブロック（Shipment ID なし）をアプリのシップメントリストでも表示し、表示と管理画面を一致させる。
- **対応内容**: Transfer が READY_TO_SHIP かつ lineItems を持つ場合、シップメントリストの**先頭**に仮想行を追加。仮想行の ID は `__transfer__${transferId}`、ラベルは **#T0127-L**（L = Line items）。実 Shipment は **#T0127-1, #T0127-2...** とし、管理画面のシップメント ID と重複しない形式に統一。
- **参照**: `docs/OUTBOUND_TRANSFER_VS_SHIPMENT_STATUS.md`

#### 2. 仮想行タップ時の商品リスト（lineItems のみ表示）
- **問題**: 仮想行をタップすると、発送準備完了以外の下書き・処理中の Shipment の商品までまとめて表示されてしまう。
- **対応内容**: 仮想行選択時は **Transfer の lineItems のみ**を表示。`loadDetail_` で `selectedShipmentId` が `__transfer__` で始まる場合は、`fetchInventoryShipmentEnriched` をスキップし、`d.lineItems`（fetchInventoryTransferDetailForHistory の Transfer lineItems）のみで items を構築。Shipment ID が付与されていない商品リストのみ表示。

#### 3. 複数シップメント追加・編集時の確定モーダルを「確定」「下書き」の2種に
- **対応内容**: ③複数シップメント「追加」および ②④複数シップメント「編集」時は、「配送準備完了にする」を非表示とし、**「確定する」「下書き保存」の2種のみ**表示。③の下書き保存は `createInventoryShipmentDraft`、②④の下書き保存は `inventoryTransferSetItems`（仮想行/Transfer lineItems の更新）。
- **参照**: `docs/OUTBOUND_CONFIRM_FLOWS.md`

#### 4. 出庫リストに「配送情報」ボタン・モーダル
- **目的**: 複数シップメントをアプリだけで作成する際、2つ目以降の配送情報（配送業者・追跡番号・到着予定日）を入力できるようにする。
- **対応内容**: OutboundList ヘッダーに「軽量」「在庫更新」の横に**「配送情報」**ボタンを追加。タップでモーダルを開き、コンディション画面と同様の入力（配送業者・配送番号・到着予定日、1日後/2日後/クリア）が可能。モーダル内の閉じるボタンは1つのみ（標準の閉じるで統一）。

#### 5. 「在庫再取得」→「在庫更新」に名称変更
- **対応内容**: 出庫・入庫・ロス・棚卸の各リスト画面で、ヘッダーボタン表記を「在庫再取得」から**「在庫更新」**に統一。
- **対象ファイル**: ModalOutbound.jsx, OutboundListScreen.jsx, Modal.jsx, Screens.jsx, Screens_part2.jsx, Modal_tmp.jsx, InventoryCountList.jsx

- **実装ファイル**: `/extensions/stock-transfer-tile/src/ModalOutbound.jsx`

### 12.24 POS入庫リストの Jt TDZ エラー対策（2026-02）✅ 完了

#### 問題
- **現象**: 本番ビルド（minify）で「Cannot access 'Jt' before initialization」が発生。
- **原因**: 入庫リスト画面（`InboundListScreen.jsx`）内で定義した `incRow` / `setRowQty` / `setExtraQty` / `incExtra` が minify で短い変数名（Jt 等）に圧縮され、参照順で Temporal Dead Zone (TDZ) になっていた。

#### 対応内容
- **モジュールレベルへ移動**: 上記4関数を `incRow_` / `setRowQty_` / `setExtraQty_` / `incExtra_` としてモジュールレベルに定義。必要な ref・setter・toast は引数で渡す。
- **呼び出し側**: `addOrIncrementByResolved` 内では `incRow_(readOnlyRef, toastReadOnlyOnceRef, toast, rowsRef, setRows, existing.key, delta)` を直接呼び出し。JSX では `setRowQty` / `setExtraQty` をコンポーネント内の const にせず、`(key, qty) => setRowQty_(readOnlyRef, ...)` のようにインラインで渡す。
- **参照**: `docs/INBOUND_LIST_SCREEN_COMPLETE_CHECK.md` の「0. Minify 時の TDZ エラー対策」に Jt 対応を追記済み。

- **実装ファイル**: `/extensions/stock-transfer-inbound/src/screens/InboundListScreen.jsx`

### 12.20 コレクション・SKUリストの下線追加＆コレクション商品選択モーダル強化（2026-02）✅ 完了

#### 1. コレクション・SKUリストの下線追加
- **対応内容**: コレクション一覧・SKU一覧の各項目の下に `borderBottom: 1px solid #e5e7eb` の区切り線を追加
- **選択時の処理**: 選択中（緑枠）の項目は下線を非表示にし、枠線が優先されるように
- **目的**: 一覧の視認性向上

#### 2. get_collection_products APIのページネーション対応
- **問題**: 従来は `products(first: 250)` で最大250商品のみ取得。10000SKU超のコレクションでは商品が欠落
- **対応**: `products(first: 250, after: cursor)` と `pageInfo.hasNextPage / endCursor` でループし、コレクション内の全商品を取得

#### 3. コレクション商品選択モーダルの強化
- **問題**: 1コレクションに10000SKU超があると、全件をDOMレンダリングするため重くなる
- **対応内容**:
  - **検索枠**: SKU・商品名・JANで絞り込み（プレースホルダー：「SKU・商品名・JANの一部で絞り込み」）
  - **選択済みボタン**: 選択済み商品のみ表示に切り替え（メインリストと同じトンマナ）
  - **ページネーション**: 1000件/ページで表示、モーダル下部に「前へ」「1-1000 / 全X件」「次へ」
  - **下線**: 各商品の下に区切り線を追加
  - **全選択・全解除**: 既存ボタンを検索・選択済みの横に配置し、レイアウト整理
- **モーダルオープン時**: 検索・選択済み表示・ページ番号を初期化

- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

### 12.28 管理画面：入出庫モーダル棚卸UI寄せ・進捗最下部・予定外別ブロック・ステータスバッジ（2026-02）✅ 完了

#### 1. 入出庫履歴モーダルを棚卸UIに寄せた表示
- **Action**: 戻り値に `groupedLineItems`（`GroupedLineItemsEntry[]`）を追加。配送ごとに `shipmentMetadata`（id, displayId, status）と `items` をまとめ、予定外入庫は最後に「予定外入庫」ブロックとして追加。従来の `lineItems` はCSV用に維持。
- **モーダル上部**: 数量に加え**進捗状況**を情報欄の最下部に表示。各配送は「表示ID: 入庫済み/未入庫（入庫数/予定数）」を緑/黄で色分け。予定外は「予定外入庫: N件」。
- **モーダル本文**: 1テーブルではなく**配送ごとのブロック**。各ブロックはタイトル行（配送ID＋ステータス）＋その配送の明細テーブル（配送ID・配送ステータス列は省略）。商品0件の配送は「この配送には商品がありません」。背景は入庫済み `#f0f8f0`、未入庫 `#fff8f0`、予定外 `#fff5f5`。
- **実装ファイル**: `/app/routes/app.history.tsx`

#### 2. 棚卸モーダルの進捗状況・単一ブロック・予定外別ブロック
- **進捗状況の表示位置**: 情報欄内を「棚卸ID・ロケーション・商品グループ・ステータス・作成日時・完了日時」の後にし、**進捗状況**を最下部に配置。予定外がある場合は「予定外: N件」を進捗の最後に追加。
- **単一グループ時もブロック＋背景**: 単一商品グループの場合も、複数と同じブロック（padding・角丸・背景色：完了 `#f0f8f0`、未完了 `#fff8f0`）とタイトル行で表示。
- **予定外を別ブロックで表示**: 各グループのテーブルには通常商品のみ表示。全グループの予定外を集め、一覧の**最後**に「予定外（N件）」ブロック（背景 `#fff5f5`、行は `#ffe6e6`）を追加。
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

#### 3. 入出庫・ロス・棚卸のステータスをバッジ表示に統一
- **対象**: 入出庫履歴（app.history）、ロス（app.loss）、棚卸（app.inventory-count）の一覧およびモーダル内のステータス表示。
- **実装**: 各ファイルに `getStatusBadgeStyle(status)` を追加。ピル型（`padding: 2px 8px`、`borderRadius: 9999px`、`fontSize: 12px`、`fontWeight: 600`）。完了系=緑、キャンセル系=グレー/赤系、進行中・下書き=青/グレーなどステータス別に背景・文字色を設定。「状態: 〇〇」をバッジのみの表示に変更。モーダル内の「ステータス: 〇〇」もバッジ表示に変更。
- **実装ファイル**: `/app/routes/app.history.tsx`、`/app/routes/app.loss.tsx`、`/app/routes/app.inventory-count.tsx`

### 12.29 POS 棚卸アプリの読み込み速度（入庫並み対応）（2026-02）✅ 完了

**対象**: 棚卸タイル（stock-transfer-stocktake）の **POS アプリ**側のみ。管理画面（`/app/inventory-count`）は対象外。

#### 背景
- 入庫は「1クエリで配送＋明細（数量含む）」を取得するため表示が速い一方、棚卸は「商品リスト取得＋在庫を商品ごとに取得」していたため、一覧の数量表示と商品リスト表示に遅延が発生していた。
- 要因の詳細は `docs/POS_STOCKTAKE_SLOWNESS_ANALYSIS.md` に記載。

#### 対応内容（表示は省略せず、入庫並みの体感速度に）
1. **商品リストの在庫取得をバッチ並列化し currentQuantity を返す**（stocktakeApi.js）  
   - `filterByInventoryLevel: true` 時、在庫取得を「1件ずつ直列」→「15件ずつ Promise.all で並列」に変更。返すオブジェクトに `currentQuantity` を付与。
2. **商品リストの二重取得を廃止**（InventoryCountList.jsx）  
   - `fetchProductsByGroups` の返り値の `currentQuantity` をそのまま使用し、表示用の再取得（getCurrentQuantity 全件）を削除。
3. **商品グループ名のキャッシュ**（stocktakeApi.js）  
   - `getProductGroupName` 内で `readProductGroups()` を 60秒 TTL のメモリキャッシュで再利用。一覧の名前表示時の API 呼び出しを削減。
4. **一覧の未完了グループ取得を並列化**（InventoryCountConditions.jsx）  
   - 未完了グループごとの「商品リスト取得→在庫合計」を、最大 3 グループ同時実行に変更。

#### 実装ファイル
- `/extensions/stock-transfer-stocktake/src/screens/stocktake/stocktakeApi.js`
- `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`
- `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountConditions.jsx`

### 12.12 本チャット時点での棚卸不具合の整理（2026-01-27）

※この節は、ユーザーとのチャットで確認した「まだ解消していない挙動」と、その時点で特定できた要因をメモしたものです。  
コードの最終状態とは完全には一致しない可能性がありますが、「どこを見れば良いか」の道標として残しています。

- **状態A: 管理画面で完了しているはずの商品グループが未完了になっている**
  - **現象**:
    - POS側（`InventoryCountProductGroupSelection`）では「処理済み」と判定されている商品グループが、管理画面の棚卸履歴では「未完了」と表示されている。
  - **要因候補**:
    - 管理画面側（`app.inventory-count.tsx`）の完了判定は、複数グループの場合に **`groupItems` のみ** を信用しており、`items` フィールドを後方互換として参照しない設計になっている。
    - 一方、POS側のグループ判定（`InventoryCountProductGroupSelection.jsx`）は、`groupItems[groupId]` が空のときに **`items` から対象グループの商品だけをフィルタリングして完了判定** をしている。
    - そのため「`items` にはデータがあるが、`groupItems` がまだ埋まっていない（または古い形式のデータ）」という棚卸IDについては、  
      - **POS** … `items` を見て「処理済み」と判定  
      - **管理画面** … `groupItems` が空なので「未完了」と判定  
      というズレが発生している。
  - **現時点の方針メモ**:
    - 管理画面側で複数グループに対しても `items` を使った厳密なフィルタリングを行うには、GraphQLで商品リストを引き直すなどの **非同期処理** が必要になるが、Remixのloader内では重くなりやすい。
    - そのため現状は「複数グループの完了判定は `groupItems` を唯一の信頼ソースとし、`items` は単一グループの後方互換に限定する」方針になっており、**旧形式データや移行途中データでは表示のズレが残る** 可能性がある。

- **状態B: アプリ（まとめて表示）で未完了グループの商品リストが出てこない** ✅ 解決完了（2026-01-27）
  - **現象**:
    - まとめて表示モードでは、完了済みグループは正しく「完了済み（実数も正しく表示）」される。
    - しかし「未完了」側のグループは、グループ名と「商品を読み込み中…」までは表示されるものの、その下の **商品リストが最後まで描画されない**。
  - **原因**:
    - `loadProducts`関数の最初の処理ブロック（単一グループモード用）で`isReadOnly && storedItems`の条件が`true`になり、そこで`return`して終了していた。
    - まとめて表示モードの処理（`if (isMultipleMode)`）に到達していなかった。
  - **修正内容**:
    - `isReadOnly && storedItems && !isMultipleMode`の条件に変更し、まとめて表示モードの場合は最初の処理ブロックをスキップするように修正。
    - `filterByInventoryLevel: false`に変更し、在庫レベルが0でも商品を表示するように修正。
    - まとめて表示モードの処理完了後、未完了グループがある場合は`isReadOnlyState`を`false`に設定するように修正。
  - **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

- **状態C: アプリ側の完了判定と管理画面の完了判定の思想の違い**
  - **POS側**:
    - ユーザー体験優先で、「`groupItems` が無くても `items` からグループ単位に切り出せれば完了扱いにする」という柔軟な後方互換ロジック。
  - **管理画面側**:
    - データの一貫性優先で、「複数グループの場合は `groupItems` による明示的な完了記録が揃っているときだけ `completed` にする」保守的なロジック。
  - **結果**:
    - 旧データや移行途中データでは「POSでは処理済み／管理画面では未完了」というギャップが発生しうる。  
      今後この差を埋めるには、どちらの基準を正とするか（もしくは管理画面側に移行用ロジックを追加するか）の設計判断が必要。

### 12.13 まとめて表示モードの追加修正（2026-01-27）✅ 修正完了

#### 修正1: 全数量反映ボタンとリセットボタンが確定済みグループまで編集してしまう問題 ✅ 解決
- **現象**: まとめて表示モードで「全数量反映」ボタンや「リセット」ボタンを押すと、確定済みグループ（`isReadOnly: true`）の商品も編集されてしまう。
- **原因**: `setLines`内の`map`処理で、`isReadOnly: true`の商品も含めて全ての商品を更新していた。
- **修正内容**: 
  - 「全数量反映」ボタンと「リセット」ボタンの処理で、`isReadOnly: true`の商品は元のデータをそのまま返すように条件を追加。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`（1608-1636行目）

#### 修正2: まとめて表示モードで確定ボタンを押した際、カウントしていないグループも確定されてしまう問題 ✅ 解決
- **現象**: まとめて表示モードで、グループ1（確定済み）、グループ2（未確定でカウント済み）、グループ3（まだカウントしていなくて全て0）の状態で確定ボタンを押すと、グループ3も確定されてしまう。
- **原因**: `hasCountedItems`の判定条件が`actualQty > 0 || currentQty !== actualQty`となっており、`currentQuantity = -1`、`actualQuantity = 0`（未カウント）の場合も`currentQty !== actualQty`が`true`になってしまっていた。
- **修正内容**: 
  - `hasCountedItems`の判定条件を`actualQty > 0 || (actualQty !== 0 && currentQty !== actualQty)`に変更。
  - `actualQuantity === 0`の場合は、カウントしていないと判断し、確定しないように修正。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`（1011-1015行目、1132-1136行目、1243-1247行目、1430-1434行目）

#### 修正3: まとめて表示モードでの自動保存と復元機能の追加 ✅ 追加完了
- **現象**: まとめて表示モードでは、自動保存は機能していたが、下書きの復元が機能していなかった。
- **原因**: 下書きの復元処理が単一グループモードのセクションにのみ実装されており、まとめて表示モードのセクションには実装されていなかった。
- **修正内容**: 
  - まとめて表示モードの処理開始時に、下書きを読み込む処理を追加。
  - 下書きがあれば優先的に復元し、`productGroupId`と`isReadOnly`も正しく復元するように修正。
  - まとめて表示モードでも下書き復元時に`isReadOnlyState`を適切に設定するように修正。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`（372-420行目）

#### 修正4: デバッグ用トーストメッセージの削除 ✅ 完了
- **内容**: まとめて表示モードのデバッグ用トーストメッセージ（`[DEBUG]`で始まるもの）と画面表示のデバッグ情報を削除。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### 修正5: まとめて表示モードでの自動保存・復元機能の修正 ✅ 完了（2026-01-27）
- **問題**: まとめて表示モードで一度棚卸リストに戻って再度まとめて表示を表示した際、自動保存が空の`lines`で上書き保存され、下書きが0件になって復元されない。
- **原因**: 
  - `loadProducts`が呼ばれた際、下書きを読み込む前に`lines`が空の状態になり、自動保存の`useEffect`が空の`lines`で上書き保存していた。
  - 自動保存時に`isReadOnly`が保存されていなかった。
  - `draftLoadedRef.current`が一度`true`になると、`count.id`や`locationId`が変わってもリセットされず、下書き読み込みがスキップされていた。
- **修正内容**: 
  - `isLoadingProductsRef`を追加し、`loadProducts`実行中は自動保存をスキップするように修正。
  - 自動保存時に`isReadOnly`も保存するように修正。
  - まとめて表示モードでは、`draftLoadedRef`のチェックを行わず、毎回下書きを読み込むように修正。
  - `count.id`や`locationId`が変わったときに`draftLoadedRef`をリセットする処理を追加。
- **実装ファイル**: `/extensions/stock-transfer-stocktake/src/screens/stocktake/InventoryCountList.jsx`

#### 修正6: 入庫処理のまとめて表示モードでの自動保存・復元機能の追加 ✅ 完了（2026-01-27）
- **問題**: 入庫処理のまとめて表示モードでは、自動保存・復元機能が実装されていなかった。
- **修正内容**: 
  - `loadMultipleShipments`関数に下書き読み込み処理を追加。
  - 下書きから復元する際のマッチングロジックを修正（`shipmentId`と`shipmentLineItemId`の両方で一致）。
  - 下書きから復元した際に`extras`、`reason`、`note`、`onlyUnreceived`も復元。
  - 自動保存処理を修正（まとめて表示モードでも`transferId`があれば保存可能、`shipmentId`も保存）。
- **実装ファイル**: `/extensions/stock-transfer-tile/src/Modal.jsx`

### 12.14 棚卸履歴モーダルの改善（2026-01-27）✅ 修正完了

#### 修正1: 予定外商品の赤背景表示（単一商品グループの場合）✅ 解決
- **現象**: 入庫履歴モーダルでは予定外商品に赤背景がついているが、棚卸履歴モーダルでは予定外商品に赤背景がついていない（単一商品グループの場合）。
- **原因**: 
  - 複数商品グループの場合: `isExtra`フラグを判定し、赤背景を設定していた（2293行目）。
  - 単一商品グループの場合: `isExtra`フラグを判定していなかった（2382行目）。
- **修正内容**: 
  - 単一商品グループの場合でも、`isExtra`フラグを判定し、`true`の場合は`backgroundColor: "#ffe6e6"`を設定するように修正。
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`（2363-2382行目）

#### 修正2: 複数商品グループのモーダルで完了の商品グループが初回モーダルを開いた際に2秒ほどは完了の表示になっているが、2秒後ぐらいに未完了になってしまう問題 ✅ 解決
- **現象**: 複数商品グループのモーダルで、完了の商品グループの商品リストが初回モーダルを開いた際に2秒ほどは完了の表示になっているが、2秒後ぐらいに未完了になってしまう。モーダルを閉じて再度開いた際には完了にもどる。
- **原因**: 
  - 未完了グループ判定ロジック（834-837行目）と完了判定ロジック（2200-2212行目）でキー取得方法が異なっていた。
  - 未完了グループ判定では、`groupItemsMap[groupId]`が直接存在するかどうかしかチェックしていなかった。
  - 完了判定では、キーの型を考慮した複数のチェックを行っていた。
  - そのため、キーの型が一致しない場合、完了済みグループが誤って`incompleteGroupIds`に含まれ、`incompleteGroupProducts`が更新されると、完了判定が`false`になってしまっていた。
- **修正内容**: 
  1. 未完了グループ判定ロジックを、完了判定ロジックと同じ方法に統一（キーの型を考慮した複数のチェックを追加）。
  2. `completedGroupsMap`を追加し、`itemsByGroup`の構築時に完了済みとして設定されたグループを追跡。
  3. 完了判定ロジックで、`wasCompletedInItemsByGroup`が`true`の場合、`incompleteProductsForGroup`の値に関係なく完了済みと判定。
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`（833-851行目、2039-2240行目）

#### 修正3: CSV出力の改善 ✅ 解決
- **問題1**: 複数グループの場合、商品グループ列に全てのグループ名がカンマで繋がっている → 対象の商品の対象商品グループに変更したい。
- **問題2**: ステータス未完了の商品グループが一つでもある場合、完了の商品グループも進行中となっている → 完了している商品グループの商品は完了にしたい。
- **問題3**: 予定外の商品がCSVでわからないので、予定外の列を追加して予定外と出力されるようにしたい。
- **原因**: 
  - CSV出力ロジックとモーダル表示ロジックが異なっていた。
  - CSV出力では、全てのグループ名をカンマで結合していた。
  - CSV出力では、`modalCount.status`を使用していたため、全ての商品が同じステータスになっていた。
  - 予定外商品を識別する列がなかった。
- **修正内容**: 
  1. CSV出力ロジックをモーダル表示ロジックと同じ方法に統一（キーの型を考慮、後方互換性対応）。
  2. 各商品にグループ情報を追加: `itemsByGroup`から取得した商品に、`groupId`、`groupName`、`isGroupCompleted`を追加。
  3. 商品グループ列の修正: 各商品が属するグループの名前のみを表示。
  4. ステータス列の修正: 各商品が属するグループが完了済みか未完了かを判定し、「完了」または「進行中」を表示。
  5. 予定外列の追加: `isExtra`フラグをチェックし、「予定外」または空文字を表示。
- **実装ファイル**: `/app/routes/app.inventory-count.tsx`（2462-2618行目）

### 12.15 棚卸管理画面UI・商品グループ作成方法の拡張（2026-01）✅ 完了

#### 商品グループ作成方法の3方式対応
- **コレクションから作成**: 既存のコレクション選択に加え、「コレクションで絞り込み」「選択済み」トグルで一覧をフィルター表示。
- **SKU選択から作成**: loader でバリアント一覧を最大1000件取得し、クライアントで SKU・商品名・JAN・オプションで絞り込み。useFetcher 廃止で検索結果の表示不具合を解消。「選択済み」トグル対応。表示形式は商品名/SKU/JAN/オプションの4行。
- **CSVで一括登録**: 「グループ名,SKU」形式のCSVでコレクションに依存せずグループを定義。CSVテンプレートダウンロードボタンを「CSVでインポート」付近に配置。

#### タブ・ボタン・編集中バナーのスタイル統一
- 上部タブ（商品グループ設定 / 棚卸ID発行 / 履歴）: 選択時のみ `background: #e5e7eb`、`borderRadius: 8px`。
- 商品グループ作成ボタン（コレクションから作成 / SKU選択から作成 / CSVで一括登録）: 同様の選択時スタイルに統一。
- 編集中バナー: 背景・枠を薄グレーに変更。「（コレクションから作成）」等の接尾辞を削除し「「{グループ名}」編集中」のみ表示。長文のはみ出し防止のスタイルを追加。

#### バグ修正
- **編集中の編集が戻る**: グループ編集でコレクションを外すと数秒で元に戻る問題。編集中フォーム初期化の useEffect の依存配列を `[editingGroupId]` のみに変更し、loader 再検証時に上書きされないように修正。
- **SKU検索が表示されない**: 初回から loader でバリアント一覧を取得し、クライアント絞り込みに一本化。useFetcher による検索を廃止し表示を安定化。

- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

### 12.16 SKU/CSVグループの確認・編集・CSVエクスポート・10000行対応（2026-01）✅ 完了

#### SKU/CSV由来グループの確認・編集
- **編集時の挙動**: SKU指定のみのグループ（コレクションなし・inventoryItemIds あり）で「編集」を押すと「SKU選択から作成」タブに切り替え、選択済みSKUを復元。
- **一覧外SKUの維持**: loader の skuVariantList（最大1000件）に含まれない inventoryItemId は `editingSkuOnlyPreservedIds` で保持。保存時にマージして送信。アクション側で既存グループの skus から一覧外分を補完して保存。
- **右パネル**: SKU指定のみのグループに「SKU一覧（N件）を確認・編集」を表示。クリックで編集モード＋SKUタブに遷移。
- **SKUタブ**: 編集中は「更新」「キャンセル」を表示。選択済み＋一覧外の件数表示。キャンセルで editingGroupId / editingSkuOnlyPreservedIds をクリア。

#### CSVエクスポート・インポートモード
- **登録済みをCSVダウンロード**: SKU指定のグループのみを「グループ名,SKU」形式でCSV出力。コレクションのみのグループは含めない。
- **インポートモード**: 新規作成（既存のグループ名はスキップ）・追加（同じグループ名にSKUを足す）・上書き（同じグループ名のSKUをCSVの内容で置き換え）。選択肢の並びは新規作成・追加・上書き。
- **結果件数**: 実際に作成・更新したグループ数（importedCount）を返却・表示。

#### CSV最大10000行・バッチ処理
- **行数上限**: 1ファイル最大10000行（従来2000行から変更）。
- **SKU解決の分岐**: `resolveSkusToInventoryItemIds` で、3件以下は従来の1 SKU 1クエリ。4件以上はバッチ（25件/クエリの `sku:A OR sku:B OR ...`）＋並列10本で実行。OR クエリ失敗時はそのバッチのみ1件ずつフォールバック。
- **定数**: `SKU_BATCH_SIZE = 25`、`SKU_BATCH_CONCURRENCY = 10`（必要に応じて調整可能）。

- **実装ファイル**: `/app/routes/app.inventory-count.tsx`

### 12.30 発注機能：発注先編集・原価・販売価格取得・CSV出力拡張（2026-02-05）✅ 完了

#### 1. 発注先編集機能（商品リストモーダル内）
- **実装内容**: 管理画面の発注商品リストモーダル内で、発注先を編集できる機能を追加。
- **UI**: 
  - 発注先表示の横に「編集」ボタンを配置
  - 編集モードでは検索・入力フィールドと発注先リスト（発注先マスタから選択）を表示
  - 発注先マスタから選択、または自由入力で設定可能
  - 「保存」「キャンセル」ボタンで編集を確定または取り消し
- **動作**: 
  - 発注先を選択または保存すると、発注データに反映され、商品リストの再読み込みを防ぐ実装
  - 編集モードの状態管理と、`useEffect`の最適化により、不要な再レンダリングを防止
- **実装ファイル**: `/app/routes/app.order.tsx`（1851-2027行目）

#### 2. 原価と販売価格の取得・保存
- **実装内容**: 商品リスト取得時（`loadItems` intent）に、variantの原価（`inventoryItem.unitCost.amount`）と販売価格（`variant.price`）を取得し、発注データに保存。
- **データ構造**: 
  - `OrderRequestItem`型に`cost?: number`（原価）と`price?: number`（販売価格）フィールドを追加
  - 既存データとの互換性を保つため、オプショナルフィールドとして定義
- **取得処理**: 
  - variantIdがある商品について、GraphQLで一括取得（`nodes(ids: [...])`）
  - 取得した原価・販売価格を`items`に付与し、発注データに保存
  - 既存の値があれば保持、なければ新規取得
- **実装ファイル**: `/app/routes/app.order.tsx`（16-27行目：型定義、630-732行目：取得処理）

#### 3. CSV出力項目に販売価格を追加
- **実装内容**: CSV出力項目に「販売価格」を追加し、設定画面で選択・並び替え可能に。
- **CSV列定義**: 
  - `OrderCsvColumn`型に`"price"`を追加（`app.settings.tsx`）
  - `ALL_CSV_COLUMNS`に`"price"`を追加
  - CSV列名マッピングに`price: "販売価格"`を追加
- **CSV出力処理**: 
  - CSV出力時に`cost`と`price`を出力（保存された値を使用）
  - 値が未設定の場合は空文字を出力
- **実装ファイル**: 
  - `/app/routes/app.order.tsx`（1331行目：列名マッピング、1419-1422行目：CSV出力）
  - `/app/routes/app.settings.tsx`（57行目：型定義、249行目：validColumns、906行目：列名マッピング）

#### 4. 不具合修正
- **発注先選択時に承認モーダルが表示される問題**: 
  - `useEffect`の条件分岐を修正し、発注先更新の処理を先にチェックするように変更
  - `"destination" in fetcher.data`を先に評価することで、承認処理と混同しないように修正
- **発注先選択・保存時に商品リストが再読み込みされる問題**: 
  - `useEffect`の依存配列から`modalEntry`を削除し、`modalEntryRef`を使用して最新値を参照
  - `modalEntry`の更新を`setTimeout`で遅延実行することで、`useEffect`の再実行を防止
- **承認取り消し後のモーダル挙動**: 
  - 承認取り消し後、モーダルを閉じてページを再読み込みする処理を削除
  - `entries`の状態を直接更新することで、リロードなしで状態を反映

#### 実装ファイル
- `/app/routes/app.order.tsx`（発注先編集UI、原価・販売価格取得処理、CSV出力処理）
- `/app/routes/app.settings.tsx`（CSV出力項目設定に販売価格を追加）

#### 進捗状況
- ✅ **発注先編集機能**: 完了（商品リストモーダル内で編集可能）
- ✅ **原価・販売価格の取得・保存**: 完了（商品リスト取得時に自動取得・保存）
- ✅ **CSV出力項目拡張**: 完了（原価・販売価格を出力可能）
- ✅ **不具合修正**: 完了（発注先選択時の挙動、商品リスト再読み込み防止）
- ✅ **処理確定モーダル文言**: 完了（「仕入予定（#P0000）が作成されました。」と表示。`createPurchaseFromOrder` の `purchaseName` を使用）
- ✅ **CSVファイル名の統一**: 完了（一覧: `機能_日付`、単一: `機能_名称（#P0000等）_日付`。発注単一は `orderName`、仕入一覧/単一は `仕入履歴_日付` / `仕入履歴_${purchaseName}_日付`）
- ✅ **発注→仕入の名称引き継ぎ**: 完了（#P0000 / #P0000-1 の採番と `purchaseName` 保存。`app.order.tsx` の `createPurchaseFromOrder`）
- ✅ **発注・仕入の JAN・オプション補完**: 完了（`loadItems` で variant の `barcode` と `selectedOptions` を API 取得し items に付与。キャンセル時やCSV出力でも利用）

#### 残りのタスク
- ✅ **仕入予定一覧画面**: 発注から作成した #P0000 は既に `/app/purchase` の一覧に表示済み。#B0000 は POS 仕入アプリ実装後に同一一覧に表示される想定。
- ⏸️ **POSアプリからの仕入機能（#B0000）**: **5を進めるには仕入のPOSアプリの開発が必要。**  
  - 新規拡張 `extensions/stock-transfer-purchase` の作成（Phase C）。  
  - コンディション画面・商品リスト・確定で在庫プラス＋`purchase_entries_v1` に #B0000 で保存。  
  - 詳細は `docs/PURCHASE_IMPLEMENTATION_PLAN.md` の「Phase C: POS 拡張「仕入」」および `docs/REQUIREMENTS_PURCHASE_AND_ORDER.md` を参照。

### 12.31 api.log-inventory-change デバッグログ削除・リリース時必須対策の要件整理（2026-02-07）✅ 完了

本チャットで実装・検証・要件決定した内容を反映。

#### 1. api.log-inventory-change のデバッグログ削除 ✅ 完了
- **対象ファイル**: `app/routes/api.log-inventory-change.tsx`
- **削除したログ**:
  - トークン payload を検証せずに base64 デコードして `aud`/`iss`/`dest` 等を出力していたデバッグ用ブロック（401 切り分け用に一時追加していたもの）
  - リクエスト受信時の `[api.log-inventory-change] Called: shop=..., activity=..., item=..., ...` およびそのための変数（rawItemIdLog, rawLocIdLog, qtyAfterLog）
  - `[api.log-inventory-change] Updated admin_webhook to ...` の console.log
- **残置したログ**: 認証エラー時の `No Authorization Bearer header`・`decodeSessionToken error`・`POS auth failed` は本番での原因追跡のため残置。

#### 2. リリース時必須対策の要件整理 ✅ 完了
- **反映先**: RELEASE_REQUIREMENTS_PUBLIC_APP.md に「5. 本番で必須の2つの対策」を新設。
- **内容**:
  - **デプロイすると履歴一覧が消える**: 原因（SQLite が Render のエフェメラルディスクでデプロイごとに消える）と対処（本番では Render PostgreSQL または Supabase 等の永続DBを用意し、DATABASE_URL 設定・Prisma 本番用設定・マイグレーション実施が必須）。デプロイ当日の履歴が消えないようにするための手順と Prisma 設定例を記載。
  - **管理画面を開かないとエラーになる**: 原因（オフラインセッションは管理画面でアプリを開いたときに初めて保存される）と対処（インストール後「1回は管理画面でアプリを開く」旨を利用手順・オンボーディングで案内する運用。任意で POS 側に「管理画面でアプリを一度開いてから再度お試しください」と表示する改善も可能）。
- **参照**: 詳細・本番DBの Prisma 設定例・Render Build Command 例は RELEASE_REQUIREMENTS_PUBLIC_APP.md のセクション5 を参照。
