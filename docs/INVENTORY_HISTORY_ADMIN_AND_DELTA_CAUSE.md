# 在庫変動履歴が「管理」ばかり・変動量が「-」になる要因

**作成日**: 2026年2月9日  
**現象**: B4 確認で、履歴は表示されるがアクティビティが全て「管理」になり、変動量が反映されない（「-」や一部のみ数値）ことがある。

---

## 1. なぜ「管理」ばかりになるか

### 設計の前提

在庫変動の記録は **2 通り** あります。

| 経路 | 役割 | アクティビティの決め方 |
|------|------|------------------------|
| **api/log-inventory-change** | POS や管理画面で「ロス確定」「入庫確定」などをした**直後**にアプリから呼ぶ | 呼び出し時に **loss_entry / inbound_transfer など** を指定して記録 |
| **inventory_levels/update Webhook** | Shopify が在庫変更のたびに送る Webhook | ペイロードに **inventory_adjustment_group_id** があれば GraphQL で種別を判定、**なければ「管理」** として記録 |

意図としては「POS/アプリの操作は api で正しい種別を付けて記録し、Webhook は補助または管理画面のみの操作用」です。

### 要因（「管理」ばかりになる理由）

1. **Webhook のペイロードに `inventory_adjustment_group_id` が含まれない**
   - Shopify の **inventory_levels/update** では、すべての在庫変更でこの ID が送られてくるわけではありません。
   - ペイロードに含まれない場合、種別を判定できないため **activity は常に `admin_webhook`（表示上「管理」）** のままになります（`webhooks.inventory_levels.update.tsx` 215 行付近のデフォルト）。

2. **api/log-inventory-change が呼ばれていない、または失敗している**
   - POS でロス・入庫などを確定したときに、**POS 側またはサーバー側から api/log-inventory-change を呼ぶ**実装になっていれば、そこで「ロス」「入庫」などが付きます。
   - 次のような場合、api 経由の記録が入らず、**Webhook の「管理」の 1 件だけ**が残ります。
     - POS から api を呼ぶ設定（URL・認証）が本番と合っていない
     - セッションがない（初回に管理画面を開いていない等）で 401 になり、api が失敗している
     - ネットワークや CORS でリクエストが届いていない

3. **二重記録の防止で「既に api で記録済みなら Webhook では保存しない」**
   - 同じ変動が api で先に記録されていれば、Webhook 側では保存をスキップします（329–351 行付近）。
   - 逆に、**api の記録が入っていない**と、Webhook の「管理」の 1 件だけが残り、「管理ばかり」に見えます。

**まとめ**: 「管理」ばかりになる主な要因は、  
**(A) Webhook には種別を判定する情報がなくデフォルトで「管理」になること** と、  
**(B) 本来種別を付ける api/log-inventory-change が呼ばれていないか失敗していること** の両方です。

---

## 2. なぜ変動量（delta）が「-」になるか

### 計算の仕組み

- 変動量（delta）は **「今回の変動後数量 − 直前の履歴の変動後数量」** で計算しています（`webhooks.inventory_levels.update.tsx` 136–149 行付近）。
- 「直前の履歴」は **同じショップ・同じ inventoryItemId・同じ locationId** で、**いちばん新しい 1 件** を DB から取得しています。

### 要因（「-」になる理由）

- **その商品・ロケーションの「直前の履歴」がまだ 1 件もないとき**は、`prevAvailable` が null のため **delta も null** になり、画面では「-」と表示されます。
- 例：
  - デプロイ直後や、その SKU・ロケーションで初めて変動が記録されたとき。
  - 別経路（api と Webhook）で同じ変動が別々に記録されず、時系列で「直前」が別の組み合わせになっている場合も、1 件目相当では delta が null になることがあります。

そのため、「最初の 1 件や、その item+location の初回は変動量が「-」になる」のは現在の仕様どおりの動きです。

---

## 3. セッションなしでも記録する仕様（2026年2月対応）

**外部DBを使用していても**、これまでは「インストール直後・再デプロイ直後に管理画面を1回開く」必要があり、開く前に届いた Webhook や POS の API は 401 になっていました。

以下のように変更し、**セッションが無くても最小限の記録**を行うようにしています。

- **Webhook（inventory_levels/update）**
  - セッションが無い場合でも 401 にせず、**HMAC で検証された shop** とペイロードだけで履歴を 1 件保存します。
  - ロケーション名・SKU・種別判定は GraphQL に依存するため、**セッションなし時は「ロケーションID」「SKU は空」「アクティビティは管理」**で保存します。管理画面でアプリを開いたあとの変動からは、これまでどおりロケーション名・SKU・種別が入ります。
- **API（api/log-inventory-change）**
  - セッションが無い場合でも 401 にせず、**JWT から取得した shop** とリクエスト body の内容だけで履歴を保存します。日付はショップタイムゾーンが取れないため **UTC** で計算します。POS が送る sku・locationName・activity はそのまま使うため、種別や表示名は問題なく入ります。

この結果、**管理画面を一度も開かなくても**、在庫変動は履歴に残り、後から管理画面を開けば以降の変動はロケーション名・SKU・タイムゾーン付きで記録されます。

---

## 4. 対応の方向性（何を直すとよいか）

### 「管理」ばかりを減らす

1. **api/log-inventory-change が確実に呼ばれているか確認する**
   - POS でロス確定・入庫確定などをした直後に、本番の `https://（pos-stock の URL）/api/log-inventory-change` に POST が飛んでいるか（ブラウザの開発者ツールやログで確認）。
   - 本番の **appUrl**（POS が参照するベース URL）が、実際の Render の URL と一致しているか確認する（`extensions/common/appUrl.js` 等）。
   - 「インストール後 1 回は管理画面でアプリを開く」を実施し、オフラインセッションが保存されているか確認する（セッションがないと api が 401 になる）。

2. **Webhook で種別を判定できる範囲は限られている**
   - Shopify が `inventory_adjustment_group_id` をペイロードに載せない在庫変更では、Webhook 側では種別を判定できず「管理」のままになります。  
   - ロス・入庫・出庫・棚卸などは **api/log-inventory-change で種別を付ける**前提で、こちらを正しく動かすことが重要です。

### 変動量「-」について

- 同じ SKU・ロケーションで **2 件目以降** の変動からは、直前の履歴が存在するため delta が計算され、数値が入ります。
- 「初回だけ「-」」は現状の仕様なので、仕様として許容するか、または「直前の数量」を DB 以外（例: その時点の在庫 API）から取るように変更するか、という検討になります。

---

## 5. ログでよくある 401（api と Webhook）

本番ログで次のように出ることがあります。

- **POST /api/log-inventory-change 401**  
  POS から呼んだときに 401。レスポンスが `error: "No session found for shop"`, `code: "NO_OFFLINE_SESSION"` の場合は、**その時点で DB にオフラインセッションが無い**ためです。**管理画面でアプリを一度開く**とセッションが作成され、以降の API 呼び出しは 200 になります。

- **POST /webhooks/inventory_levels/update 401**  
  ログに `No session found for webhook` と出る場合も同じで、**まだ誰も管理画面でアプリを開いていない**ためセッションが無く、Webhook を処理できません。**管理画面でアプリを一度開いたあと**は、同じ Webhook が 200 で処理されるようになります。

時系列の例: (1) デプロイ直後に POS が api を呼ぶ → 401（セッション無し）、(2) 同じころ Webhook が届く → 401（セッション無し）、(3) 管理画面でアプリを開く → セッション作成、(4) その後 Webhook が届く → 200 で履歴に保存。  
→ **インストール後・再デプロイ後に「1回は管理画面でアプリを開く」**運用にすると、両方の 401 を防げます。

---

## 6. 参照コード

- アクティビティのデフォルトと種別判定: `app/routes/webhooks.inventory_levels.update.tsx` 215 行付近〜
- 二重記録防止（api で記録済みなら Webhook では保存しない）: 同 327–351 行付近
- delta の計算（直前の quantityAfter を使用）: 同 129–149 行付近
- セッション無し時の 401: 同 76–80 行付近（Webhook）、`app/routes/api.log-inventory-change.tsx` 109–118 行付近（API）
- api/log-inventory-change の呼び出し: POS 拡張（ロス・入庫など）および `app/routes/api.log-inventory-change.tsx`
