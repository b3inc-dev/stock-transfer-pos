# 棚卸複数商品グループ と 入出庫複数配送 のモーダル差分

管理画面の「棚卸履歴」モーダル（複数商品グループ）と「入出庫履歴」モーダル（複数配送）の作り方の違いを整理したドキュメントです。

---

## 1. 棚卸履歴モーダル（複数商品グループ）の作り

### 1.1 データの流れ

| 項目 | 内容 |
|------|------|
| **開くとき** | 一覧で棚卸ID（count）をクリック → `setModalCount(c)` で選択した count を保持 |
| **表示データ** | **完了済み**: `modalCount.groupItems`（count に保存済みの `groupItems[groupId]`）<br>**未完了**: `incompleteGroupProducts`（fetcher で API 取得した「未完了グループの商品リスト」） |
| **未完了の取得** | モーダルを開いたときに `useEffect` で、`productGroupIds` のうち `groupItems` にデータがないグループについて、action に `countId`・`groupId`・`locationId` を渡して商品リストを取得。1グループずつ順次 fetcher で取得し、`incompleteGroupProducts` Map に蓄積 |
| **グループ単位の構築** | `itemsByGroup` Map を構築。各 `groupId` に対し、完了済みなら `groupItemsMap[groupId]`、未完了なら `incompleteGroupProducts.get(groupId)` をセット。キー型揺れ（`groupId` vs `String(groupId)`）の考慮あり |

### 1.2 表示構造（複数グループ時）

- **分岐条件**: `hasMultipleGroups && itemsByGroup.size > 0` のとき「グループごとにセクション分け」表示。
- **レイアウト**:
  1. **合計行**: 「合計: N件」「（実数: X / 在庫数: Y）」「商品グループごとの進捗: M/Lグループ完了」
  2. **スクロール領域内**: `allGroupIds.map` で **グループごとにブロック** を描画。
     - 各ブロック: 外側が `div`（背景色: 完了済み `#f0f8f0`、未完了 `#fff8f0`、角丸・余白あり）
     - ブロック先頭: **タイトル行**（グループ名 ＋ 「（完了済み）」 or 「（未完了）」 ＋ 進捗「（実数/在庫数）」）
     - ブロック内: **1グループ1テーブル**（ヘッダー: 商品グループ, 商品名, SKU, JAN, オプション1〜3, 在庫, 実数, 差分）
     - そのグループに商品が1件もない（未処理）: テーブルは出さず「この商品グループはまだ処理されていません」の文言のみ
  3. **行の識別**: 各行の1列目は「商品グループ」列（グループ名 ＋ 完了/未完了の小さな表示）。予定外商品は行背景を薄赤。

### 1.3 単一グループ時

- `hasMultipleGroups` が false のときは、**1枚のテーブル** のみ（`displayItems` を flat に表示）。
- 列は複数グループ時と同じ（商品グループ, 商品名, SKU, JAN, オプション1〜3, 在庫, 実数, 差分）。

### 1.4 サマリー欄（テーブル上）

棚卸ID, ロケーション, 商品グループ, **進捗状況**（グループごとに「グループ名: 完了済み/未完了（実数/在庫数）」）, ステータス, 作成日時, 完了日時。

---

## 2. 入出庫履歴モーダル（複数配送）の作り

### 2.1 データの流れ

| 項目 | 内容 |
|------|------|
| **開くとき** | 一覧で履歴（Transfer）をクリック → `setModalHistory(history)`。同時に `fetcher.submit({ transferId })` で action に明細取得を依頼 |
| **表示データ** | **全配送をまとめたフラットな配列** `modalLineItems`。action の戻り値 `lineItems` をそのまま `setModalLineItems` で保持 |
| **action 側** | 1回のリクエストで `inventoryTransfer` を取得。`shipments.nodes` をループし、各 shipment の `lineItems.nodes` を集約。各明細に **shipmentId, shipmentDisplayId, shipmentStatus** を付与。shipment に lineItems が無い（下書き等）場合は Transfer の `lineItems` をフォールバックで使用 |
| **グループ分けなし** | サーバーで「配送ごとのブロック」にはせず、**1本の配列** で返す。どの配送に属するかは各行の `shipmentDisplayId`・`shipmentStatus` で判別 |

### 2.2 表示構造（単一・複数とも同じ）

- **分岐なし**: 単一配送でも複数配送でも **常に1テーブル**。
- **レイアウト**:
  1. **合計行**: 「合計: N件」のみ（棚卸のような「〇/〇グループ完了」はなし）。
  2. **1枚のテーブル**: 列は 配送ID, 配送ステータス, 商品名, SKU, JAN, オプション1〜3, 予定数, 入庫数。
  3. **行の識別**: 配送ごとのブロックは作らず、**列「配送ID」「配送ステータス」** でどの配送か・その状態かを表示。予定外は行背景を薄赤。

### 2.3 サマリー欄（テーブル上）

履歴ID, 名称, 日付, 出庫元, 入庫先, ステータス, 数量（received/total）。配送ごとの進捗はサマリーには出さず、テーブル内の「配送ステータス」で見る。

---

## 3. 差分一覧

| 観点 | 棚卸（複数商品グループ） | 入出庫（複数配送） |
|------|---------------------------|---------------------|
| **データ取得** | 完了分は loader の `count.groupItems`。未完了は **モーダル表示時に fetcher でグループ単位に順次取得** し、`incompleteGroupProducts` に保持 | **1回の action** で Transfer の shipments + lineItems（と必要時 Transfer lineItems）を取得し、**1本の lineItems 配列** で返す |
| **データ構造** | グループ単位の Map（`itemsByGroup`）を画面用に構築。完了・未完了でデータソースが異なる（groupItems vs API 取得リスト） | 常に **フラットな lineItems 配列**。各要素に shipmentId / shipmentDisplayId / shipmentStatus を持たせる |
| **UI 構成** | 複数グループ時は **グループごとにセクション（ブロック）を分ける**。1ブロック = タイトル行 + 1テーブル。未処理グループは「まだ処理されていません」 | **常に1テーブル**。配送ごとのブロックは作らない。配送の識別は「配送ID」「配送ステータス」列 |
| **テーブル数** | 複数時: **グループ数と同じだけテーブル**（各ブロック内に1テーブル） | **常に1テーブル** |
| **識別列** | 1列目「商品グループ」（グループ名 + 完了/未完了）。同じ列を全行が持つ | 「配送ID」「配送ステータス」の2列。行ごとに配送が違えば値が変わる |
| **進捗・ステータス** | ブロックのタイトル行で「（完了済み）/（未完了）」＋ 実数/在庫数。色で完了=緑系・未完了=黄系 | テーブル内の「配送ステータス」列で下書き・配送準備完了・入庫済み等を表示 |
| **未処理の扱い** | グループに商品が0件のとき「この商品グループはまだ処理されていません」と明示 | 該当する配送の行が0件なら、その配送の行はそもそも出てこない（配送IDで並べたときに「抜け」で分かる） |
| **サマリー** | 進捗状況で「グループ名: 完了済み/未完了」を一覧表示 | 履歴単位のサマリーのみ。配送別はテーブル内で見る |

---

## 4. まとめ（設計の違い）

- **棚卸**: 「グループ」が単位。**グループごとにブロック＋テーブルを分けて表示**し、完了/未完了をブロックの色・タイトルで示す。データは「完了済み = 保存済み groupItems」「未完了 = 都度 fetcher 取得」の2系統。
- **入出庫**: 「配送」が単位だが、**1本のテーブルで全配送の行を並べ、配送ID・配送ステータス列で識別**。データは1回の action で全配送分をフラットな配列として取得。

入出庫を棚卸に寄せる場合は「配送ごとにブロック＋テーブルを分ける」形にし、その配送の lineItems だけをテーブルに流し込む必要がある。逆に棚卸を入出庫に寄せる場合は、グループごとのテーブルをやめ、1テーブル＋「商品グループ」列（とグループステータス列）にまとめる形になる。

---

**対象ファイル**

- 棚卸: `app/routes/app.inventory-count.tsx`（モーダル開閉・itemsByGroup 構築・複数グループ時のブロック描画）
- 入出庫: `app/routes/app.history.tsx`（モーダル開閉・action で lineItems 取得・1テーブル描画）

**作成日**: 2026年2月
