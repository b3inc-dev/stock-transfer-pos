# 公開アプリ：プラン別機能制御の設計

**目的**: 同じコードベース（stock-transfer-pos）を「カスタムアプリ（自社用）」と「公開アプリ」の両方で使い、公開アプリ側だけ **Lite / Pro** の2プランで機能を制御する。

---

## 1. 前提の確認

| 項目 | 内容 |
|------|------|
| **コードベース** | カスタムアプリと公開アプリで**共通**（同一リポジトリ `stock-transfer-pos`） |
| **カスタムアプリ** | 現状の実装を**そのまま**使用（全機能利用可能、プラン制御なし） |
| **公開アプリ** | プラン（Lite / Pro）に応じて機能を制御する |
| **切り替え方法** | デプロイ先・環境変数で「どちらのアプリか」を判定する（後述） |

---

## 2. プラン構成（仕様）

### 2.1 プランと機能

| プラン | トライアル | 利用できる機能 |
|--------|------------|----------------|
| **Lite** | 7日 | ② 入出庫（POS）／管理画面：入出庫履歴・フィルタ・CSV |
| **Pro** | 14日 | ① 在庫情報 ② 入出庫 ③ 仕入 ④ ロス ⑤ 発注 ⑥ 棚卸（すべて） |

### 2.2 料金（月額 USD）

| プラン | 〜3ロケーション | 〜10 | 〜20 | 20+ |
|--------|-----------------|------|------|-----|
| **Lite** | $19 | $39 | $59 | $79 |
| **Pro** | $59 | $99 | $149 | $199 |

※ ロケーション数はショップのロケーション数に応じて、パートナー側でプラン（Recurring charge）を複数用意する想定です。

---

## 3. 「カスタム」と「公開」の判定

- **カスタムアプリ**: 自社用のデプロイ（例: `stock-transfer-pos.onrender.com`）。  
  → **プラン制御をしない**。常に全機能を表示・利用可能とする。
- **公開アプリ**: App Store 用のデプロイ（例: `pos-stock.onrender.com`）。  
  → **プラン制御を行う**。Lite のときは ② のみ、Pro のときは ①②③④⑤⑥。

**判定方法（案）**

- サーバー側で **環境変数** を使う。  
  - 例: `APP_DISTRIBUTION=inhouse` → カスタム（全機能）  
  - 例: `APP_DISTRIBUTION=public` または未設定 → 公開（プラン制御あり）
- カスタム用の Render サービスには `APP_DISTRIBUTION=inhouse` を設定する。  
- 公開用の Render サービスには `APP_DISTRIBUTION=public` を設定する（または未設定で「公開」とみなす）。

これにより、**同じコード**で「今動いているのがどちらのデプロイか」だけで振る舞いを切り替えられます。

---

## 4. データ・処理の流れ（公開アプリのみ）

### 4.1 プラン情報の取得

- **Shopify Billing API** で、そのショップの「現在の Recurring Application Charge」を取得する。
- パートナーで作成するプラン名（例: `Lite - up to 3 locations`, `Pro - up to 10 locations`）と、アプリ内の **Lite / Pro** を対応させる。
- 取得したプラン名から **`lite` または `pro`** を判定し、機能の ON/OFF に使う。

**補足**

- 未課金（トライアル前・期限切れ等）のときは「プランなし」として扱い、Lite 相当（② 入出庫のみ）または「プラン選択画面」に誘導する運用が考えられます。どちらにするかは要件で決定してください。
- 必要に応じて、DB に「ショップ ID とプラン名（または lite/pro）」をキャッシュし、Billing API の呼び出し回数を減らすことも可能です。

### 4.2 機能フラグ（公開アプリ用）

アプリ内では次のように「使ってよい機能」を決めます。

| 機能 | 管理画面ルート | POS 拡張 | Lite | Pro |
|------|----------------|----------|------|-----|
| ① 在庫情報 | `/app/inventory-info` | （なし） | ✗ | ○ |
| ② 入出庫 | `/app/history` | 出庫・入庫タイル | ○ | ○ |
| ③ 仕入 | `/app/purchase` | 仕入タイル | ✗ | ○ |
| ④ ロス | `/app/loss` | ロスタイル | ✗ | ○ |
| ⑤ 発注 | `/app/order` | 発注タイル | ✗ | ○ |
| ⑥ 棚卸 | `/app/inventory-count` | 棚卸タイル | ✗ | ○ |
| 設定 | `/app` (設定) | （なし） | ○ | ○ |

- **カスタム**（`APP_DISTRIBUTION=inhouse`）のときは、上記フラグは**すべて ON** として扱う。

---

## 5. 実装の流れ（案）

### 5.1 サーバー側（管理画面・API）

1. **環境変数**  
   - `APP_DISTRIBUTION`: `inhouse`（カスタム） / `public`（公開）。  
   - カスタム用デプロイにだけ `inhouse` を設定する。

2. **プラン取得**  
   - 公開アプリ時のみ、Billing API で現在のプランを取得し、`lite` / `pro` に変換するユーティリティを用意する。  
   - 必要なら DB にショップ単位でプランをキャッシュする。

3. **API: プラン・機能フラグ**  
   - 例: `GET /api/shop-plan`（認証済みセッション前提）  
   - レスポンス例:  
     `{ distribution: "inhouse" | "public", plan: "lite" | "pro" | null, features: { inventoryInfo, history, purchase, loss, order, stocktake } }`  
   - 管理画面の loader や POS からこの API を呼び、表示するメニューやタイルを決める。

4. **管理画面ナビ（`app.tsx`）**  
   - loader で `distribution` と `plan`（または `features`）を取得。  
   - **カスタム**: 従来どおり全リンク（設定・在庫情報・入出庫・仕入・ロス・発注・棚卸）を表示。  
   - **公開 + Pro**: 同上、全リンク表示。  
   - **公開 + Lite**: 「設定」「入出庫」のみ表示。  
   - **公開 + プランなし**: 「設定」＋ 必要なら「プラン選択／アップグレード」用リンクやリダイレクト。

5. **ルート保護**  
   - `/app/inventory-info`, `/app/purchase`, `/app/loss`, `/app/order`, `/app/inventory-count` の各 loader で、  
     「公開アプリかつ Lite（またはプランなし）」の場合は、該当機能が許可されていないので、  
     設定画面や「プラン選択／アップグレード」ページへリダイレクトする。

6. **課金フロー（公開アプリ）**  
   - 初回利用時やプラン未選択時に「プラン選択」画面を表示し、  
     Shopify Billing API で Recurring charge を作成（Lite/Pro × ロケーション数に応じた料金）。  
   - トライアル日数（Lite 7日・Pro 14日）は、パートナーで各プランに設定する。

### 5.2 POS 拡張

- **出庫・入庫**: Lite でも利用可能なため、現状どおり表示・利用可能でよい。
- **仕入・ロス・発注・棚卸**: Pro 専用。  
  - 各拡張の「起動時」に、`/api/shop-plan`（または同等 API）を呼ぶ。  
  - `features.purchase` / `features.loss` / `features.order` / `features.stocktake` が false の場合は、  
    画面には「Pro プランでご利用いただけます」などのメッセージとアップグレード案内を表示し、機能本体は表示しない。  
  - カスタム（`distribution === "inhouse"`）のときは常に true として扱い、現状どおり全タイルがそのまま使えるようにする。

※ POS のタイルそのものは、公開アプリでも 6 つともインストールされます。「見えるが、開いたときに Pro でないと中身を使えない」形にすると、実装が分かりやすく、Shopify の審査でも説明しやすいです。

### 5.3 カスタムアプリ側の変更

- **コード**: 上記の「`APP_DISTRIBUTION=inhouse` のときはプラン判定をスキップし、常に全機能 ON」にすれば、**既存の挙動を変えずに**カスタムアプリはそのまま全機能利用可能です。
- **デプロイ**: カスタム用の Render サービスにだけ `APP_DISTRIBUTION=inhouse` を設定する。  
- **POS の appUrl**: 既存どおり `extensions/common/appUrl.js` の `APP_MODE` で、公開用／自社用の URL を切り替える。カスタム用ビルドでは `inhouse` にしておけば、自社用 URL を参照します。

---

## 6. まとめ

| 項目 | 内容 |
|------|------|
| **共通コード** | カスタム・公開で同じリポジトリを使い、`APP_DISTRIBUTION` で振る舞いを切り替える。 |
| **カスタム** | `APP_DISTRIBUTION=inhouse` にすると、現状のまま全機能が使える。 |
| **公開** | `APP_DISTRIBUTION=public`（または未設定）で、Lite は ② のみ、Pro は ①②③④⑤⑥ に制御する。 |
| **課金** | 公開アプリのみ Shopify Billing API（Recurring charge）で、Lite/Pro × ロケーション数に応じたプランを用意する。 |
| **管理画面** | ナビとルートでプランに応じて表示・リダイレクト。 |
| **POS** | 出庫・入庫は Lite も利用可。仕入・ロス・発注・棚卸は Pro のみ（API で制御し、非 Pro 時はアップグレード案内を表示）。 |

この設計で進めて問題なければ、次のステップで「環境変数名・API パス・DB キャッシュの要否」などを確定し、実装に落とし込めます。
