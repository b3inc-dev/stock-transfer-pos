# 複数商品グループの棚卸 - 要件整理

## 現状の問題点

### 1. アプリ側の問題

#### 問題1-1: まとめて表示モードでの表示不整合
**状況**: 1つの商品グループだけ確定した後、履歴一覧から対象の棚卸IDをタップして「まとめて表示」を選択した場合

**問題**:
- 確定済みの商品グループの数量が表示されない
- 確定済みの商品グループでも再度数量調整が可能になってしまう（編集可能状態）

**原因**:
- `InventoryCountList.jsx`の`loadProducts`関数で、完了済み商品リストを読み込む際に、`items`フィールドを優先しているが、複数商品グループの場合は`groupItems`から各グループごとに読み込む必要がある
- 「まとめて表示」モードでは、全商品グループを1画面で表示するが、完了済みのグループと未完了のグループを区別して表示する処理が不足している

#### 問題1-2: 商品グループごとに選択した場合の表示不整合
**状況**: 商品グループリストから処理済みの商品グループをタップした場合

**問題**:
- 処理済みの商品グループをタップしても、未処理の商品グループの商品リスト内容が表示されてしまう

**原因**:
- `onSelectProductGroup`関数で`productGroupId`を渡しているが、`InventoryCountList.jsx`の`loadProducts`関数で、完了済み商品リストを読み込む際に`currentGroupId`が正しく使用されていない可能性がある
- `storedItemsFromGroup`の取得時に、`currentGroupId`で`groupItems`から正しく取得できていない

### 2. 管理画面側の問題

#### 問題2-1: 商品グループごとの進捗状況が不明
**状況**: 複数商品グループの棚卸履歴を表示した場合

**問題**:
- 総数（実数/在庫数）しか表示されず、どの商品グループが完了していてどの商品グループが未完了なのかが不明

**原因**:
- 履歴一覧では、全商品グループの合計数量のみを表示している
- 商品グループごとの進捗状況を表示する機能がない

## 要件整理

### 要件1: アプリ側の「まとめて表示」モードの改善

#### 要件1-1: 完了済みグループと未完了グループの区別表示
- **完了済みの商品グループ**: 読み取り専用で表示（編集不可）
  - `groupItems[groupId]`からデータを読み込んで表示
  - 在庫数（棚卸時の在庫数）と実数（確定した在庫数）を正しく表示
- **未完了の商品グループ**: 編集可能で表示
  - 商品リストを読み込んで、数量入力可能な状態で表示

#### 要件1-2: まとめて表示時のデータ読み込み
- 全商品グループの`groupItems`から完了済みのデータを読み込む
- 未完了の商品グループは、商品リストをAPIから取得
- 完了済みと未完了を区別して、1画面に統合表示

### 要件2: アプリ側の「商品グループごとに選択」モードの改善

#### 要件2-1: 処理済みグループの正しい表示
- 処理済みの商品グループをタップした場合、そのグループの`groupItems[groupId]`からデータを読み込んで表示
- `readOnly`フラグを正しく設定して、編集不可にする

#### 要件2-2: 未処理グループの表示
- 未処理の商品グループをタップした場合、商品リストをAPIから取得して表示
- 編集可能な状態で表示

### 要件3: 管理画面側の改善

#### 要件3-1: 商品グループごとの進捗状況表示
- 履歴一覧で、各商品グループの進捗状況を表示
  - 例: 「商品グループA: 完了（実数10/在庫10）」「商品グループB: 未完了（実数0/-）」
- または、商品リストモーダルで、商品グループごとにタブやセクションを分けて表示

#### 要件3-2: 商品グループごとの数量表示
- 履歴一覧で、各商品グループの数量を個別に表示
- 総数だけでなく、グループごとの内訳を表示

## 実装方針

### 方針1: データ構造の明確化
- `groupItems`: 商品グループIDをキーとして、各グループの商品リストを保存
  - 例: `{ "group1": [...], "group2": [...] }`
- `items`: 後方互換性のため残すが、複数商品グループの場合は使用しない

### 方針2: 完了判定の改善
- 各商品グループごとに完了判定を行う
- 全商品グループが完了している場合のみ、全体を「完了」ステータスにする

### 方針3: 表示ロジックの改善
- 「まとめて表示」モード: 全商品グループを1画面に表示し、完了済み/未完了を区別
- 「商品グループごとに選択」モード: 選択したグループのデータのみを表示

### 方針4: 管理画面の改善
- 履歴一覧で、商品グループごとの進捗状況を表示
- 商品リストモーダルで、商品グループごとにセクションを分けて表示

## 優先順位

1. **高**: アプリ側の「商品グループごとに選択」モードの修正（処理済みグループの正しい表示）
2. **高**: アプリ側の「まとめて表示」モードの修正（完了済み/未完了の区別表示）
3. **中**: 管理画面側の商品グループごとの進捗状況表示
