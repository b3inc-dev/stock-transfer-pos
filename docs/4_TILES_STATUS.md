# 4タイル分割後の状態（確認用）

**最終更新**: 2026年2月

---

## 1. 入庫タイルで「入庫機能は別拡張として用意しました。」と表示される

### 状態
- **在庫処理 入庫** タイルを開くと、コンディション画面ではなく、  
  「入庫機能は別拡張として用意しました。」という文章だけが表示されている。

### 理由
- 要件（REQUIREMENTS_4_TILES.md）のとおり、**入庫タイルの Modal は「プレースホルダー」のまま**にしている。
- `extensions/stock-transfer-inbound/src/Modal.jsx` は、入庫の画面・ロジックを**まだ移していない**ため、  
  上記の説明文だけを表示する実装になっている。

### 必要な対応
- 入庫の「コンディション画面〜一覧〜確定」の流れを、**出庫タイル側の Modal.jsx（またはそのバックアップ）から入庫用 Modal に移す**必要がある。
- 出庫タイルの Modal.jsx には入庫関連のコードがまだ残っているが、64KB 制限のため出庫専用に削る方針だった。  
  **入庫で使う部分（InboundConditions, InboundList 等）を切り出し、stock-transfer-inbound の Modal.jsx に移植する**と、入庫タイルからコンディションから使えるようになる。

---

## 2. 棚卸タイルでリストや店舗が読み込まれない

### 状態
- **在庫調整 棚卸** タイルを開くと、棚卸コンディション画面は出るが、  
  **棚卸一覧（リスト）や店舗名（ロケーション名）が読み込まれていない**ように見える。

### 想定される原因

1. **ロケーションIDの形式の違い**
   - 棚卸一覧は「現在の POS セッションのロケーション」でフィルタしている。
   - セッションの `locationId` は **GID**（`gid://shopify/Location/123`）に変換して使っている。
   - 一方、メタフィールドに保存されている棚卸データの `locationId` が **数値や文字列の ID**（例: `123`）のままの場合、  
     「今の店舗」と一致せず、一覧が空になったり、店舗名の取得に失敗したりする。

2. **GraphQL / メタフィールド**
   - 棚卸一覧は `currentAppInstallation` のメタフィールド（`stock_transfer_pos` / `inventory_counts_v1`）から読んでいる。
   - 同じアプリの別拡張（ロス）で保存したデータは、棚卸拡張からも同じメタフィールドで読める想定。
   - ここが失敗している場合は、ネットワークエラーやスコープ不足の可能性がある（通常は同一アプリなら共有される）。

3. **店舗名（ロケーション名）**
   - 店舗名は `getLocationName(locationId)` で、GraphQL の `locations` を叩いて取得している。
   - `locations.nodes[].id` は **GID** なので、  
     棚卸データの `locationId` が数値のままと **形式が一致せず**、`locations.find((l) => l.id === locationId)` でヒットせず、店舗名が「読み込めていない」ように見える。

### 必要な対応
- **ロケーションIDの正規化**  
  フィルタや `getLocationName` で使うときに、  
  「GID」と「数値/文字列ID」の両方を同じ形式（例: どちらも GID）にそろえて比較・参照する。
- コード上では、  
  - コンディション画面で「現在のロケーションでフィルタ」する部分  
  - `stocktakeApi.js` の `getLocationName`（および `locations` の取得）  
  の両方で、`locationId` を GID に正規化してから比較・検索するようにする。

---

## 3. まとめ

| タイル | 状態 | 対応方針 |
|--------|------|----------|
| **在庫処理 出庫** | コンディションから開始・戻るで閉じるまで実装済み | 特になし（容量削減は別タスク） |
| **在庫処理 入庫** | プレースホルダー文言のみ表示 | 出庫側の入庫コードを入庫拡張の Modal に移植する |
| **在庫調整 ロス** | コンディションから開始・戻るで閉じるまで実装済み | 特になし |
| **在庫調整 棚卸** | コンディションは表示されるが、一覧・店舗名が読めない | ロケーションIDの形式を GID にそろえて比較・参照するよう修正する |

このドキュメントは、4タイル分割後の「今どうなっているか」を確認するためのものです。
