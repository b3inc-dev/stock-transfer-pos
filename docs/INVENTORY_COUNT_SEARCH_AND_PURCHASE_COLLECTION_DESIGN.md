# 棚卸「検索結果のみ表示」化と仕入コレクション検索の設計

## ご質問への回答

### 1. コレクションも商品検索と同様に実装は可能ですか？

**可能です。**

- **現状**: 棚卸の「コレクションから作成」「SKU選択から作成」は、読み込み時に全コレクション・全バリアントを loader で取得しており、商品数が多いストアでは初回表示が重くなります。
- **変更後**: 仕入の「商品検索」と同様に、
  - 検索クエリを入力して「検索」ボタンでサーバーに送信
  - 返ってきた**検索結果だけ**をリスト表示
  - 選択した行は「選択済み」ボタンで表示し、再検索しても選択は保持（選択済み情報を state で保持）
  - 「選択解除」ボタンで一括解除

コレクション検索は Shopify API の `collections(first, query)` でクエリ検索ができるため、同じパターンで実装できます。SKU は既に仕入で使っている `productVariants(first, query)` の検索を棚卸用 action として追加します。

### 2. 仕入作成にもコレクション検索を追加できますか？

**可能です。**

- 仕入の「商品」タブを **商品検索 / コレクション / CSVアップロード** の3タブにします。
- **コレクション**タブでは:
  1. コレクション名で検索 → 検索結果からコレクションを選択
  2. 選択したコレクションに含まれる商品（バリアント）一覧を取得して表示
  3. 必要な商品にチェックを付け、「商品を追加」で仕入リストに追加

仕入の「商品検索」と同じく、検索結果のみ表示・選択済みの引き継ぎ・選択解除を用意します。

---

## 実装方針（棚卸）

### データ取得の変更

| 項目 | 現状 | 変更後 |
|------|------|--------|
| コレクション一覧 | loader で全件取得（ページネーション） | loader では返さない（空）。検索時のみ action で取得 |
| SKU（バリアント）一覧 | loader で全商品・全バリアント取得 | loader では返さない（空）。検索時のみ action で取得 |

### 新規 action（棚卸）

- `searchCollectionsForInventoryCount`: クエリでコレクション検索 → `{ collections: [...] }`
- `searchVariantsForInventoryCount`: SKU・商品名でバリアント検索 → `{ variants: [...] }`
- `getCollectionsByIds`: 編集時、選択済みコレクションの id/title 取得（選択済み表示用）
- `getVariantsByInventoryItemIds`: 編集時、選択済みバリアントの情報取得（選択済み表示用）

### UI の変更（棚卸）

- **コレクション**: 検索入力 + 「検索」ボタン → 結果のみ表示。選択済みボタン・選択解除ボタン。再検索しても選択は state で保持。
- **SKU**: 同様に検索入力 + 「検索」ボタン → 結果のみ表示。選択済み・選択解除・引き継ぎ。
- **「グループを追加する」ボタン**: 仕入の「商品を追加」ボタンと同じスタイル（青背景・幅100%・角丸など）に統一。文言は「グループを追加」のまま（意味を明確にするため）。

---

## 実装方針（仕入）

- 商品タブに **コレクション** を追加: 「商品検索」「コレクション」「CSVアップロード」の3タブ。
- コレクションタブ: コレクション検索 → 選択 → そのコレクションの商品一覧取得 → チェックで選択 → 「商品を追加」で仕入リストに追加。
- 既存の「商品検索」「CSVアップロード」の動作は変更しません。

---

## 影響範囲

- **棚卸**: `app/routes/app.inventory-count.tsx` の loader（全件取得削除）、action（検索系追加）、左パネルUI（検索＋結果表示＋選択済み・選択解除、ボタンスタイル）。
- **仕入**: `app/routes/app.purchase.tsx` の action（コレクション検索・コレクション商品取得）、新規タブ「コレクション」とそのUI。
- 棚卸の「編集」で既存グループを開くときは、選択済みコレクション／バリアントの表示用に `getCollectionsByIds` / `getVariantsByInventoryItemIds` を呼び、取得した情報で選択済みリストを表示します。

---

## 実装順序

1. 棚卸: loader から全件取得をやめ、action で検索のみ（コレクション・SKU）
2. 棚卸: コレクション/SKU に選択済み・選択解除・再検索時引き継ぎ
3. 棚卸: 「グループを追加する」を「商品を追加」と同じボタンUIに変更
4. 仕入: コレクション検索タブを追加（検索→選択→商品を追加）
