# 在庫情報：在庫高スナップショットと在庫変動履歴の日付

**作成日**: 2026年2月

---

## 1. 在庫高（日付指定）：前日分を自動で保存する

### 仕様

- **前日分のスナップショット**は、**Cron ジョブ**が **`/api/inventory-snapshot-daily`** を呼んだときに保存されます。**管理画面を開かなくても自動で保存**されます。
- **保存する日付の決め方**:
  - **23:00〜23:59 に API が呼ばれた場合**: その時点の在庫を **「今日」の日付** で保存（その日の終了時点＝前日分として理想）。
  - **それ以外の時刻（例: 0:00）に呼ばれた場合**: その時点の在庫を **「前日」の日付** で保存（日付が変わった直後≈前日終了時点）。
- **推奨**: 「前日分＝その日の終了時点」としたい場合は、**Cron を毎日 23:59（ショップのタイムゾーン）に実行**するのが理想です。

### 「〇〇のスナップショットが見つかりませんでした」になる要因

- **Cron を設定していない**、または **Cron が動いていない**（Render の Cron Jobs 未設定・停止・URL/認証ミスなど）。**コード内に Cron の実行時刻は含まれておらず、Render ダッシュボード等で手動設定が必要です。**

### Cron の設定（必須・手動）

- リポジトリには **Cron の実行スケジュールは含まれていません**。**Render の Cron Jobs**（または GitHub Actions 等）で、**毎日 23:59**（推奨）または 0:00（ショップのタイムゾーン）に次のリクエストを送るように**ご自身で設定**してください。
- **Cron Job の意味や Render での設定手順**は、** [CRON_JOB_SETUP_GUIDE.md](./CRON_JOB_SETUP_GUIDE.md)** にまとめています（初心者向け・画面の流れ付き）。
  - `POST https://（アプリのURL）/api/inventory-snapshot-daily`
  - ヘッダー: `Authorization: Bearer （INVENTORY_SNAPSHOT_API_KEY の値）`
- 環境変数 **`INVENTORY_SNAPSHOT_API_KEY`** を Render の Environment に設定し、Cron のリクエストではその値を Bearer トークンとして付与してください。
- **23:59 実行の cron 式例**（ショップが日本時間の場合）: 日本 23:59 = UTC 14:59 → **`59 14 * * *`**（毎日 UTC 14:59 = 日本 23:59）。
- 0:00 実行の場合: 日本 0:00 = UTC 前日 15:00 → **`0 15 * * *`**。

**Cron 実行例（curl）**

```bash
curl -X POST "https://（アプリのURL）/api/inventory-snapshot-daily" \
  -H "Authorization: Bearer ${INVENTORY_SNAPSHOT_API_KEY}" \
  -H "Content-Type: application/json"
```

Render の Cron Job で「Command」に上記の curl を指定する場合、Environment に `INVENTORY_SNAPSHOT_API_KEY` を設定しておき、Command では `$INVENTORY_SNAPSHOT_API_KEY` が展開されるようにします。

### 外部DBは必要か

- **現状の保存先は Metafield のみ**で、外部DB（PostgreSQL 等）は使っていません。
- 「スナップショットが無い」原因は **外部DBの有無ではなく、Cron で日次API（0:00 または 23:59）が呼ばれていないこと**です。
- 将来的に Metafield の容量制限（250KB 等）を超えそうな場合は、スナップショットを外部DBに移す検討が必要になります。

---

## 2. 在庫変動履歴の「開始日・終了日」の基本設定と日付が逆になる現象

### 基本設定（仕様）

- **終了日**: デフォルトは **「今日」**（ショップのタイムゾーンでの日付）。
- **開始日**: デフォルトは **「30日前」**（同じくショップタイムゾーン）。  
  - ただし、履歴ログが 1 件も無い場合は **「今日」** に揃えます。  
  - 履歴の「最初の日付」がある場合は、開始日がそれより前にならないように調整します。

したがって、**開始日 ≦ 終了日** になるのが正しい状態です。

### 開始日が終了日より後になる現象（例: 開始日 2026/02/09、終了日 2026/02/08）

- **想定原因**:  
  - URL パラメータ（`startDate` / `endDate`）がブックマークやリンクで **逆の組み合わせ**で渡されている。  
  - または、ユーザーが手動で開始日に終了日より後の日付を入れたまま「検索」した。
- **対応**:  
  - サーバー側（loader）で **開始日 > 終了日** のときは **開始日 = 終了日** に補正するようにしました。  
  - クライアント側で「検索」実行時にも、開始日 > 終了日の場合は入れ替えてから URL を更新するようにしました。  
  これにより、表示と検索結果が「開始日 ≦ 終了日」で一貫するようになります。

---

## 3. 在庫変動履歴の要件との関係

- **在庫変動履歴**は、外部DB（PostgreSQL）に保存した **InventoryChangeLog** を参照しており、デプロイ後も履歴が残る要件は満たしています。
- **在庫高の日付指定**（過去日付のスナップショット）は、上記のとおり **Cron による日次APIの実行** が必須で、外部DBの有無とは別問題です。
