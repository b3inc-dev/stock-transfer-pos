# 在庫情報：在庫高スナップショットと在庫変動履歴の日付

**作成日**: 2026年2月

---

## 1. 在庫高（日付指定）：前日分を自動で保存する

### 仕様

- **前日分のスナップショット**は、**Cron ジョブ**が **`/api/inventory-snapshot-daily`** を呼んだときに保存されます。**管理画面を開かなくても自動で保存**されます。
- **保存する日付の決め方**:
  - **23:00〜23:59 に API が呼ばれた場合**: その時点の在庫を **「今日」の日付** で保存（その日の終了時点＝前日分として理想）。
  - **それ以外の時刻（例: 0:00）に呼ばれた場合**: その時点の在庫を **「前日」の日付** で保存（日付が変わった直後≈前日終了時点）。
- **推奨**: 「前日分＝その日の終了時点」としたい場合は、**Cron を毎日 23:59（ショップのタイムゾーン）に実行**するのが理想です。

### 「〇〇のスナップショットが見つかりませんでした」になる要因

- **Cron を設定していない**、または **Cron が動いていない**（Render の Cron Jobs 未設定・停止・URL/認証ミスなど）。**コード内に Cron の実行時刻は含まれておらず、Render ダッシュボード等で手動設定が必要です。**

### Cron の設定（必須・手動）

- リポジトリには **Cron の実行スケジュールは含まれていません**。**Render の Cron Jobs**（または GitHub Actions 等）で、**毎日 23:59**（推奨）または 0:00（ショップのタイムゾーン）に次のリクエストを送るように**ご自身で設定**してください。
- **Cron Job の意味や Render での設定手順**は、** [CRON_JOB_SETUP_GUIDE.md](./CRON_JOB_SETUP_GUIDE.md)** にまとめています（初心者向け・画面の流れ付き）。
  - `POST https://（アプリのURL）/api/inventory-snapshot-daily`
  - ヘッダー: `Authorization: Bearer （INVENTORY_SNAPSHOT_API_KEY の値）`
- 環境変数 **`INVENTORY_SNAPSHOT_API_KEY`** を Render の Environment に設定し、Cron のリクエストではその値を Bearer トークンとして付与してください。
- **23:59 実行の cron 式例**（ショップが日本時間の場合）: 日本 23:59 = UTC 14:59 → **`59 14 * * *`**（毎日 UTC 14:59 = 日本 23:59）。
- 0:00 実行の場合: 日本 0:00 = UTC 前日 15:00 → **`0 15 * * *`**。

**Cron 実行例（curl）**

```bash
curl -X POST "https://（アプリのURL）/api/inventory-snapshot-daily" \
  -H "Authorization: Bearer ${INVENTORY_SNAPSHOT_API_KEY}" \
  -H "Content-Type: application/json"
```

Render の Cron Job で「Command」に上記の curl を指定する場合、Environment に `INVENTORY_SNAPSHOT_API_KEY` を設定しておき、Command では `$INVENTORY_SNAPSHOT_API_KEY` が展開されるようにします。

### Cron を設定しているのにスナップショットが残らない場合（チェックリスト）

次のどれかが原因になっていることが多いです。

| 確認項目 | 内容 |
|----------|------|
| **1. 呼び方** | このアプリ（stock-transfer-pos）では、Cron は **「curl で Web サービスの URL を POST する」** 形にしてください。**Node スクリプトを直接実行する**（例: `node ./src/services/...`）方式は、このリポジトリの日次APIの想定ではありません。**Command** は `curl -X POST "https://（WebサービスのURL）/api/inventory-snapshot-daily" -H "Authorization: Bearer $INVENTORY_SNAPSHOT_API_KEY"` のようにしてください。 |
| **2. 実行時刻（JST で 23:59 にしたい場合）** | Render のスケジュールは **UTC** です。日本時間 23:59 = **UTC 14:59** なので、cron 式は **`59 14 * * *`** または Render の「At 02:59 PM UTC」のような指定にしてください。**`59 23 * * *`（23:59 UTC）** だと日本時間では **翌日 8:59** になり、意図した「日付が変わる前の 23:59」とずれます。 |
| **3. API キーが 2 箇所で一致しているか** | **Cron Job の Environment** に `INVENTORY_SNAPSHOT_API_KEY` を入れて curl の Bearer に使います。同じ値のキーを **Web サービス（pos-stock 等）の Environment** にも必ず設定してください。Web サービス側に無い、または違う値だと API が 401 を返し、保存されません。 |
| **4. セッションが 1 件以上あるか** | API は DB の **オフラインセッション**（管理画面でアプリを開いたときに保存されるトークン）を参照します。**1 ショップも管理画面でアプリを開いていない**と `sessions.length === 0` となり、`processed: 0` のまま終了します。利用手順で「初回は必ず1回管理画面でアプリを開く」を案内してください。 |
| **5. Logs で結果を確認** | Render の Cron Job の **Logs** で、実行後に `"ok":true` や `processed: 1` が出ているか、または 401 / 500 が出ていないかを確認すると原因を切り分けやすくなります。 |

### 「Processed 0 shops」かつ errors に「Invalid API key or access token」と出る場合

ログが次のようなとき:

```json
{"ok":true,"message":"Processed 0 shops","processed":0,"total":1,"errors":["（ショップ名）.myshopify.com: [API] Invalid API key or access token (unrecognized login or wrong password)"]}
```

- **Cron の API キー認証は通っています**（そうでなければ 401 が返り、上記 JSON にはなりません）。
- **原因**: DB に保存されている **そのショップのオフラインアクセストークン** が、Shopify 側で無効になっています。スナップショット保存時に、そのトークンで Shopify の GraphQL を呼んでいますが、Shopify が「このトークンは使えない」と返しています。
- **よくある要因**: アプリの再インストール・権限変更・トークンの失効などで、古いトークンが残ったままになっている。
- **対処**: そのショップで **管理画面を開き、アプリの画面をもう一度開く**（OAuth が走り、新しいオフライントークンが DB に保存される）。その後、Cron を再度実行すると、そのショップ分は `processed: 1` になる想定です。複数ショップで同じエラーが出る場合は、各ショップで同様に「管理画面でアプリを1回開く」を行ってください。

### 管理画面を開いているのに「Invalid API key or access token」になる理由

「いま管理画面を開いているのに、Cron のログではトークンが無効と言われる」場合に考えられる原因です。

| 要因 | 説明 |
|------|------|
| **別ショップのトークン** | Cron は DB に保存された **全ショップ** のセッションを順に処理します。エラーになっている `（ショップ名）.myshopify.com` が、**今開いている管理画面のショップと違う**ことがあります。そのショップの管理画面でアプリを開き直してください。 |
| **本番と開発で DB が違う** | **開発時**（localhost）でアプリを開くと、トークンは **開発用 DB**（例: 手元の SQLite）に保存されます。**Cron は本番の Render 上**で動き、**本番用 DB** を参照します。本番 DB には、**本番のアプリ URL（pos-stock.onrender.com）で一度でも開いたとき**のトークンが入ります。開発で開いただけでは本番 DB は更新されないため、本番 Cron では「トークン無効」になります。→ **本番のアプリ URL で、そのショップの管理画面からアプリを1回開く**と、本番 DB にトークンが保存されます。 |
| **トークンの失効** | アプリの再インストール・権限変更・パスワード変更などで、**以前保存したトークンが Shopify 側で無効**になることがあります。その場合は「管理画面でアプリを開き直す」と新しいトークンが保存され、Cron は次回から成功します。 |

### なぜトークンが無効になるか／いつ発生するか

**Shopify 側でトークンが「使えない」と判断される主なタイミング**は次のとおりです。

| きっかけ | 説明 |
|----------|------|
| **アプリの再インストール** | 一度アプリを外してから入れ直すと、**以前のトークンはすべて無効**になります。DB に古いトークンが残ったままなので、Cron は「Invalid API key or access token」になります。 |
| **権限（スコープ）の変更** | アプリの権限を変更して再承認すると、**古いトークンは無効**になり、新しいトークンが発行されます。本番 DB が古いトークンのままなら、Cron は失敗します。 |
| **ストアオーナーのパスワード変更** | Shopify のストアオーナーがパスワードを変更すると、**セッションやトークンが無効になることがあります**（Shopify の仕様に依存）。 |
| **本番と開発で DB が違う** | **開発（localhost）でアプリを開いたとき**のトークンは開発用 DB にだけ入ります。**本番の Cron は本番 DB だけ**を見るため、本番 DB には「本番 URL で開いたとき」のトークンが無い、または古い別トークンが残っている、という状態になり、本番では無効と判定されます。 |
| **デプロイや DB の差し替え** | 本番 DB を初期化したり別環境に差し替えたりすると、**保存されていたトークンが消えます**。各ショップで本番 URL からアプリを開き直す必要があります。 |

**多数インストールがあった際に起こりうる場面**

- **新規インストール**  
  インストール直後、**本番 URL でアプリを1回開いていない**ショップは、本番 DB にトークンが無いか古いため、Cron ではそのショップが失敗します。
- **再インストール・権限変更したショップ**  
  そのショップだけトークンが無効になるので、Cron の `errors` にそのショップ名が出ます。そのショップでアプリを開き直すと解消します。
- **本番デプロイをした直後**  
  開発だけで使っていたショップは、本番 DB に有効なトークンが無いため、本番の Cron では失敗します。本番 URL で1回開いてもらう必要があります。

### 「昨日トリガーで成功したのに、予定時刻には保存されず、今はトリガーも失敗する」場合

次のどれかに当てはまっていないか確認してください。

| 確認すること | 説明 |
|--------------|------|
| **昨日の「トリガー成功」は本番の Cron だったか** | 昨日成功したのが **Render の本番 Cron Job の「Trigger Run」** なら、その時点では本番 DB のトークンは有効でした。その**翌日**にトリガーが失敗するなら、**昨日の夜〜今日のあいだにトークンが無効になった**可能性があります（再インストール・権限変更・パスワード変更など）。心当たりがなければ、**本番 URL（pos-stock.onrender.com）で、そのショップの管理画面からアプリをあらためて1回開く**と、新しいトークンが本番 DB に保存され、トリガーは再び成功する想定です。 |
| **昨日の成功は開発環境ではなかったか** | 昨日「成功」したのが **手元の開発サーバーや別環境** の API を叩いた結果だと、トークンは **開発用 DB** にしか入っていません。**本番の Cron（予定時刻の実行も含む）は本番 DB だけ**を見るため、本番では最初からトークンが無いか古く、ずっと失敗していた、という状態になります。→ **本番のアプリ URL で、そのショップの管理画面からアプリを1回開く**と、本番 DB にトークンが入り、本番のトリガー・予定時刻の実行の両方が成功するようになります。 |
| **予定時刻の実行は本当に動いているか** | Render の Cron の **Logs** で、**設定した日時（例: 日本時間 23:59 なら UTC 14:59）** に実行ログが出ているか確認してください。ログが無ければ、スケジュールが違う・Cron が止まっているなどの可能性があります。ログはあるが `processed: 0` と `errors` が出ているなら、その時刻の実行でもトークン無効で失敗しています。 |
| **スケジュールの時刻** | 「23:59 に保存したい」が、Cron の Schedule が **23:59 UTC**（`59 23 * * *`）だと、日本時間では **翌日 8:59** になります。日本時間 23:59 に動かすには **UTC 14:59**（`59 14 * * *`）にしてください。 |

**まとめ（今の失敗と不安への対応）**

1. **本番のアプリ URL**（https://pos-stock.onrender.com）で、**location-stock-indicator の管理画面からアプリを1回開く**。  
2. 開いたあと、Render の Cron で **「Trigger Run」** を実行し、Logs で `processed: 1` になっているか確認する。  
3. 成功したら、**Logs で予定時刻（例: 14:59 UTC）に実行が出ているか**も確認し、スケジュールどおり動いていれば、翌日以降もその時刻に保存されます。

### 管理画面を開かずに自動保存するか／開かずに保存する方法はあるか

- **「毎日、人が管理画面を開かなくても」自動でスナップショットを保存する**  
  → **Cron を設定すれば可能**です。Cron が日次で API を呼び、API が DB に保存済みのオフライントークンで Shopify に問い合わせます。**一度も管理画面を開いていなければ** DB にトークンが無いので `processed: 0` になりますが、**最低1回、各ショップで管理画面からアプリを開いた後は**、そのショップ分は Cron だけで自動保存されます（管理画面は開かなくてよい）。

- **「一度も管理画面（またはインストール時の OAuth）を経由せずに」保存する**  
  → **できません**。Shopify の在庫を取得するには、**そのショップの有効なアクセストークン**が必要です。トークンは **アプリのインストール時** または **管理画面でアプリを開いたとき** の OAuth でしか取得できません。そのため、「一度も開かずに保存する」ことはできず、**初回だけは「管理画面でアプリを開く」か「インストール完了」が必要**です。初回以降は、Cron とトークンがあれば管理画面を開かずに保存できます。

- **在庫変動履歴**  
  POS や Webhook から `api/log-inventory-change` を呼ぶときも、**POS 用のセッション**（管理画面でアプリを開いたときに保存されるオフラインセッション）を使います。同じく「一度も開いていないショップ」では記録に失敗する可能性があります。初回は管理画面でアプリを開いてもらう運用が必要です。

### 多数ショップがインストールされている場合

インストールショップ数が増えても、**「各ショップごとに、本番 URL で最低1回アプリを開く」** というルールは変わりません。Shopify の仕様上、トークンは**そのショップの OAuth（インストール時または管理画面でアプリを開いたとき）**でしか取得できないため、一括でトークンを発行・移行する方法はありません。

| ケース | どうするか |
|--------|-------------|
| **別ショップのトークン**（エラーになっているショップが、今開いている管理画面と違う） | Cron は DB 内の**全ショップ**を順に処理し、失敗したショップ名が **API の `errors` 配列** に含まれます。Render の Cron **Logs** で `errors` を確認すれば「どのショップがトークン無効か」が分かります。**そのショップの管理者**（またはそのショップでログインできる人）に「管理画面でアプリを1回開いてください」と案内してください。多数ショップの場合は、失敗ショップ一覧をスプレッドシートや社内ツールに写して共有する、または将来「トークン無効のショップ一覧」を管理画面に表示する機能を追加する、などの運用が考えられます。 |
| **本番と開発で DB が違う** | **本番デプロイ後**、各ショップは **本番のアプリ URL**（例: pos-stock.onrender.com）で、**そのショップの管理画面から**アプリを1回開く必要があります。開発環境で開いただけでは本番 DB にはトークンが入りません。**オンボーディングや利用ガイド**に「インストール後、または本番利用開始時に、必ず1回は管理画面からアプリを開いてください（日次スナップショットと在庫履歴のため）」と明記し、新規ショップに案内するとよいです。 |
| **トークンの失効**（再インストール・権限変更など） | 失効したショップも、Cron の `errors` に **`（ショップ名）.myshopify.com: [API] Invalid API key or access token`** のように出ます。失敗したショップだけ「アプリを再度開いてください」と案内します。多数ショップのときは、Cron 実行後の Logs を定期的に確認するか、`/api/inventory-snapshot-daily` のレスポンス（`errors` 配列）を監視して、失敗ショップをリスト化する運用にすると把握しやすくなります。 |

**運用のコツ（まとめ）**

1. **初回オープンの案内を必ず入れる**  
   インストール完了画面・利用ガイド・ヘルプに「**日次スナップショットと在庫履歴を有効にするため、初回は必ず1回、管理画面からアプリを開いてください**」と書いておく。本番 URL で開いてもらうことが前提。
2. **Cron の結果で「誰が失敗したか」を把握する**  
   Cron の Logs、または手動で `curl` したときのレスポンスの `errors` に、トークン無効のショップが列挙される。ここを見れば、個別に「そのショップでアプリを開き直してください」と案内できる。
3. **必要なら「失敗ショップ一覧」機能を検討する**  
   多数ショップ向けに、管理画面や定期レポートで「先回の Cron でスナップショット保存に失敗したショップ」を一覧表示する機能を追加すると、運用が楽になる（実装は別タスク）。

### 外部DBは必要か

- **現状の保存先は Metafield のみ**で、外部DB（PostgreSQL 等）は使っていません。
- 「スナップショットが無い」原因は **外部DBの有無ではなく、Cron で日次API（0:00 または 23:59）が呼ばれていないこと**です。
- 将来的に Metafield の容量制限（250KB 等）を超えそうな場合は、スナップショットを外部DBに移す検討が必要になります。

### Metafield の肥大化に注意（長期運用時）

- 日次スナップショットは **「日付 × ロケーション数」のレコード**を 1 本の JSON に追加し続けています（`inventory_info.daily_snapshots`）。
- ロケーションが少なく日数が短いうちは問題になりにくいですが、**運用年数が長くなると Metafield のサイズ制限（例: 250KB）に近づく**可能性があります。
- **推奨**: 定期的にログや管理画面でスナップショット件数・サイズを意識し、**古い日付を別ストレージ（外部DB）に移す**や**保持日数に上限を設ける**などの設計を、将来必要に応じて検討してください。現時点のコードは「全期間を 1 Metafield に蓄積」する形のままです。

---

## 2. 在庫変動履歴の「開始日・終了日」の基本設定と日付が逆になる現象

### 基本設定（仕様）

- **終了日**: デフォルトは **「今日」**（ショップのタイムゾーンでの日付）。
- **開始日**: デフォルトは **「30日前」**（同じくショップタイムゾーン）。  
  - ただし、履歴ログが 1 件も無い場合は **「今日」** に揃えます。  
  - 履歴の「最初の日付」がある場合は、開始日がそれより前にならないように調整します。

したがって、**開始日 ≦ 終了日** になるのが正しい状態です。

### 開始日が終了日より後になる現象（例: 開始日 2026/02/09、終了日 2026/02/08）

- **想定原因**:  
  - URL パラメータ（`startDate` / `endDate`）がブックマークやリンクで **逆の組み合わせ**で渡されている。  
  - または、ユーザーが手動で開始日に終了日より後の日付を入れたまま「検索」した。
- **対応**:  
  - サーバー側（loader）で **開始日 > 終了日** のときは **開始日 = 終了日** に補正するようにしました。  
  - クライアント側で「検索」実行時にも、開始日 > 終了日の場合は入れ替えてから URL を更新するようにしました。  
  これにより、表示と検索結果が「開始日 ≦ 終了日」で一貫するようになります。

---

## 3. 在庫変動履歴の要件との関係

- **在庫変動履歴**は、外部DB（PostgreSQL）に保存した **InventoryChangeLog** を参照しており、デプロイ後も履歴が残る要件は満たしています。
- **在庫高の日付指定**（過去日付のスナップショット）は、上記のとおり **Cron による日次APIの実行** が必須で、外部DBの有無とは別問題です。
