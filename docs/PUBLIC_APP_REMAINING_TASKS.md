# 公開アプリ・審査進行：残りタスク整理

**目的**: REQUIREMENTS_FINAL.md と公開アプリ実装を基に、**審査提出〜公開完了**までにやることを整理した一覧です。  
**前提**: 機能・コード面はリリース可能な状態です。残りは**運用・環境・リスティング・審査**の準備です。

---

## 1. いまの状態の整理

| 区分 | 状態 |
|------|------|
| **機能・コード** | ほぼ完了（管理画面・POS・設定・履歴・棚卸・ロス・仕入・発注・在庫情報など） |
| **公開用 appUrl** | 完了（`extensions/common/appUrl.js` で public/inhouse 切り替え済み） |
| **本番前 console 整理** | 完了（デバッグ用ログ削除済み） |
| **リスティング用ガイド** | 整備済み（RELEASE_REQUIREMENTS_PUBLIC_APP.md、docs/LISTING_ASSETS_GUIDE.md） |
| **未実装** | プラン別機能制御（Lite/Pro・課金）は**設計のみ**（docs/PUBLIC_APP_PLAN_FEATURES_DESIGN.md）。審査は「無料でインストール」でも提出可能 |

---

## 2. 審査・リリースに向けた残りタスク（実行順）

### Phase A：環境・デプロイ（必須）

| # | タスク | 内容 | 参照 |
|---|--------|------|------|
| A1 | **本番用永続DBの用意** | PostgreSQL（**Render Add-on** または Supabase）を1つ用意し、`DATABASE_URL` を設定。Prisma 本番用設定・マイグレーション実施。デプロイで履歴が消えないようにする。※ Render Add-on の PostgreSQL で問題なく本番利用可能。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md セクション5 |
| A2 | **公開アプリ用環境の準備** | パートナーで「公開アプリ」を新規作成 → Client ID/Secret 取得。公開用デプロイ先（例: pos-stock.onrender.com）を用意し、環境変数・`shopify.app.public.toml` の `client_id` / `application_url` / `redirect_urls` を設定。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md ステップ1〜5 |
| A3 | **公開用でデプロイ・動作確認** | `shopify app config use public` → `shopify app deploy`。インストール〜主要画面の疎通確認。 | 同上 |

**Phase A 完了の目安**: 本番用に Render Add-on の PostgreSQL を使い `DATABASE_URL`・Prisma・マイグレーション済み、かつ公開アプリ作成・Client ID/Secret・公開用デプロイ先・デプロイと動作確認まで済んでいれば **Phase A は完了** でよい。

### Phase B：運用・案内（必須）

| # | タスク | 内容 | 参照 |
|---|--------|------|------|
| B1 | **初回オープン案内の明記** | 「インストール後（または初回利用前）に、必ず1回は管理画面でアプリを開く」ことを利用手順・オンボーディングに記載。POS・Webhook の API が動くために必要。 | REQUIREMENTS_FINAL.md「本番リリース時の2つの課題」、RELEASE セクション5 |

**Phase B の分解（やること一覧）**

| 番号 | やること | 詳細 |
|------|----------|------|
| **B-1** | **案内文言を決める** | 例：「インストール後、はじめて POS や在庫連携を使う前に、**必ず1回は Shopify 管理画面でこのアプリを開いてください**。これにより POS からの登録や在庫履歴が正しく動作します。」短くするなら「インストール後、必ず1回は管理画面でアプリを開いてから POS をご利用ください。」でも可。 |
| **B-2** | **リスティングに書く** | パートナーダッシュボードの「配布」→「リスティング」で、**アプリの詳細**や**はじめに / 利用の流れ**などに上記の一文を入れる。審査・利用者の両方が読める場所。 |
| **B-3** | **アプリ内に表示する** | **省略可**。案内を見る時点で既に管理画面でアプリを開いているため、「1回開いてください」の案内としては冗長。未実施でよい。 |
| **B-4** | **サポート用に控えておく** | 問い合わせ時に「まず管理画面でアプリを1回開いてください」と案内できるよう、文言を社内メモやヘルプに控えておく（任意）。 |

**Phase B 完了の目安**: 案内文言を決め（B-1）、**リスティングに記載**（B-2）すれば Phase B は完了。B-3（アプリ内表示）は不要。

---

#### B-1・B-2 文案と記載案（コピー用）

**B-1：案内文言（採用：理由つき）**

| 採用 | 文言 |
|------|------|
| ✅ **理由つき** | POS や在庫履歴を正しく動かすため、**インストール後に1回だけ、Shopify 管理画面でこのアプリを開いてから**ご利用ください。 |

※ 他の候補（短い・標準）は省略。英語リスティング用は下記「英語用」を参照。

**B-2：パートナーで「アプリの詳細」を編集する場所と手順（最新）**

※ 日本語表示では「配布」「提出を管理」、英語表示では **Distribution** / **Manage Submission** などと表示されます。

| 順番 | 操作 | 補足 |
|------|------|------|
| 1 | [パートナーダッシュボード](https://partners.shopify.com/) にログインする | https://partners.shopify.com/ |
| 2 | 左メニューから **「Apps」**（アプリ）をクリックし、**編集したい公開アプリの名前**（例: POS Stock）をクリックする | そのアプリの概要画面へ |
| 3 | 左サイドバーで **「配布」(Distribution)** をクリックする | 「Shopify App Storeのリスト」などの説明が表示される画面になる |
| 4 | 画面上部の **「提出を管理」(Manage Submission)** の青いボタンをクリックする | 審査提出・リスティング編集の画面へ進む |
| 4a | **「Shopify App Storeへの登録」画面が出た場合**：個人／組織・関連アカウントを選択し、パートナープログラム契約への同意にチェックを入れる。**ワンタイム登録料 $19** の「決済方法を追加」で支払い方法を登録し、登録を完了する。 | 初回のみ表示される登録ステップ。完了しないとその先のリスティング編集・審査提出に進めない。 |
| 5 | 登録完了後（または登録済みの場合はそのまま）、表示された画面（提出フロー／リスティング編集）で **「App details」**（アプリの詳細）の欄を探す | 500文字以内の詳細説明を入力するフィールド |
| 6 | その**冒頭**に、下記「冒頭に追加するブロック例」の文を貼り付けて保存する | 既存文がある場合は、その上に追加する |

**「App Storeの審査」画面（予備ステップ）でやること**

登録後に「提出を管理」をクリックすると **「App Storeの審査」** 画面になり、**予備ステップ**が並びます。下記の順で完了すると「審査用に提出」ボタンが有効になり、その前に**リスティング（主な言語選択後）**で「App details」を編集できます。

| 順番 | 予備ステップ | やること |
|------|--------------|----------|
| 1 | **主な言語を選択** | 「選択」ボタンをクリックし、リスティングの**主な言語**（日本語 または English）を1つ選ぶ。これをしないと自動チェックや「アプリの機能を選択」が使えない。 |
| 2 | **アカウントに緊急連絡先を追加** | 「設定で修正」をクリックし、**メールアドレス**と**電話番号**を登録する。審査時の連絡用。 |
| 3 | **保護された顧客データ** | このアプリが顧客の保護データ（例: 注文の個人情報を保存・分析）を使わない場合は、**「私のアプリは顧客データを使用しません」** にチェックを入れる。使う場合は「リクエスト」から申請。 |
| 4 | **リスティングを作成・編集** | 主な言語を選んだあと、画面内の **「リスティング」** または **「Create listing」／「Manage listing」** に進み、**App details**（アプリの詳細）など必要な項目を入力する。ここに B-2 の「ご利用前に」の文を冒頭に書く。 |
| 5 | **一般的なエラーの自動チェック** | 「実行」ボタンをクリックし、認証・Webhook・TLS などのチェックを実行する。失敗した項目があれば修正してから再実行。 |
| 6 | **アプリの機能を選択**（任意） | 「選択」で、該当する機能（例: POS、在庫など）を選ぶと、審査要件が表示される。主な言語選択後に可能。 |
| 7 | 上記がすべて完了すると **「審査用に提出」** が押せるようになる | Phase D（アイコン・スクショ・紹介文など）も用意できていれば、ここで提出。 |

**ポイント**: まず **1. 主な言語を選択** を完了すると、リスティングの作成・編集と自動チェックの「実行」ができるようになります。そのあと 2・3 を済ませ、4 で App details に B-2 の文を書き、5 で自動チェックを実行してください。

**補足**: 配布ページでは「提出を管理」がリスティング・審査関連の入口です。「Create listing」／「Manage listing」は、提出管理画面のなかや別タブで案内される場合があります。多言語リスティングは提出管理画面内の **「Add translated listing」**（翻訳リスティングを追加）で追加できます。

**参照**: [App listing visibility](https://shopify.dev/docs/apps/launch/distribution/visibility) / [Submit your app for review](https://shopify.dev/docs/apps/launch/app-store-review/submit-app-for-review)（公式）。

**「アプリの詳細」冒頭に追加するブロック例（コピー用・理由つき）**

下記をそのまま、アプリの詳細の**いちばん上**に貼り付けてから、続けて既存の機能説明を書けばよい。

```
【ご利用前に】
POS や在庫履歴を正しく動かすため、インストール後に1回だけ、Shopify 管理画面でこのアプリを開いてからご利用ください。

【POSでできること】
（以下、既存の紹介文を続ける）
```

**英語リスティング用の一文（必要なら・理由つき）**

```
For POS and inventory history to work correctly, please open this app once in your Shopify admin after installation, then start using it.
```

---

#### リスティング用：紹介文・詳細・特徴（コピー用）

**アプリ紹介（100文字以内）**

ご希望のイメージをベースにした案です。改行なしで1行にすると**約76文字**（100文字以内）です。

```
POSアプリで在庫処理を簡単登録。入庫・出庫・棚卸・ロス・仕入・発注まで拡張。管理画面で在庫高・変動履歴まで一括管理して全ての履歴をCSV出力可能。
```

※ ストアの紹介文フィールドには**改行せず1行**で貼り付けてください。このままで問題ありません。

---

**アプリの詳細（500文字以内）**

【ご利用前に】の一文＋機能説明をまとめた案です。**約495文字**です。

```
【ご利用前に】
POSや在庫履歴を正しく動かすため、インストール後に1回だけ、Shopify管理画面でこのアプリを開いてからご利用ください。

【POSでできること】
・出庫：出庫元・宛先を選び、スキャンや検索で明細登録。配送情報（業者・追跡番号・到着予定日）も入力可能。
・入庫：入庫予定一覧から選択またはShipment IDで読み込み。スキャンで照合し数量を入力して入庫確定。
・ロス：ロケーション・日付・理由を選び商品リストでロス登録。
・棚卸：商品グループ（コレクション・SKU・CSV）で棚卸IDを作成。POSでカウントし管理画面で結果確認。
・仕入・発注：仕入先を選び商品リストで仕入・発注登録。履歴は管理画面でCSV出力。

【管理画面でできること】
・在庫高・在庫変動履歴の表示。入出庫・ロス・棚卸・仕入・発注の履歴一覧とフィルター・CSV出力。
・ロケーション・アプリ表示件数などの設定。複数ロケーション・複数配送（シップメント）対応。
```

---

**特徴（80文字以内×3つ）**

審査用の「特徴」欄にそのまま使える案です。各80文字以内です。

| # | 特徴（1つ目） | 文字数目安 |
|---|----------------|------------|
| 1 | POSで出庫・入庫・棚卸・ロス・仕入・発注を登録。スキャンや検索で素早く明細入力。 | 約40文字 |
| 2 | 管理画面で在庫高・変動履歴を表示。全履歴をフィルター・ページネーション・CSV出力で確認。 | 約42文字 |
| 3 | 複数ロケーション・複数配送対応。配送業者・追跡番号・到着予定日をPOSから登録可能。 | 約40文字 |

**コピー用（1行ずつ）**

```
POSで出庫・入庫・棚卸・ロス・仕入・発注を登録。スキャンや検索で素早く明細入力。
管理画面で在庫高・変動履歴を表示。全履歴をフィルター・ページネーション・CSV出力で確認。
複数ロケーション・複数配送対応。配送業者・追跡番号・到着予定日をPOSから登録可能。
```

---

### Phase C：Cron（推奨）

| # | タスク | 内容 | 参照 |
|---|--------|------|------|
| C1 | **在庫高の日次スナップショット用 Cron** | `/api/inventory-snapshot-daily` を毎日（例: 23:59）呼ぶ Cron を設定。環境変数 `INVENTORY_SNAPSHOT_API_KEY` を設定。未設定時は「管理画面を開いたときのフォールバック」のみで前日分が保存される。 | docs/CRON_JOB_SETUP_GUIDE.md |

### Phase D：リスティング・アセット（審査提出前に必須）

| # | タスク | 内容 | 参照 |
|---|--------|------|------|
| D1 | **リスティング用アセットの準備** | アイコン（1200×1200）、フィーチャー画像（1600×900）、スクリーンショット 3〜6 枚、紹介文・詳細文、プライバシーポリシー URL。 | docs/LISTING_ASSETS_GUIDE.md、RELEASE セクション3 |
| D2 | **パートナーでのリスティング入力** | デモ動画・テスト用認証情報・緊急連絡先など審査用項目の登録。価格は「Free to install」でも可。 | RELEASE_REQUIREMENTS_PUBLIC_APP.md Phase B |
| D3 | **デモ用開発ストアの準備** | 審査で「触れる環境」を求められることが多いため、公開アプリをインストールした開発ストアを1つ用意し、URL と「どこを開くか」の説明を用意。 | docs/LISTING_ASSETS_GUIDE.md |

### Phase E：審査提出（必須）

| # | タスク | 内容 | 参照 |
|---|--------|------|------|
| E1 | **App Store 審査に提出** | 上記を満たしたうえで提出。提出後は Shopify の審査待ち（数日〜1週間程度）。 | RELEASE セクション6 Phase C |
| E2 | **審査結果の確認・再提出** | 指摘があれば修正して再提出。メール（app-submissions@shopify.com 等）で連絡が来る。 | 同上 Phase D |

---

## 3. 任意タスク（審査通過前後でよいもの）

| # | タスク | 備考 |
|---|--------|------|
| - | 履歴タブの CSV 案内文言の見直し | REQUIREMENTS_FINAL「任意で残っているもの」 |
| - | 一覧での CSV まとめてダウンロード | 入出庫履歴の一括 CSV は未実装のまま進行可 |

---

## 4. 将来実装：プラン別機能制御（Lite/Pro・課金）

**設計**: `docs/PUBLIC_APP_PLAN_FEATURES_DESIGN.md` に記載済み。

- **内容**: 環境変数 `APP_DISTRIBUTION`（inhouse / public）、Billing API でプラン取得、`GET /api/shop-plan`、管理画面ナビ・ルート保護、POS タイルの Pro 専用制御（仕入・ロス・発注・棚卸は Pro のみ）など。
- **現状**: 上記は**未実装**。コードベースには `APP_DISTRIBUTION` や `api/shop-plan` は存在しません。
- **審査との関係**: まずは「Free to install」で審査提出し、通過後にプラン制御・課金を実装してから Managed Pricing に切り替える進め方も可能です。課金する場合は「プラン変更をアプリ内で行えること」が Store 要件になります。

審査を先に進める場合は、**Phase A〜E のみ**で提出し、プラン制御は審査通過後のタスクとして整理できます。

---

## 5. チェックリスト（コピー用）

```
Phase A: 環境・デプロイ
[ ] A1 本番用永続DB（PostgreSQL）用意・DATABASE_URL・Prisma 本番用・マイグレーション
[ ] A2 公開アプリ用環境（パートナー作成・Client ID/Secret・デプロイ先・toml 設定）
[ ] A3 shopify app config use public → deploy、インストール〜動作確認

Phase B: 運用
[ ] B1 利用手順に「初回は1回だけ管理画面でアプリを開く」を明記

Phase C: Cron（推奨）
[ ] C1 /api/inventory-snapshot-daily の Cron 設定・INVENTORY_SNAPSHOT_API_KEY

Phase D: リスティング
[ ] D1 アイコン・フィーチャー画像・スクショ・紹介文・詳細文・プライバシーポリシーURL
[ ] D2 パートナーでリスティング入力・デモ動画・テスト認証・緊急連絡先
[ ] D3 デモ用開発ストアURL・説明

Phase E: 審査
[ ] E1 App Store 審査に提出
[ ] E2 審査結果確認・指摘あれば修正して再提出
```

---

## 6. 参照ドキュメント一覧

| ドキュメント | 用途 |
|--------------|------|
| **REQUIREMENTS_FINAL.md** | 要件サマリー・「公開アプリ完了までにあと何が必要か」・本番2課題 |
| **RELEASE_REQUIREMENTS_PUBLIC_APP.md** | 公開アプリリリースの手順・チェックリスト・本番必須対策 |
| **docs/LISTING_ASSETS_GUIDE.md** | リスティング用アセット・文案・プライバシーポリシー・デモストア |
| **docs/CRON_JOB_SETUP_GUIDE.md** | 在庫高日次スナップショット用 Cron の設定方法 |
| **docs/PUBLIC_APP_PLAN_FEATURES_DESIGN.md** | プラン別機能制御（Lite/Pro）の設計（未実装） |
| **docs/TASKS_RENDER_POSTGRES_AND_FUTURE_SUPABASE.md** | Render PostgreSQL 導入・将来 Supabase 移行のタスク |

---

**まとめ**: コードはリリース可能です。あとは **①本番DB ②初回オープン案内 ③Cron（推奨）** の運用と、**④公開用環境 ⑤リスティング ⑥審査提出** をこの順で進めると、審査〜公開まで進められます。プラン別制御（Lite/Pro）は設計のみで、審査通過後に実装する形でも問題ありません。
