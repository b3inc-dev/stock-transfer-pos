# 外部DB前提の全体設計（在庫変動履歴・永続化・将来拡張）

**作成日**: 2026年2月8日  
**目的**: 本番で「デプロイで履歴が消えない」「管理画面を開かなくても情報取得が可能」を満たすため、**外部DB（PostgreSQL）を前提にした全体設計**に組み直す。あわせて、在庫変動履歴以外で外部DBに寄せた方がスムーズになるデータを洗い出し、全体要件を見直す。

---

## 1. 現状のデータ保存の整理

現在、データは次のように分散しています。

| データの種類 | 保存先 | 備考 |
|--------------|--------|------|
| **セッション（OAuth）** | Prisma（SQLite / 本番では PostgreSQL 必須） | `Session` モデル。オフライン/オンラインアクセストークン。本番で SQLite はエフェメラルなため永続DB必須。 |
| **在庫変動履歴** | Prisma（同上） | `InventoryChangeLog` モデル。本番で永続DB必須。 |
| **店舗設定（settings_v1）** | Shopify Metafield | `currentAppInstallation.metafield`（namespace: `stock_transfer_pos`, key: `settings_v1`）。配送業者・ロス理由・仕入先・表示件数など。 |
| **在庫高の日次スナップショット** | Shopify Metafield | `shop.metafield`（namespace: `inventory_info`, key: `daily_snapshots`）。合計小売価値・原価をロケーション別・日付別に保存。**Metafield は 1 値あたり 250KB 制限**。 |
| **ロス登録履歴** | Shopify Metafield | `currentAppInstallation.metafield`（namespace: ロス用, key: `loss_entries_v1`）。JSON 配列。件数が増えると 250KB を超えるリスク。 |
| **棚卸：商品グループ** | Shopify Metafield | key: `product_groups_v1`。グループ名＋SKU/コレクション等。グループ数・SKU数が増えると肥大化。 |
| **棚卸：棚卸ID一覧** | Shopify Metafield | key: `inventory_counts_v1`。棚卸ID・グループ・状態等。同上。 |
| **仕入履歴** | Shopify Metafield | key: `purchase_entries_v1`。仕入単位のJSON。増加すると 250KB リスク。 |
| **発注履歴** | Shopify Metafield | key: `order_entries_v1`（等）。発注単位のJSON。同上。 |

**結論（現状）**

- **Prisma で持っているもの**: Session、InventoryChangeLog の 2 種類のみ。本番では PostgreSQL が必須。
- **Metafield で持っているもの**: 設定・日次スナップ・ロス/棚卸/仕入/発注の各種「アプリ専用データ」。いずれも **Metafield の 250KB/値 の制限** と、**検索・ページネーション・集計のしづらさ** の影響を受ける。

---

## 2. 外部DBに寄せた方がスムーズになるデータの洗い出し

在庫変動履歴以外で、**外部DB（PostgreSQL）に移すとメリットが大きい**ものを整理します。

| データ | 現状の課題 | 外部DBに移すメリット | 優先度 |
|--------|------------|----------------------|--------|
| **セッション** | すでに Prisma。本番で SQLite が消える。 | 永続DBに統一すればデプロイ後も維持。 | 必須（現状のままDB） |
| **在庫変動履歴** | 同上。 | 同上。 | 必須（現状のままDB） |
| **在庫高の日次スナップショット** | 250KB 制限。日付×ロケーションが増えるとあふれる。日付範囲検索が Metafield では重い。 | 容量制限なし。日付・ショップ・ロケーションでインデックスし、期間検索が容易。 | **高** |
| **ロス登録履歴** | JSON 1 本で全件保持。件数増で 250KB 超過・読み書きが重い。ページネーションはメモリ上で実施。 | 1 件 1 行で保存。ページネーション・フィルター・CSV 出力が DB ネイティブで可能。 | **高** |
| **棚卸：商品グループ** | 同上。グループ数・SKU 数が増えると Metafield が肥大化。 | グループテーブル＋SKU/コレクションの正規化で検索・編集が容易。 | **高** |
| **棚卸：棚卸ID一覧** | 同上。棚卸IDが増えると肥大化。 | 棚卸ID単位で行にし、状態・日付で検索しやすい。 | **高** |
| **仕入履歴** | 同上。仕入件数増で 250KB リスク。 | 1 仕入 1 行（＋明細は別テーブル or JSONB）。期間・ステータスで検索。 | **高** |
| **発注履歴** | 同上。 | 同上。 | **高** |
| **店舗設定（settings_v1）** | 比較的小さい。Metafield のままでも運用可能。 | 一元化の観点で DB に寄せると、Session・履歴と同一 DB で管理でき、バックアップ・復元が揃う。 | **中**（任意） |

**まとめ**

- **必須で外部DBに置くもの（現状すでに Prisma）**: セッション、在庫変動履歴。
- **移行するとスムーズになるもの（推奨）**: 日次スナップショット、ロス履歴、棚卸（商品グループ・棚卸ID）、仕入履歴、発注履歴。いずれも **容量制限の回避** と **検索・ページネーション・集計のしやすさ** が目的。
- **任意**: 店舗設定（DB に寄せると一元管理しやすいが、Metafield のままでも可）。

---

## 3. 外部DB前提の全体設計（データ配置方針）

### 3.1 基本方針

- **本番環境**: データの永続化は **外部の PostgreSQL 1 本** に集約する（Render のディスクはエフェメラルなため、SQLite は使わない）。
- **開発環境**: 同じ PostgreSQL を使う（例: ローカル Docker または Supabase の無料DB）か、従来どおり SQLite のまま開発し、本番のみ PostgreSQL にするかは運用で選択（Prisma は 1 schema で 1 provider のため、本番のみ PostgreSQL にする場合は schema の切り替えが必要）。
- **Shopify に残すもの**: 入出庫の「実体」は Shopify の Transfer / Shipment / Order 等の API が正とする。アプリは「履歴の参照・在庫変動ログ・設定・ロス/棚卸/仕入/発注のアプリ専用データ」を外部DBに持つ。

### 3.2 外部DBに置くデータ（推奨構成）

| 論理データ | テーブル（案） | 説明 |
|------------|----------------|------|
| セッション | `Session` | 現行の Prisma Session のまま。OAuth トークン保存。 |
| 在庫変動履歴 | `InventoryChangeLog` | 現行のまま。 |
| 在庫高の日次スナップショット | `InventoryDailySnapshot`（新規） | ショップ・日付・ロケーション・合計小売価値・合計原価など。日付範囲検索用インデックス。 |
| ロス登録履歴 | `LossEntry`（新規） | 1 件 1 行。ショップ・ロケーション・日付・理由・明細（JSONB または明細テーブル）。 |
| 棚卸：商品グループ | `ProductGroup` / `ProductGroupSku`（新規） | グループ名・作成方法（collection/sku/csv）。SKU は別テーブルまたは JSONB。 |
| 棚卸：棚卸ID一覧 | `InventoryCount`（新規） | 棚卸ID・ショップ・商品グループ参照・状態・作成日・完了日など。 |
| 仕入履歴 | `PurchaseEntry`（新規） | 仕入ID・ショップ・ロケーション・仕入先・ステータス・明細（JSONB または別テーブル）。 |
| 発注履歴 | `OrderEntry`（新規） | 発注ID・ショップ・ロケーション・仕入先・ステータス・明細。 |
| 店舗設定（任意） | `AppSettings`（新規） | ショップ単位で 1 行。JSONB で settings_v1 相当を保存。Metafield と二重管理を避けるなら Metafield 書き込みは廃止。 |

上記は「すべてを一度に移行する」必要はありません。**Phase 1: Session ＋ InventoryChangeLog を PostgreSQL で永続化**（現状のスキーマのまま本番だけ PostgreSQL）→ **Phase 2: 日次スナップ・ロス・棚卸・仕入・発注を順次 DB に移行** という段階的移行が現実的です。

### 3.3 Metafield に残すかどうか

- **外部DBに移行したデータ**: 該当する Metafield は「読まない」ようにし、新規書き込みもやめる。移行後は DB のみを正とする。
- **店舗設定を DB に移さない場合**: 従来どおり `settings_v1` は Metafield のまま。DB に移す場合は、設定の読み書きを Prisma 経由に切り替え、Metafield への設定保存は廃止（または DB を正とし Metafield はキャッシュ扱いにするかは要件次第）。

### 3.4 入出庫履歴について

- **入出庫の実データ**（Transfer / Shipment / 明細）は **Shopify Admin API が正**。アプリは「一覧取得・詳細取得・CSV 出力」を API から行う現状のまま。
- **在庫変動の「ログ」** だけが `InventoryChangeLog` として外部DBに保存される。この設計は現状のままでよい。

---

## 4. おすすめのDB

全体設計を**外部DB前提**で組み直す場合、**PostgreSQL を 1 本用意する**形になります。候補は次の 2 つです。

| 選択肢 | 概要 |
|--------|------|
| **A. Render PostgreSQL** | Render の「Add-ons」で PostgreSQL を追加し、発行される `DATABASE_URL` を環境変数に設定する。 |
| **B. Supabase（PostgreSQL）** | Supabase で PostgreSQL プロジェクトを作成し、接続URLを `DATABASE_URL` で渡す。 |

### 4.1 推奨: **Supabase（PostgreSQL）**

全体設計を外部DB前提で見直し、**今後もデータを増やしていく**前提なら、**Supabase を推奨**します。

**理由（簡潔）**

1. **プロジェクト方針との一致**  
   `.cursorrules` に「本番環境予定：Supabase（PostgreSQL）」とある。自社基幹との連携も想定されているため、同じ PostgreSQL（Supabase）にしておくと、のちに基幹側から参照・連携しやすい。

2. **データの増加・多様化に対応しやすい**  
   日次スナップ・ロス・棚卸・仕入・発注などをテーブルとして追加していく設計にすると、データ量とテーブル数が増える。Supabase は PostgreSQL をそのまま使えるため、Prisma のマイグレーションでテーブルを追加するだけでよく、**Render の Add-on の枠に縛られない**。

3. **開発・本番の環境分離がしやすい**  
   無料枠で「開発用プロジェクト」と「本番用プロジェクト」を分けやすい。`DATABASE_URL` を切り替えるだけで、開発と本番で DB を分離できる。

4. **バックアップ・運用の選択肢**  
   Supabase はバックアップ・リストアのオプションがあり、DB だけスケールや運用方針を変えやすい。Render はアプリ用、Supabase は DB 用と役割を分ける構成にしやすい。

5. **将来の拡張**  
   自社基幹との「リアルタイム同期」や「Supabase の REST/Realtime を利用した連携」を検討する場合、すでに Supabase に寄せておくと拡張がスムーズ。

**こんな場合に Render PostgreSQL を選ぶとよい**

- **「Render だけで完結させたい」**（登録サービスを増やしたくない）
- **データ量・テーブル数はあまり増やさない**（Session ＋ 在庫変動履歴のみで十分な場合）

その場合は、Render PostgreSQL Add-on で `DATABASE_URL` を設定し、現行の Prisma スキーマ（Session ＋ InventoryChangeLog）のまま本番を PostgreSQL にする形で十分です。

### 4.2 まとめ（DB選定）

| 観点 | Supabase | Render PostgreSQL |
|------|----------|--------------------|
| 本番・開発で DB を分離 | ◎ 無料枠で別プロジェクト化しやすい | △ 別サービスを用意する必要あり |
| データ・テーブルを増やしていく設計 | ◎ そのまま拡張しやすい | ○ 可能だが Add-on の制約内 |
| 自社基幹・他システムとの連携 | ◎ 同一 Supabase や API で連携しやすい | △ 主に接続URLのみ |
| Render のみで完結 | △ 別サービス利用 | ◎ Add-on で完結 |
| 運用・バックアップ | ◎ ダッシュボード・オプションあり | ○ Render の範囲内 |

### 4.3 金額感を含めた再検討（2026-02）

料金は公式の最新情報で必ず確認してください。以下は目安です。

#### Supabase の料金目安

| プラン | 月額（USD） | 備考 |
|--------|-------------|------|
| **Free** | $0 | DB 500MB、5GB egress。**1週間アクセスがないとプロジェクトが一時停止（Pause）**。本番には不向き。 |
| **Pro** | **$25**〜 | DB 8GB 含む、7日間バックアップ、一時停止なし。コンピュート $10 クレジット込み。 |

- 本番で「止まらない」DB を使うなら **Pro（$25/月）** が現実的。Free は開発・検証用。

#### Render PostgreSQL の料金目安

| プラン | 月額（USD） | 備考 |
|--------|-------------|------|
| **Free** | $0 | **有効期限 30 日のみ**。本番用途には不可。 |
| **Basic-256mb** | **$6** | 256MB RAM。小規模な Session ＋ 在庫変動履歴なら十分なことが多い。 |
| **Basic-1gb** | $19 | 1GB RAM。接続数・データ量が増えた場合。 |
| **Basic-4gb** | $75 | 4GB RAM。 |
| ストレージ（有料プラン） | $0.30/GB/月 | 基本料金に加算。 |

- アプリ本体をすでに Render で動かしている場合、**Add-on で PostgreSQL を足すだけ**でよく、**月額 $6〜（Basic-256mb）** から本番運用が可能。

#### 比較と選び方（金額感を踏まえて）

| シナリオ | おすすめ | 理由（金額感） |
|----------|----------|----------------|
| **とにかくコストを抑えたい（Session ＋ 在庫変動履歴だけ永続化）** | **Render PostgreSQL** | 月 **$6**（Basic-256mb）から本番可能。Supabase の本番向けは Pro **$25** のため、**約 $19/月 安い**。 |
| **開発用は無料・本番は有料で分けたい** | **Supabase** | 開発＝Free（$0、停止に注意）、本番＝Pro（$25）。Render は DB の無料枠が 30 日限定のため「ずっと無料の開発DB」は Render では難しい。 |
| **将来ロス・棚卸・仕入・発注も DB に寄せ、基幹連携も視野** | **Supabase** | テーブル増設・API・ダッシュボードが揃い、$25 で 8GB まで使える。拡張時の追加コストがわかりやすい。 |
| **Render だけで構成をまとめたい** | **Render PostgreSQL** | アプリと DB が同じ Render 内にあり、請求・管理が 1 か所で済む。$6〜で始められる。 |

**注意**

- **Supabase Free を本番で使うのは非推奨**です。1 週間アクセスがないとプロジェクトが一時停止し、POS や Webhook が動かなくなる可能性があります。
- Render の **Postgres Free** は **30 日限定**のため、本番の恒久運用には Basic 以上の有料プランが必要です。

**結論（金額感を踏まえた推奨）**

- **月額コストをできるだけ抑えたい**（まずは履歴が消えないようにするだけ）→ **Render PostgreSQL Basic-256mb（$6/月）** を推奨。
- **開発用 DB を無料で持ちつつ、本番は止まらない DB にしたい**、または **将来データを増やしつつ基幹連携も検討したい** → **Supabase Pro（$25/月）** を推奨。  
  - .cursorrules の「本番環境予定：Supabase」に沿う場合は、こちらの選択でよい。
- 両方とも「どちらか一方」で足りるため、**予算と「Render に寄せるか / Supabase に寄せるか」の好み**で選ぶ形でよいです。

---

## 5. 移行の進め方（Phase イメージ）

1. **Phase 0（直近）**  
   - 本番で **PostgreSQL を 1 本用意**（**コスト重視なら Render PostgreSQL $6/月〜**、開発分離・将来拡張重視なら **Supabase Pro $25/月**。詳細は 4.3 節参照）。  
   - **Session と InventoryChangeLog だけ** をその PostgreSQL に保存するようにする（Prisma の datasource を `DATABASE_URL` の PostgreSQL に変更し、マイグレーション実施）。  
   - これで「デプロイで履歴が消えない」と「セッションが消えない」を満たす。

2. **Phase 1（次のステップ）**  
   - 在庫高の**日次スナップショット**を Metafield から DB の新規テーブル（例: `InventoryDailySnapshot`）に移行。  
   - 書き込み・読み込みを Prisma 経由に切り替え、Metafield の該当キーは使わないようにする。

3. **Phase 2 以降**  
   - **ロス履歴** → **棚卸（商品グループ・棚卸ID）** → **仕入履歴** → **発注履歴** の順で、Metafield から DB へ移行。  
   - 各機能ごとに「Metafield 読み込み」と「DB 読み込み」の切り替え（または DB 優先で Metafield はフォールバック）を実装し、データ移行スクリプトで既存 Metafield を DB に投入。

4. **店舗設定**  
   - DB に移すかは任意。移す場合は `AppSettings` テーブルを追加し、設定画面の読み書きを Prisma に切り替える。

---

## 6. 参照ドキュメント

- **本番で必須の2つの対策（永続DB・初回管理画面オープン）**: `RELEASE_REQUIREMENTS_PUBLIC_APP.md` セクション 5  
- **要件書のデータベース設計**: `REQUIREMENTS_FINAL.md` セクション 4  
- **プロジェクト方針（本番環境・Supabase）**: `.cursorrules`  
- **料金の最新確認**: [Supabase Pricing](https://supabase.com/pricing) / [Render Pricing](https://render.com/pricing)（本ドキュメントの金額は目安です）

---

**以上が、外部DB使用前提で組み直した全体設計と、おすすめのDB（Supabase）の整理です。** 実装の細部（テーブル定義・マイグレーション名・Metafield 廃止タイミング）は、Phase ごとに要件と相談しながら決めるとよいです。
